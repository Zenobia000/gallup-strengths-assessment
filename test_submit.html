<!DOCTYPE html>
<html>
<head>
    <title>Test Submit - Debug Tool</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        button:hover { background: #e0e0e0; }
        #output {
            margin-top: 20px;
            padding: 15px;
            background: #f0f0f0;
            white-space: pre-wrap;
            border: 1px solid #ccc;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Test Submit - Debug Tool</h1>

    <button onclick="clearAndTest()">清除並測試完整流程</button>
    <button onclick="testCurrentSession()">測試當前 Session</button>
    <button onclick="clearStorage()">清除 Storage</button>
    <button onclick="showStorage()">顯示 Storage</button>

    <div id="output"></div>

    <script type="module">
        import { storage } from '/js/storage.js';
        import { api, APIError } from '/js/api.js';

        const output = document.getElementById('output');

        function log(message, isError = false) {
            const span = document.createElement('span');
            span.textContent = message + '\n';
            span.className = isError ? 'error' : '';
            output.appendChild(span);
            output.scrollTop = output.scrollHeight;
        }

        window.clearStorage = function() {
            localStorage.clear();
            output.innerHTML = '';
            log('✅ Storage 已清除');
        };

        window.showStorage = function() {
            output.innerHTML = '';
            const data = storage.getAllData();
            log('📦 Current Storage:');
            log(JSON.stringify(data, null, 2));
        };

        window.testCurrentSession = async function() {
            output.innerHTML = '';
            const sessionId = storage.getSession();

            if (!sessionId) {
                log('❌ 沒有找到 session', true);
                return;
            }

            log(`📝 當前 Session: ${sessionId}`);

            // Generate test answers
            const answers = [];
            for (let i = 1; i <= 20; i++) {
                answers.push({
                    question_id: i,
                    score: ((i % 5) + 1)
                });
            }

            log(`📤 提交 ${answers.length} 個答案...`);

            try {
                const result = await api.submitAllAnswers(sessionId, answers);
                log('✅ 提交成功！', false);
                log(JSON.stringify(result, null, 2));
            } catch (error) {
                log(`❌ 提交失敗: ${error.message}`, true);
                if (error instanceof APIError) {
                    log(`Status: ${error.statusCode}`, true);
                    log(`Data: ${JSON.stringify(error.data)}`, true);
                }
            }
        };

        window.clearAndTest = async function() {
            output.innerHTML = '';
            log('🧹 清除舊資料...');
            localStorage.clear();

            try {
                // Step 1: Submit consent
                log('\n1️⃣ 提交同意書...');
                const consentResp = await api.submitConsent({
                    agreed: true,
                    user_agent: navigator.userAgent,
                    consent_version: 'v1.0'
                });
                log(`✅ Consent ID: ${consentResp.data.consent_id}`);

                // Step 2: Create session
                log('\n2️⃣ 建立 Session...');
                const sessionResp = await api.post('/sessions/start', {
                    consent_id: consentResp.data.consent_id,
                    instrument: 'mini_ipip_v1.0'
                });
                log(`✅ Session ID: ${sessionResp.data.session_id}`);

                // Save to storage
                storage.saveSession(sessionResp.data.session_id);
                storage.saveConsent(true);

                // Step 3: Get questions (optional, just to verify)
                log('\n3️⃣ 取得問題...');
                const questionsResp = await api.getQuestions();
                log(`✅ 取得 ${questionsResp.questions.length} 個問題`);

                // Step 4: Generate and submit answers
                log('\n4️⃣ 產生並提交答案...');
                const answers = [];
                for (let i = 1; i <= 20; i++) {
                    answers.push({
                        question_id: i,
                        score: ((i % 5) + 1)
                    });
                }

                log(`📤 提交 ${answers.length} 個答案到 ${sessionResp.data.session_id}...`);

                const submitResp = await api.submitAllAnswers(sessionResp.data.session_id, answers);
                log('✅ 提交成功！');
                log('\n📊 結果:');
                log(JSON.stringify(submitResp, null, 2));

                // Step 5: Test results endpoint
                log('\n5️⃣ 測試結果端點...');
                try {
                    const resultsResp = await api.getResults(sessionResp.data.session_id);
                    log('✅ 結果取得成功！');
                    log(JSON.stringify(resultsResp, null, 2));
                } catch (error) {
                    log('ℹ️ 結果端點返回模擬資料 (正常)');
                }

                log('\n🎉 完整測試成功！');
                log(`\n💡 現在您可以前往 http://localhost:3000/pages/assessment.html 測試 UI`);

            } catch (error) {
                log(`\n❌ 錯誤: ${error.message}`, true);
                if (error instanceof APIError) {
                    log(`Status: ${error.statusCode}`, true);
                    log(`Details: ${JSON.stringify(error.data, null, 2)}`, true);
                }
                console.error('Full error:', error);
            }
        };

        // Auto-show storage on load
        window.addEventListener('DOMContentLoaded', () => {
            showStorage();
        });
    </script>
</body>
</html>
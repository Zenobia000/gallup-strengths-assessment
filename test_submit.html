<!DOCTYPE html>
<html>
<head>
    <title>Test Submit - Debug Tool</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        button:hover { background: #e0e0e0; }
        #output {
            margin-top: 20px;
            padding: 15px;
            background: #f0f0f0;
            white-space: pre-wrap;
            border: 1px solid #ccc;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Test Submit - Debug Tool</h1>

    <button onclick="clearAndTest()">æ¸…é™¤ä¸¦æ¸¬è©¦å®Œæ•´æµç¨‹</button>
    <button onclick="testCurrentSession()">æ¸¬è©¦ç•¶å‰ Session</button>
    <button onclick="clearStorage()">æ¸…é™¤ Storage</button>
    <button onclick="showStorage()">é¡¯ç¤º Storage</button>

    <div id="output"></div>

    <script type="module">
        import { storage } from '/js/storage.js';
        import { api, APIError } from '/js/api.js';

        const output = document.getElementById('output');

        function log(message, isError = false) {
            const span = document.createElement('span');
            span.textContent = message + '\n';
            span.className = isError ? 'error' : '';
            output.appendChild(span);
            output.scrollTop = output.scrollHeight;
        }

        window.clearStorage = function() {
            localStorage.clear();
            output.innerHTML = '';
            log('âœ… Storage å·²æ¸…é™¤');
        };

        window.showStorage = function() {
            output.innerHTML = '';
            const data = storage.getAllData();
            log('ğŸ“¦ Current Storage:');
            log(JSON.stringify(data, null, 2));
        };

        window.testCurrentSession = async function() {
            output.innerHTML = '';
            const sessionId = storage.getSession();

            if (!sessionId) {
                log('âŒ æ²’æœ‰æ‰¾åˆ° session', true);
                return;
            }

            log(`ğŸ“ ç•¶å‰ Session: ${sessionId}`);

            // Generate test answers
            const answers = [];
            for (let i = 1; i <= 20; i++) {
                answers.push({
                    question_id: i,
                    score: ((i % 5) + 1)
                });
            }

            log(`ğŸ“¤ æäº¤ ${answers.length} å€‹ç­”æ¡ˆ...`);

            try {
                const result = await api.submitAllAnswers(sessionId, answers);
                log('âœ… æäº¤æˆåŠŸï¼', false);
                log(JSON.stringify(result, null, 2));
            } catch (error) {
                log(`âŒ æäº¤å¤±æ•—: ${error.message}`, true);
                if (error instanceof APIError) {
                    log(`Status: ${error.statusCode}`, true);
                    log(`Data: ${JSON.stringify(error.data)}`, true);
                }
            }
        };

        window.clearAndTest = async function() {
            output.innerHTML = '';
            log('ğŸ§¹ æ¸…é™¤èˆŠè³‡æ–™...');
            localStorage.clear();

            try {
                // Step 1: Submit consent
                log('\n1ï¸âƒ£ æäº¤åŒæ„æ›¸...');
                const consentResp = await api.submitConsent({
                    agreed: true,
                    user_agent: navigator.userAgent,
                    consent_version: 'v1.0'
                });
                log(`âœ… Consent ID: ${consentResp.data.consent_id}`);

                // Step 2: Create session
                log('\n2ï¸âƒ£ å»ºç«‹ Session...');
                const sessionResp = await api.post('/sessions/start', {
                    consent_id: consentResp.data.consent_id,
                    instrument: 'mini_ipip_v1.0'
                });
                log(`âœ… Session ID: ${sessionResp.data.session_id}`);

                // Save to storage
                storage.saveSession(sessionResp.data.session_id);
                storage.saveConsent(true);

                // Step 3: Get questions (optional, just to verify)
                log('\n3ï¸âƒ£ å–å¾—å•é¡Œ...');
                const questionsResp = await api.getQuestions();
                log(`âœ… å–å¾— ${questionsResp.questions.length} å€‹å•é¡Œ`);

                // Step 4: Generate and submit answers
                log('\n4ï¸âƒ£ ç”¢ç”Ÿä¸¦æäº¤ç­”æ¡ˆ...');
                const answers = [];
                for (let i = 1; i <= 20; i++) {
                    answers.push({
                        question_id: i,
                        score: ((i % 5) + 1)
                    });
                }

                log(`ğŸ“¤ æäº¤ ${answers.length} å€‹ç­”æ¡ˆåˆ° ${sessionResp.data.session_id}...`);

                const submitResp = await api.submitAllAnswers(sessionResp.data.session_id, answers);
                log('âœ… æäº¤æˆåŠŸï¼');
                log('\nğŸ“Š çµæœ:');
                log(JSON.stringify(submitResp, null, 2));

                // Step 5: Test results endpoint
                log('\n5ï¸âƒ£ æ¸¬è©¦çµæœç«¯é»...');
                try {
                    const resultsResp = await api.getResults(sessionResp.data.session_id);
                    log('âœ… çµæœå–å¾—æˆåŠŸï¼');
                    log(JSON.stringify(resultsResp, null, 2));
                } catch (error) {
                    log('â„¹ï¸ çµæœç«¯é»è¿”å›æ¨¡æ“¬è³‡æ–™ (æ­£å¸¸)');
                }

                log('\nğŸ‰ å®Œæ•´æ¸¬è©¦æˆåŠŸï¼');
                log(`\nğŸ’¡ ç¾åœ¨æ‚¨å¯ä»¥å‰å¾€ http://localhost:3000/pages/assessment.html æ¸¬è©¦ UI`);

            } catch (error) {
                log(`\nâŒ éŒ¯èª¤: ${error.message}`, true);
                if (error instanceof APIError) {
                    log(`Status: ${error.statusCode}`, true);
                    log(`Details: ${JSON.stringify(error.data, null, 2)}`, true);
                }
                console.error('Full error:', error);
            }
        };

        // Auto-show storage on load
        window.addEventListener('DOMContentLoaded', () => {
            showStorage();
        });
    </script>
</body>
</html>
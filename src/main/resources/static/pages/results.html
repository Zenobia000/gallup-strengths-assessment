<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>您的優勢分析 - Gallup 優勢測驗</title>

  <link rel="stylesheet" href="/css/variables.css">
  <link rel="stylesheet" href="/css/reset.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/animations.css">
  <link rel="stylesheet" href="/css/responsive.css">

  <style>
    .results-page {
      min-height: 100vh;
      background: var(--bg-page);
    }

    .results-header {
      background: linear-gradient(135deg, #4A90E2 0%, #52C41A 100%);
      color: var(--text-inverse);
      padding: var(--spacing-3xl) var(--spacing-md);
      text-align: center;
    }

    .results-header-content {
      max-width: var(--container-md);
      margin: 0 auto;
    }

    .results-title {
      font-size: var(--font-size-4xl);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--spacing-md);
    }

    .results-subtitle {
      font-size: var(--font-size-lg);
      opacity: 0.9;
    }

    .results-main {
      padding: var(--spacing-3xl) var(--spacing-md);
    }

    .results-content {
      max-width: var(--container-lg);
      margin: 0 auto;
    }

    .section {
      margin-bottom: var(--spacing-3xl);
    }

    .section-heading {
      font-size: var(--font-size-2xl);
      font-weight: var(--font-weight-bold);
      color: var(--text-primary);
      margin-bottom: var(--spacing-xl);
      text-align: center;
    }

    .top-strengths {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: var(--spacing-xl);
      margin-bottom: var(--spacing-2xl);
    }

    .strength-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      padding: var(--spacing-2xl);
      text-align: center;
      position: relative;
      overflow: hidden;
      animation: revealStrength 0.5s ease;
      animation-fill-mode: backwards;
    }

    .strength-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: var(--gradient-progress);
    }

    .strength-card:nth-child(1) {
      animation-delay: 0.2s;
    }

    .strength-card:nth-child(2) {
      animation-delay: 0.4s;
    }

    .strength-card:nth-child(3) {
      animation-delay: 0.6s;
    }

    @keyframes revealStrength {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .strength-rank {
      display: inline-block;
      width: 50px;
      height: 50px;
      background: var(--gradient-progress);
      color: var(--text-inverse);
      border-radius: 50%;
      font-size: var(--font-size-2xl);
      font-weight: var(--font-weight-bold);
      line-height: 50px;
      margin-bottom: var(--spacing-md);
    }

    .strength-name {
      font-size: var(--font-size-2xl);
      font-weight: var(--font-weight-bold);
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
    }

    .strength-score {
      font-size: var(--font-size-lg);
      color: var(--text-secondary);
      margin-bottom: var(--spacing-md);
    }

    .strength-description {
      font-size: var(--font-size-base);
      color: var(--text-secondary);
      line-height: var(--line-height-relaxed);
    }

    .all-strengths {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      padding: var(--spacing-xl);
    }

    .strength-item {
      display: flex;
      align-items: center;
      padding: var(--spacing-md);
      border-bottom: 1px solid var(--color-gray-200);
    }

    .strength-item:last-child {
      border-bottom: none;
    }

    .strength-item-rank {
      width: 40px;
      height: 40px;
      background: var(--color-gray-100);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: var(--font-weight-bold);
      color: var(--text-secondary);
      margin-right: var(--spacing-md);
    }

    .strength-item-info {
      flex: 1;
    }

    .strength-item-name {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
      margin-bottom: var(--spacing-xs);
    }

    .strength-item-score {
      font-size: var(--font-size-sm);
      color: var(--text-tertiary);
    }

    .strength-bar {
      width: 200px;
      height: 8px;
      background: var(--color-gray-200);
      border-radius: var(--radius-full);
      overflow: hidden;
      margin-left: var(--spacing-md);
    }

    .strength-bar-fill {
      height: 100%;
      background: var(--gradient-progress);
      border-radius: var(--radius-full);
      transition: width var(--transition-slow) var(--ease-out);
    }

    /* Recommendations Section */
    .recommendations-section {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-3xl);
    }

    .recommendation-tabs {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-xl);
      border-bottom: 2px solid var(--color-gray-200);
    }

    .recommendation-tab {
      padding: var(--spacing-md) var(--spacing-lg);
      background: transparent;
      border: none;
      border-radius: var(--radius-md) var(--radius-md) 0 0;
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-medium);
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition-all);
      border-bottom: 3px solid transparent;
    }

    .recommendation-tab:hover {
      color: var(--text-primary);
      background: var(--bg-hover);
    }

    .recommendation-tab.active {
      color: var(--color-primary);
      border-bottom-color: var(--color-primary);
      background: var(--color-primary-light);
    }

    .recommendation-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .recommendation-content.active {
      display: block;
    }

    .career-recommendations {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: var(--spacing-lg);
    }

    .career-card {
      background: var(--bg-card);
      border: var(--border-width) solid var(--color-gray-200);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      transition: var(--transition-all);
      position: relative;
      overflow: hidden;
    }

    .career-card:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
      border-color: var(--color-primary);
    }

    .career-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-progress);
    }

    .career-title {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-bold);
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .career-chinese-title {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      margin-bottom: var(--spacing-md);
    }

    .match-score {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-xs);
      padding: 4px 12px;
      background: var(--color-secondary-light);
      color: var(--color-secondary-dark);
      border-radius: var(--radius-full);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      margin-bottom: var(--spacing-md);
    }

    .match-score.high {
      background: var(--color-secondary-light);
      color: var(--color-secondary-dark);
    }

    .match-score.medium {
      background: var(--color-accent-light);
      color: var(--color-accent-dark);
    }

    .match-score.low {
      background: var(--color-gray-200);
      color: var(--text-secondary);
    }

    .career-description {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      line-height: var(--line-height-relaxed);
      margin-bottom: var(--spacing-md);
    }

    .career-details {
      margin-top: var(--spacing-md);
    }

    .career-detail-item {
      margin-bottom: var(--spacing-sm);
    }

    .career-detail-label {
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-medium);
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--spacing-xs);
    }

    .career-detail-tags {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-xs);
    }

    .career-tag {
      padding: 2px 8px;
      background: var(--color-primary-light);
      color: var(--color-primary-dark);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-medium);
    }

    .development-plan {
      max-width: 800px;
      margin: 0 auto;
    }

    .development-focus {
      text-align: center;
      padding: var(--spacing-xl);
      background: var(--color-primary-light);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-xl);
    }

    .development-focus h3 {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-bold);
      color: var(--color-primary-dark);
      margin-bottom: var(--spacing-sm);
    }

    .priority-areas {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      justify-content: center;
    }

    .priority-area {
      padding: var(--spacing-sm) var(--spacing-md);
      background: var(--color-primary);
      color: var(--text-inverse);
      border-radius: var(--radius-full);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
    }

    .development-actions {
      display: grid;
      gap: var(--spacing-lg);
    }

    .action-card {
      background: var(--bg-card);
      border: var(--border-width) solid var(--color-gray-200);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      transition: var(--transition-all);
    }

    .action-card:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--color-primary);
    }

    .action-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: var(--spacing-md);
    }

    .action-title {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-bold);
      color: var(--text-primary);
      margin-bottom: var(--spacing-xs);
    }

    .action-chinese-title {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
    }

    .action-priority {
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-bold);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .action-priority.high {
      background: #FFF1F0;
      color: #CF1322;
    }

    .action-priority.medium {
      background: var(--color-accent-light);
      color: var(--color-accent-dark);
    }

    .action-priority.low {
      background: var(--color-gray-200);
      color: var(--text-secondary);
    }

    .action-description {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      line-height: var(--line-height-relaxed);
      margin-bottom: var(--spacing-md);
    }

    .action-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }

    .action-meta-item {
      text-align: center;
      padding: var(--spacing-sm);
      background: var(--bg-hover);
      border-radius: var(--radius-md);
    }

    .action-meta-label {
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
      margin-bottom: var(--spacing-xs);
    }

    .action-meta-value {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      color: var(--text-primary);
    }

    .loading-recommendations {
      text-align: center;
      padding: var(--spacing-3xl);
      color: var(--text-secondary);
    }

    .recommendation-error {
      text-align: center;
      padding: var(--spacing-xl);
      background: #FFF1F0;
      border: var(--border-width) solid var(--color-error);
      border-radius: var(--radius-lg);
      color: #CF1322;
    }

    .actions-section {
      text-align: center;
      padding: var(--spacing-2xl);
      background: var(--color-primary-light);
      border-radius: var(--radius-lg);
    }

    .actions-buttons {
      display: flex;
      gap: var(--spacing-md);
      justify-content: center;
      flex-wrap: wrap;
    }

    .loading-screen {
      display: flex;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-page);
      z-index: var(--z-modal);
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    .loading-screen.hidden {
      display: none;
    }

    .loading-message {
      margin-top: var(--spacing-xl);
      font-size: var(--font-size-lg);
      color: var(--text-secondary);
    }

    @media (max-width: 768px) {
      .strength-bar {
        width: 100%;
        margin-left: 0;
        margin-top: var(--spacing-sm);
      }

      .strength-item {
        flex-direction: column;
        align-items: flex-start;
      }

      .actions-buttons {
        flex-direction: column;
      }

      .actions-buttons .btn {
        width: 100%;
      }

      /* Mobile-specific recommendation styles */
      .recommendation-tabs {
        flex-direction: column;
        gap: 0;
        border-bottom: none;
      }

      .recommendation-tab {
        border-radius: 0;
        border-bottom: var(--border-width) solid var(--color-gray-200);
      }

      .recommendation-tab.active {
        border-bottom-color: var(--color-primary);
      }

      .career-recommendations {
        grid-template-columns: 1fr;
      }

      .career-card {
        padding: var(--spacing-md);
      }

      .career-title {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-xs);
      }

      .action-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-sm);
      }

      .action-meta {
        grid-template-columns: 1fr;
      }

      .priority-areas {
        flex-direction: column;
        align-items: stretch;
      }

      .priority-area {
        text-align: center;
      }

      /* Mobile share modal adjustments */
      .share-modal-content {
        width: 95%;
        margin: var(--spacing-md);
      }

      .share-modal-header {
        padding: var(--spacing-md);
      }

      .share-modal-body {
        padding: var(--spacing-md);
      }

      .share-url-container {
        flex-direction: column;
      }

      .share-copy-btn {
        width: 100%;
      }

      .share-buttons {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading-screen" class="loading-screen">
    <div class="spinner spinner-lg"></div>
    <p class="loading-message">正在分析您的優勢...</p>
  </div>

  <div id="results-page" class="results-page" style="display: none;">
    <!-- Header -->
    <header class="results-header">
      <div class="results-header-content">
        <h1 class="results-title">🎉 恭喜您完成測驗!</h1>
        <p class="results-subtitle">以下是您的優勢分析結果</p>
      </div>
    </header>

    <!-- Main Content -->
    <main class="results-main">
      <div class="results-content">
        <!-- Top 3 Strengths -->
        <section class="section">
          <h2 class="section-heading">您的前三大優勢</h2>
          <div id="top-strengths" class="top-strengths">
            <!-- Top strengths will be inserted here -->
          </div>
        </section>

        <!-- All Strengths -->
        <section class="section">
          <h2 class="section-heading">完整優勢排名</h2>
          <div id="all-strengths" class="all-strengths">
            <!-- All strengths will be inserted here -->
          </div>
        </section>

        <!-- Recommendations -->
        <section class="section">
          <h2 class="section-heading">個人化建議與推薦</h2>
          <div id="recommendations-section" class="recommendations-section">
            <div class="recommendation-tabs">
              <button class="recommendation-tab active" data-tab="careers">
                💼 職涯推薦
              </button>
              <button class="recommendation-tab" data-tab="development">
                📈 發展計畫
              </button>
            </div>

            <!-- Career Recommendations Tab -->
            <div id="careers-content" class="recommendation-content active">
              <div id="career-recommendations-container">
                <div class="loading-recommendations">
                  <div class="spinner"></div>
                  <p>正在分析您的職涯適性...</p>
                </div>
              </div>
            </div>

            <!-- Development Plan Tab -->
            <div id="development-content" class="recommendation-content">
              <div id="development-plan-container">
                <div class="loading-recommendations">
                  <div class="spinner"></div>
                  <p>正在制定個人發展計畫...</p>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Actions -->
        <section class="section">
          <div class="actions-section">
            <h2 class="section-heading">接下來...</h2>
            <p style="color: var(--text-secondary); margin-bottom: var(--spacing-xl);">
              下載 PDF 報告以獲得完整的優勢分析與職涯建議
            </p>
            <div class="actions-buttons">
              <button class="btn btn-primary btn-lg" onclick="downloadReport()">
                📄 下載 PDF 報告
              </button>
              <button class="btn btn-outline" onclick="shareResults()">
                🔗 分享結果
              </button>
              <button class="btn btn-ghost" onclick="startNew()">
                重新測驗
              </button>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script type="module">
    import { storage } from '/js/storage.js';
    import { api, APIError } from '/js/api.js';

    // Get session ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('session');

    // Elements
    const loadingScreen = document.getElementById('loading-screen');
    const resultsPage = document.getElementById('results-page');
    const topStrengthsContainer = document.getElementById('top-strengths');
    const allStrengthsContainer = document.getElementById('all-strengths');
    const careerRecommendationsContainer = document.getElementById('career-recommendations-container');
    const developmentPlanContainer = document.getElementById('development-plan-container');

    // Strength display names (Chinese)
    const strengthNames = {
      'achiever': '成就',
      'activator': '行動',
      'adaptability': '適應',
      'analytical': '分析',
      'arranger': '統籌',
      'belief': '信仰',
      'command': '統率',
      'communication': '溝通',
      'competition': '競爭',
      'connectedness': '關聯',
      'consistency': '公平',
      'context': '回顧'
    };

    // Initialize
    async function initialize() {
      try {
        if (!sessionId) {
          alert('無效的會話 ID');
          window.location.href = '/index.html';
          return;
        }

        // Fetch results from API
        const response = await api.getResults(sessionId);
        const results = response.data;

        // Display results
        displayResults(results);

        // Load recommendations
        loadRecommendations();

        // Hide loading, show results
        loadingScreen.classList.add('hidden');
        resultsPage.style.display = 'block';

        // Animate strength bars
        setTimeout(() => {
          animateStrengthBars();
        }, 800);
      } catch (error) {
        console.error('Load results error:', error);
        alert('載入結果失敗,請稍後再試');
        window.location.href = '/index.html';
      }
    }

    // Display results
    function displayResults(results) {
      const strengths = results.strengths || [];

      // Sort by score
      strengths.sort((a, b) => b.score - a.score);

      // Display top 3
      const top3 = strengths.slice(0, 3);
      topStrengthsContainer.innerHTML = top3.map((strength, index) => `
        <div class="strength-card">
          <div class="strength-rank">${index + 1}</div>
          <h3 class="strength-name">${strengthNames[strength.name] || strength.name}</h3>
          <p class="strength-score">分數: ${strength.score.toFixed(2)}</p>
          <p class="strength-description">${strength.description || ''}</p>
        </div>
      `).join('');

      // Display all strengths
      allStrengthsContainer.innerHTML = strengths.map((strength, index) => {
        const percentage = (strength.score / 100) * 100;
        return `
          <div class="strength-item">
            <div class="strength-item-rank">${index + 1}</div>
            <div class="strength-item-info">
              <div class="strength-item-name">${strengthNames[strength.name] || strength.name}</div>
              <div class="strength-item-score">分數: ${strength.score.toFixed(2)}</div>
            </div>
            <div class="strength-bar">
              <div class="strength-bar-fill" data-width="${percentage}%" style="width: 0%;"></div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Animate strength bars
    function animateStrengthBars() {
      const bars = document.querySelectorAll('.strength-bar-fill');
      bars.forEach((bar, index) => {
        setTimeout(() => {
          const width = bar.getAttribute('data-width');
          bar.style.width = width;
        }, index * 100);
      });
    }

    // Load recommendations
    async function loadRecommendations() {
      try {
        // Load career recommendations and development plan in parallel
        const [careerResponse, developmentResponse] = await Promise.all([
          api.get(`/recommendations/${sessionId}/careers`),
          api.get(`/recommendations/${sessionId}/development`)
        ]);

        displayCareerRecommendations(careerResponse.data || careerResponse);
        displayDevelopmentPlan(developmentResponse.data || developmentResponse);
      } catch (error) {
        console.error('Load recommendations error:', error);
        displayRecommendationError();
      }
    }

    // Display career recommendations
    function displayCareerRecommendations(recommendations) {
      if (!recommendations || recommendations.length === 0) {
        careerRecommendationsContainer.innerHTML = `
          <div class="recommendation-error">
            <h3>暫無職涯推薦</h3>
            <p>系統正在處理您的資料，請稍後再試</p>
          </div>
        `;
        return;
      }

      const html = `
        <div class="career-recommendations">
          ${recommendations.map(career => `
            <div class="career-card">
              <div class="career-title">
                <span>${career.title}</span>
                <span class="match-score ${getConfidenceClass(career.confidence_level)}">
                  ${Math.round(career.match_score)}% 匹配
                </span>
              </div>
              <div class="career-chinese-title">${career.chinese_title}</div>
              <div class="career-description">${career.description}</div>

              <div class="career-details">
                <div class="career-detail-item">
                  <div class="career-detail-label">主要運用優勢</div>
                  <div class="career-detail-tags">
                    ${career.primary_strengths_used.map(strength =>
                      `<span class="career-tag">${strength}</span>`
                    ).join('')}
                  </div>
                </div>

                <div class="career-detail-item">
                  <div class="career-detail-label">需要技能</div>
                  <div class="career-detail-tags">
                    ${career.required_skills.map(skill =>
                      `<span class="career-tag">${skill}</span>`
                    ).join('')}
                  </div>
                </div>

                <div class="career-detail-item">
                  <div class="career-detail-label">發展建議</div>
                  <div style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-top: var(--spacing-xs);">
                    ${career.development_suggestions.map(suggestion =>
                      `<div>• ${suggestion}</div>`
                    ).join('')}
                  </div>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;

      careerRecommendationsContainer.innerHTML = html;
    }

    // Display development plan
    function displayDevelopmentPlan(plan) {
      if (!plan) {
        developmentPlanContainer.innerHTML = `
          <div class="recommendation-error">
            <h3>暫無發展計畫</h3>
            <p>系統正在處理您的資料，請稍後再試</p>
          </div>
        `;
        return;
      }

      const html = `
        <div class="development-plan">
          <div class="development-focus">
            <h3>發展重點</h3>
            <p style="color: var(--text-secondary); margin-bottom: var(--spacing-md);">${plan.career_focus}</p>
            <div class="priority-areas">
              ${plan.priority_areas.map(area =>
                `<span class="priority-area">${area}</span>`
              ).join('')}
            </div>
          </div>

          <div class="development-actions">
            ${plan.immediate_actions.map((action, index) => `
              <div class="action-card">
                <div class="action-header">
                  <div>
                    <div class="action-title">${action.title}</div>
                    <div class="action-chinese-title">${action.chinese_title}</div>
                  </div>
                  <div class="action-priority ${getPriorityClass(action.priority)}">
                    優先度 ${action.priority}
                  </div>
                </div>

                <div class="action-description">${action.description}</div>

                <div class="action-meta">
                  <div class="action-meta-item">
                    <div class="action-meta-label">時間框架</div>
                    <div class="action-meta-value">${action.timeframe}</div>
                  </div>
                  <div class="action-meta-item">
                    <div class="action-meta-label">預估時數</div>
                    <div class="action-meta-value">${action.estimated_hours}小時</div>
                  </div>
                  <div class="action-meta-item">
                    <div class="action-meta-label">學習方式</div>
                    <div class="action-meta-value">${action.learning_method}</div>
                  </div>
                </div>

                ${action.success_metrics && action.success_metrics.length > 0 ? `
                  <div class="career-detail-item">
                    <div class="career-detail-label">成功指標</div>
                    <div style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-top: var(--spacing-xs);">
                      ${action.success_metrics.map(metric =>
                        `<div>• ${metric}</div>`
                      ).join('')}
                    </div>
                  </div>
                ` : ''}
              </div>
            `).join('')}
          </div>
        </div>
      `;

      developmentPlanContainer.innerHTML = html;
    }

    // Display recommendation error
    function displayRecommendationError() {
      const errorHtml = `
        <div class="recommendation-error">
          <h3>推薦載入失敗</h3>
          <p>無法載入個人化推薦，請稍後再試或聯絡技術支援</p>
        </div>
      `;

      careerRecommendationsContainer.innerHTML = errorHtml;
      developmentPlanContainer.innerHTML = errorHtml;
    }

    // Helper functions
    function getConfidenceClass(confidence) {
      if (confidence === 'high') return 'high';
      if (confidence === 'medium') return 'medium';
      return 'low';
    }

    function getPriorityClass(priority) {
      if (priority <= 2) return 'high';
      if (priority <= 4) return 'medium';
      return 'low';
    }

    // Tab switching functionality
    function initTabSwitching() {
      const tabs = document.querySelectorAll('.recommendation-tab');
      const contents = document.querySelectorAll('.recommendation-content');

      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const targetTab = tab.getAttribute('data-tab');

          // Update tab states
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');

          // Update content states
          contents.forEach(content => {
            content.classList.remove('active');
            if (content.id === `${targetTab}-content`) {
              content.classList.add('active');
            }
          });
        });
      });
    }

    // Download report with enhanced UX
    window.downloadReport = async function() {
      const downloadBtn = document.querySelector('.btn-primary');
      const originalText = downloadBtn.innerHTML;

      try {
        // Update button to show loading state
        downloadBtn.innerHTML = '<div class="spinner spinner-sm"></div> 生成報告中...';
        downloadBtn.disabled = true;

        // Call the reports API endpoint
        const response = await fetch(`${api.baseURL}/reports/generate/session`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            session_id: sessionId,
            user_name: '使用者',
            report_type: 'comprehensive',
            report_format: 'pdf'
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const reportData = await response.json();
        const reportId = reportData.data.report_id;

        // Update button to show processing
        downloadBtn.innerHTML = '<div class="spinner spinner-sm"></div> 處理中...';

        // Poll for report completion
        await pollReportStatus(reportId, downloadBtn);

      } catch (error) {
        console.error('Download error:', error);

        // Show error state
        downloadBtn.innerHTML = '❌ 下載失敗';
        downloadBtn.style.background = 'var(--color-error)';

        setTimeout(() => {
          downloadBtn.innerHTML = originalText;
          downloadBtn.disabled = false;
          downloadBtn.style.background = '';
        }, 3000);

        // Show user-friendly error message
        showDownloadError(error);
      }
    };

    // Poll report status until completion
    async function pollReportStatus(reportId, downloadBtn) {
      const maxAttempts = 30; // 30 seconds max
      let attempts = 0;

      const checkStatus = async () => {
        try {
          const statusResponse = await fetch(`${api.baseURL}/reports/${reportId}`);
          const statusData = await statusResponse.json();

          const status = statusData.data.status;
          const progress = statusData.data.progress || 0;

          // Update button with progress
          if (status === 'PROCESSING') {
            downloadBtn.innerHTML = `<div class="spinner spinner-sm"></div> 生成中 ${Math.round(progress)}%`;
          }

          if (status === 'COMPLETED') {
            // Download the file
            await downloadReportFile(reportId, downloadBtn);
            return;
          }

          if (status === 'FAILED') {
            throw new Error('Report generation failed');
          }

          // Continue polling if still processing
          if (status === 'PENDING' || status === 'PROCESSING') {
            attempts++;
            if (attempts < maxAttempts) {
              setTimeout(checkStatus, 1000); // Check every second
            } else {
              throw new Error('Report generation timeout');
            }
          }

        } catch (error) {
          throw error;
        }
      };

      await checkStatus();
    }

    // Download the completed report file
    async function downloadReportFile(reportId, downloadBtn) {
      try {
        downloadBtn.innerHTML = '<div class="spinner spinner-sm"></div> 下載中...';

        const response = await fetch(`${api.baseURL}/reports/${reportId}/download`);

        if (!response.ok) {
          throw new Error('Failed to download report');
        }

        const blob = await response.blob();
        const url = URL.createObjectURL(blob);

        // Extract filename from response headers or use default
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = `gallup-strengths-report-${sessionId}.pdf`;

        if (contentDisposition) {
          const filenameMatch = contentDisposition.match(/filename="(.+)"/);
          if (filenameMatch) {
            filename = filenameMatch[1];
          }
        }

        // Create download link
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        // Show success state
        downloadBtn.innerHTML = '✅ 下載完成';
        downloadBtn.style.background = 'var(--color-secondary)';

        setTimeout(() => {
          downloadBtn.innerHTML = '📄 下載 PDF 報告';
          downloadBtn.disabled = false;
          downloadBtn.style.background = '';
        }, 3000);

      } catch (error) {
        throw error;
      }
    }

    // Show download error with user-friendly message
    function showDownloadError(error) {
      const errorMessages = {
        'Network error': '網路連線問題，請檢查您的網路連線',
        'HTTP 404': '報告不存在或已過期',
        'HTTP 500': '伺服器錯誤，請稍後再試',
        'Report generation timeout': '報告生成時間過長，請稍後再試',
        'default': '下載失敗，請稍後再試或聯絡技術支援'
      };

      let message = errorMessages.default;
      const errorStr = error.message || '';

      for (const [key, value] of Object.entries(errorMessages)) {
        if (errorStr.includes(key)) {
          message = value;
          break;
        }
      }

      // Create and show error modal/alert
      const errorModal = document.createElement('div');
      errorModal.className = 'error-modal';
      errorModal.innerHTML = `
        <div class="error-modal-overlay">
          <div class="error-modal-content">
            <h3>下載失敗</h3>
            <p>${message}</p>
            <button class="btn btn-primary" onclick="this.closest('.error-modal').remove()">
              確定
            </button>
          </div>
        </div>
      `;

      // Add modal styles
      errorModal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
      `;

      errorModal.querySelector('.error-modal-overlay').style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
      `;

      errorModal.querySelector('.error-modal-content').style.cssText = `
        background: var(--bg-card);
        padding: var(--spacing-xl);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        max-width: 400px;
        text-align: center;
        position: relative;
        z-index: 1;
      `;

      document.body.appendChild(errorModal);

      // Auto-remove after 10 seconds
      setTimeout(() => {
        if (errorModal.parentNode) {
          errorModal.remove();
        }
      }, 10000);
    }

    // Enhanced share results with multiple options
    window.shareResults = async function() {
      const shareBtn = document.querySelector('button[onclick="shareResults()"]');
      const originalText = shareBtn.innerHTML;

      try {
        // Update button to show loading
        shareBtn.innerHTML = '<div class="spinner spinner-sm"></div> 生成分享連結...';
        shareBtn.disabled = true;

        // Get share link from API
        const response = await api.getShareLink(sessionId);
        const shareUrl = response.data.share_url;

        // Reset button
        shareBtn.innerHTML = originalText;
        shareBtn.disabled = false;

        // Show share modal
        showShareModal(shareUrl);

      } catch (error) {
        console.error('Share error:', error);

        // Reset button
        shareBtn.innerHTML = originalText;
        shareBtn.disabled = false;

        // Show error
        showShareError();
      }
    };

    // Show share modal with multiple sharing options
    function showShareModal(shareUrl) {
      const modal = document.createElement('div');
      modal.className = 'share-modal';
      modal.innerHTML = `
        <div class="share-modal-overlay" onclick="this.closest('.share-modal').remove()">
          <div class="share-modal-content" onclick="event.stopPropagation()">
            <div class="share-modal-header">
              <h3>分享您的優勢測驗結果</h3>
              <button class="share-modal-close" onclick="this.closest('.share-modal').remove()">
                ✕
              </button>
            </div>

            <div class="share-modal-body">
              <p class="share-description">
                與朋友、同事或教練分享您的優勢分析結果
              </p>

              <div class="share-url-container">
                <input
                  type="text"
                  class="share-url-input"
                  value="${shareUrl}"
                  readonly
                  onclick="this.select()"
                />
                <button class="btn btn-outline share-copy-btn" onclick="copyShareUrl('${shareUrl}', this)">
                  📋 複製
                </button>
              </div>

              <div class="share-options">
                <h4>分享方式</h4>
                <div class="share-buttons">
                  <button class="share-option-btn" onclick="shareViaEmail('${shareUrl}')">
                    📧 電子郵件
                  </button>
                  <button class="share-option-btn" onclick="shareViaWhatsApp('${shareUrl}')">
                    💬 WhatsApp
                  </button>
                  <button class="share-option-btn" onclick="shareViaLine('${shareUrl}')">
                    💚 LINE
                  </button>
                  <button class="share-option-btn" onclick="shareViaNative('${shareUrl}')">
                    📱 其他應用
                  </button>
                </div>
              </div>

              <div class="share-info">
                <div class="share-info-item">
                  <strong>🔒 隱私保護</strong>
                  <p>此連結僅包含您的測驗結果，不包含個人識別資訊</p>
                </div>
                <div class="share-info-item">
                  <strong>⏰ 有效期限</strong>
                  <p>分享連結將在 30 天後自動失效</p>
                </div>
                <div class="share-info-item">
                  <strong>👁️ 單次查看</strong>
                  <p>出於隱私考量，每個連結僅能查看一次</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      // Add modal styles
      const styles = `
        .share-modal {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          z-index: 10000;
          display: flex;
          align-items: center;
          justify-content: center;
          animation: fadeIn 0.3s ease;
        }

        .share-modal-overlay {
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.6);
          backdrop-filter: blur(2px);
        }

        .share-modal-content {
          background: var(--bg-card);
          border-radius: var(--radius-lg);
          box-shadow: var(--shadow-lg);
          max-width: 500px;
          width: 90%;
          max-height: 90vh;
          overflow-y: auto;
          position: relative;
          z-index: 1;
          animation: slideUp 0.3s ease;
        }

        .share-modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: var(--spacing-xl);
          border-bottom: var(--border-width) solid var(--color-gray-200);
        }

        .share-modal-header h3 {
          margin: 0;
          color: var(--text-primary);
          font-size: var(--font-size-xl);
        }

        .share-modal-close {
          background: none;
          border: none;
          font-size: var(--font-size-xl);
          color: var(--text-secondary);
          cursor: pointer;
          padding: var(--spacing-sm);
          border-radius: var(--radius-md);
          transition: var(--transition-all);
        }

        .share-modal-close:hover {
          background: var(--bg-hover);
          color: var(--text-primary);
        }

        .share-modal-body {
          padding: var(--spacing-xl);
        }

        .share-description {
          color: var(--text-secondary);
          margin-bottom: var(--spacing-xl);
          text-align: center;
        }

        .share-url-container {
          display: flex;
          gap: var(--spacing-sm);
          margin-bottom: var(--spacing-xl);
        }

        .share-url-input {
          flex: 1;
          padding: var(--spacing-md);
          border: var(--border-width) solid var(--color-gray-300);
          border-radius: var(--radius-md);
          font-size: var(--font-size-sm);
          font-family: monospace;
          background: var(--color-gray-50);
        }

        .share-url-input:focus {
          outline: none;
          border-color: var(--color-primary);
        }

        .share-copy-btn {
          white-space: nowrap;
        }

        .share-options h4 {
          margin: 0 0 var(--spacing-md) 0;
          color: var(--text-primary);
          font-size: var(--font-size-base);
        }

        .share-buttons {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
          gap: var(--spacing-md);
          margin-bottom: var(--spacing-xl);
        }

        .share-option-btn {
          padding: var(--spacing-md);
          border: var(--border-width) solid var(--color-gray-300);
          border-radius: var(--radius-md);
          background: var(--bg-card);
          color: var(--text-primary);
          font-size: var(--font-size-sm);
          cursor: pointer;
          transition: var(--transition-all);
          text-align: center;
        }

        .share-option-btn:hover {
          border-color: var(--color-primary);
          background: var(--color-primary-light);
          transform: translateY(-1px);
        }

        .share-info {
          background: var(--color-primary-light);
          border-radius: var(--radius-md);
          padding: var(--spacing-lg);
        }

        .share-info-item {
          margin-bottom: var(--spacing-md);
        }

        .share-info-item:last-child {
          margin-bottom: 0;
        }

        .share-info-item strong {
          display: block;
          color: var(--color-primary-dark);
          margin-bottom: var(--spacing-xs);
          font-size: var(--font-size-sm);
        }

        .share-info-item p {
          margin: 0;
          color: var(--text-secondary);
          font-size: var(--font-size-sm);
          line-height: var(--line-height-relaxed);
        }

        @keyframes slideUp {
          from {
            opacity: 0;
            transform: translateY(30px) scale(0.95);
          }
          to {
            opacity: 1;
            transform: translateY(0) scale(1);
          }
        }
      `;

      // Add styles to head
      const styleSheet = document.createElement('style');
      styleSheet.textContent = styles;
      document.head.appendChild(styleSheet);

      document.body.appendChild(modal);

      // Auto-remove stylesheet when modal is removed
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'childList') {
            mutation.removedNodes.forEach((node) => {
              if (node === modal) {
                styleSheet.remove();
                observer.disconnect();
              }
            });
          }
        });
      });
      observer.observe(document.body, { childList: true });
    }

    // Copy share URL to clipboard
    window.copyShareUrl = async function(url, button) {
      try {
        await navigator.clipboard.writeText(url);
        const originalText = button.innerHTML;
        button.innerHTML = '✅ 已複製';
        button.style.background = 'var(--color-secondary)';
        button.style.color = 'white';

        setTimeout(() => {
          button.innerHTML = originalText;
          button.style.background = '';
          button.style.color = '';
        }, 2000);
      } catch (error) {
        // Fallback for older browsers
        const input = document.querySelector('.share-url-input');
        input.select();
        document.execCommand('copy');

        const originalText = button.innerHTML;
        button.innerHTML = '✅ 已複製';
        setTimeout(() => {
          button.innerHTML = originalText;
        }, 2000);
      }
    };

    // Share via email
    window.shareViaEmail = function(url) {
      const subject = encodeURIComponent('我的 Gallup 優勢測驗結果');
      const body = encodeURIComponent(`我剛完成了 Gallup 優勢測驗，來看看我的結果吧！\n\n查看結果：${url}\n\n這個測驗幫助我更了解自己的天賦優勢，推薦你也試試看！`);
      window.open(`mailto:?subject=${subject}&body=${body}`);
    };

    // Share via WhatsApp
    window.shareViaWhatsApp = function(url) {
      const text = encodeURIComponent(`我剛完成了 Gallup 優勢測驗，來看看我的結果吧！ ${url}`);
      window.open(`https://wa.me/?text=${text}`);
    };

    // Share via LINE
    window.shareViaLine = function(url) {
      const text = encodeURIComponent(`我剛完成了 Gallup 優勢測驗，來看看我的結果吧！`);
      window.open(`https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(url)}&text=${text}`);
    };

    // Share via native sharing API
    window.shareViaNative = async function(url) {
      if (navigator.share) {
        try {
          await navigator.share({
            title: 'Gallup 優勢測驗結果',
            text: '我剛完成了 Gallup 優勢測驗，來看看我的結果吧！',
            url: url
          });
        } catch (error) {
          if (error.name !== 'AbortError') {
            console.error('Native share error:', error);
            // Fallback to copy
            copyShareUrl(url, { innerHTML: '📱 其他應用', style: {} });
          }
        }
      } else {
        // Fallback to copy
        copyShareUrl(url, { innerHTML: '📱 其他應用', style: {} });
      }
    };

    // Show share error
    function showShareError() {
      const errorModal = document.createElement('div');
      errorModal.innerHTML = `
        <div style="
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          z-index: 10000;
          display: flex;
          align-items: center;
          justify-content: center;
          background: rgba(0, 0, 0, 0.5);
        ">
          <div style="
            background: var(--bg-card);
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            max-width: 400px;
            text-align: center;
          ">
            <h3>分享功能暫時無法使用</h3>
            <p style="color: var(--text-secondary); margin: var(--spacing-md) 0;">
              系統正在處理中，請稍後再試或直接複製當前頁面網址分享
            </p>
            <button class="btn btn-primary" onclick="this.closest('div').remove()">
              確定
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(errorModal);

      setTimeout(() => {
        if (errorModal.parentNode) {
          errorModal.remove();
        }
      }, 8000);
    }

    // Start new assessment
    window.startNew = function() {
      if (confirm('開始新測驗將清除目前資料,確定繼續?')) {
        storage.clear();
        window.location.href = '/index.html';
      }
    };

    // Initialize on load
    window.addEventListener('DOMContentLoaded', () => {
      initialize();
      initTabSwitching();
    });
  </script>
</body>
</html>
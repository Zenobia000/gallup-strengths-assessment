<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ÈÄ≤Ë°åÊ∏¨È©ó - Gallup ÂÑ™Âã¢Ê∏¨È©ó</title>

  <link rel="stylesheet" href="/css/variables.css">
  <link rel="stylesheet" href="/css/reset.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/animations.css">
  <link rel="stylesheet" href="/css/responsive.css">

  <style>
    .assessment-page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: var(--bg-page);
    }

    .assessment-header {
      background: var(--bg-card);
      padding: var(--spacing-lg) var(--spacing-md);
      box-shadow: var(--shadow-sm);
      position: sticky;
      top: 0;
      z-index: var(--z-sticky);
    }

    .assessment-header-content {
      max-width: var(--container-md);
      margin: 0 auto;
    }

    .header-title {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
      margin-bottom: var(--spacing-md);
    }

    .assessment-main {
      flex: 1;
      padding: var(--spacing-2xl) var(--spacing-md);
    }

    .assessment-content {
      max-width: var(--container-md);
      margin: 0 auto;
    }

    .question-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      padding: var(--spacing-2xl);
      margin-bottom: var(--spacing-xl);
      min-height: 400px;
      display: flex;
      flex-direction: column;
    }

    .question-number {
      font-size: var(--font-size-sm);
      color: var(--text-tertiary);
      margin-bottom: var(--spacing-md);
      font-weight: var(--font-weight-medium);
    }

    .question-text {
      font-size: var(--font-size-2xl);
      font-weight: var(--font-weight-medium);
      color: var(--text-primary);
      line-height: var(--line-height-relaxed);
      margin-bottom: var(--spacing-2xl);
      flex: 1;
      display: flex;
      align-items: center;
    }

    .likert-scale {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .likert-option {
      display: flex;
      align-items: center;
      padding: var(--spacing-lg);
      border: var(--border-width-thick) solid var(--color-gray-300);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition-all);
      user-select: none;
    }

    .likert-option:hover {
      border-color: var(--color-primary);
      background: var(--color-primary-light);
    }

    .likert-option.selected {
      border-color: var(--color-primary);
      background: var(--color-primary-light);
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
    }

    .likert-option input[type="radio"] {
      width: 20px;
      height: 20px;
      margin-right: var(--spacing-md);
      cursor: pointer;
      accent-color: var(--color-primary);
    }

    .likert-label {
      flex: 1;
      font-size: var(--font-size-base);
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .likert-value {
      font-size: var(--font-size-sm);
      color: var(--text-tertiary);
      font-weight: var(--font-weight-medium);
    }

    .navigation-buttons {
      display: flex;
      gap: var(--spacing-md);
      margin-top: var(--spacing-xl);
    }

    .navigation-buttons .btn {
      flex: 1;
    }

    .milestone-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: var(--z-modal);
      align-items: center;
      justify-content: center;
    }

    .milestone-modal.show {
      display: flex;
    }

    .milestone-content {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      padding: var(--spacing-3xl);
      max-width: 500px;
      text-align: center;
      animation: bounceIn 0.5s ease;
    }

    .milestone-emoji {
      font-size: 80px;
      margin-bottom: var(--spacing-lg);
    }

    .milestone-title {
      font-size: var(--font-size-3xl);
      font-weight: var(--font-weight-bold);
      color: var(--text-primary);
      margin-bottom: var(--spacing-md);
    }

    .milestone-message {
      font-size: var(--font-size-lg);
      color: var(--text-secondary);
      margin-bottom: var(--spacing-xl);
    }

    @keyframes bounceIn {
      0% {
        transform: scale(0.3);
        opacity: 0;
      }
      50% {
        transform: scale(1.05);
      }
      70% {
        transform: scale(0.9);
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .loading-screen {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-page);
      z-index: var(--z-modal);
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    .loading-screen.show {
      display: flex;
    }

    .loading-message {
      margin-top: var(--spacing-xl);
      font-size: var(--font-size-lg);
      color: var(--text-secondary);
    }

    /* Question Type Indicator */
    .question-type-indicator {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: var(--spacing-md);
    }

    .traditional-indicator {
      background-color: #e6fffa;
      color: #234e52;
    }

    .situational-indicator {
      background-color: #fef5e7;
      color: #744210;
    }

    /* Scenario Context */
    .scenario-context {
      background-color: var(--color-gray-50);
      border-left: 4px solid var(--color-primary);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
      border-radius: 0 8px 8px 0;
      font-style: italic;
      color: var(--text-secondary);
    }

    /* Response Options */
    .response-options {
      margin-bottom: var(--spacing-xl);
    }

    /* Situational Options */
    .situational-options {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .situational-option {
      border: 2px solid var(--color-gray-200);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      cursor: pointer;
      transition: all 0.2s ease;
      background-color: var(--bg-card);
    }

    .situational-option:hover {
      border-color: var(--color-primary);
      background-color: var(--color-gray-50);
    }

    .situational-option.selected {
      border-color: var(--color-primary);
      background-color: var(--color-primary-50);
    }

    .situational-option input[type="radio"] {
      margin-right: var(--spacing-sm);
    }

    .situational-option-text {
      font-weight: var(--font-weight-medium);
      color: var(--text-primary);
    }

    @media (max-width: 768px) {
      .question-text {
        font-size: var(--font-size-xl);
      }

      .milestone-emoji {
        font-size: 60px;
      }

      .milestone-title {
        font-size: var(--font-size-2xl);
      }
    }
  </style>
</head>
<body>
  <div class="assessment-page">
    <!-- Header with Progress -->
    <header class="assessment-header">
      <div class="assessment-header-content">
        <h1 class="header-title">Gallup ÂÑ™Âã¢Ê∏¨È©ó</h1>
        <div class="progress-text">
          <span>ÈÄ≤Â∫¶</span>
          <span id="progress-label">0 / 20</span>
        </div>
        <div class="progress">
          <div id="progress-bar" class="progress-bar" style="width: 0%;"></div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="assessment-main">
      <div class="assessment-content">
        <div id="question-card" class="question-card">
          <div class="question-number" id="question-number">È°åÁõÆ 1 / 20</div>

          <!-- Question Type Indicator -->
          <div id="question-type-indicator" class="question-type-indicator"></div>

          <!-- Scenario Context for Situational Questions -->
          <div id="scenario-context" class="scenario-context" style="display: none;"></div>

          <div class="question-text" id="question-text">
            ËºâÂÖ•‰∏≠...
          </div>

          <!-- Response Options Container -->
          <div id="response-options" class="response-options">
            <div class="likert-scale" id="likert-scale">
              <!-- Traditional Likert options will be inserted here -->
            </div>
            <div class="situational-options" id="situational-options" style="display: none;">
              <!-- Situational options will be inserted here -->
            </div>
          </div>
          <div class="navigation-buttons">
            <button id="prev-button" class="btn btn-outline" onclick="previousQuestion()" disabled>
              ‰∏ä‰∏ÄÈ°å
            </button>
            <button id="next-button" class="btn btn-primary" onclick="nextQuestion()" disabled>
              ‰∏ã‰∏ÄÈ°å
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Milestone Modal -->
  <div id="milestone-modal" class="milestone-modal">
    <div class="milestone-content">
      <div class="milestone-emoji" id="milestone-emoji">üéâ</div>
      <h2 class="milestone-title" id="milestone-title">ÂæàÂ•Ω!</h2>
      <p class="milestone-message" id="milestone-message">Â∑≤ÂÆåÊàê 25%</p>
      <button class="btn btn-primary" onclick="closeMilestone()">ÁπºÁ∫å</button>
    </div>
  </div>

  <!-- Loading Screen -->
  <div id="loading-screen" class="loading-screen">
    <div class="spinner spinner-lg"></div>
    <p class="loading-message">Ê≠£Âú®Êèê‰∫§ÊÇ®ÁöÑÁ≠îÊ°à...</p>
  </div>

  <script type="module">
    import { storage } from '/js/storage.js';
    import { api, APIError } from '/js/api.js';

    // State
    let questions = [];
    let currentIndex = 0;
    let answers = [];
    let sessionId = null;
    let isSubmitting = false;

    // Elements
    const questionNumber = document.getElementById('question-number');
    const questionText = document.getElementById('question-text');
    const questionTypeIndicator = document.getElementById('question-type-indicator');
    const scenarioContext = document.getElementById('scenario-context');
    const likertScale = document.getElementById('likert-scale');
    const situationalOptions = document.getElementById('situational-options');
    const progressBar = document.getElementById('progress-bar');
    const progressLabel = document.getElementById('progress-label');
    const prevButton = document.getElementById('prev-button');
    const nextButton = document.getElementById('next-button');
    const milestoneModal = document.getElementById('milestone-modal');
    const loadingScreen = document.getElementById('loading-screen');

    // Initialize
    async function initialize() {
      try {
        // Check session
        sessionId = storage.getSession();

        // Check if session ID is valid format (should start with "sess_")
        // If it starts with "consent_", it's an old format and needs to be recreated
        if (!sessionId || !storage.hasValidSession() || sessionId.startsWith('consent_')) {
          // If we have consent but invalid session, create a new session
          if (storage.hasConsent() && sessionId && sessionId.startsWith('consent_')) {
            try {
              // Create new session with the consent ID
              const sessionResponse = await api.post('/sessions/start', {
                consent_id: sessionId
              });
              sessionId = sessionResponse.data.session_id;
              storage.saveSession(sessionId);
              console.log('Created new session:', sessionId);
            } catch (error) {
              console.error('Failed to create session:', error);
              alert('Ë´ãÈáçÊñ∞ÈñãÂßãÊ∏¨È©ó');
              storage.clearSession();
              window.location.href = '/pages/consent.html';
              return;
            }
          } else {
            alert('ÊúÉË©±Â∑≤ÈÅéÊúü,Ë´ãÈáçÊñ∞ÈñãÂßã');
            window.location.href = '/index.html';
            return;
          }
        }

        // Check consent
        if (!storage.hasConsent()) {
          alert('Ë´ãÂÖàÂêåÊÑè‰ΩøÁî®Ê¢ùÊ¨æ');
          window.location.href = '/pages/consent.html';
          return;
        }

        // Load questions with situational support
        const response = await api.getQuestions(true);
        questions = response.questions;

        // Load saved progress
        const savedAnswers = storage.getAnswers();
        if (savedAnswers.length > 0) {
          answers = savedAnswers;
          const progress = storage.getProgress();
          if (progress) {
            currentIndex = progress.currentIndex || 0;
          }
        }

        // Render first question
        renderQuestion();
      } catch (error) {
        console.error('Initialization error:', error);
        alert('ËºâÂÖ•ÂïèÈ°åÂ§±Êïó,Ë´ãÁ®çÂæåÂÜçË©¶');
        window.location.href = '/index.html';
      }
    }

    // Render current question
    function renderQuestion() {
      const question = questions[currentIndex];
      const totalQuestions = questions.length;

      // Update question display
      questionNumber.textContent = `È°åÁõÆ ${currentIndex + 1} / ${totalQuestions}`;
      questionText.textContent = question.text;

      // Update question type indicator
      if (question.question_type === 'situational') {
        questionTypeIndicator.textContent = 'ÊÉÖÂ¢ÉÈ°å';
        questionTypeIndicator.className = 'question-type-indicator situational-indicator';
      } else {
        questionTypeIndicator.textContent = 'ÂÇ≥Áµ±È°å';
        questionTypeIndicator.className = 'question-type-indicator traditional-indicator';
      }

      // Show scenario context for situational questions
      if (question.question_type === 'situational' && question.scenario_context) {
        scenarioContext.textContent = question.scenario_context;
        scenarioContext.style.display = 'block';
      } else {
        scenarioContext.style.display = 'none';
      }

      // Update progress
      const progressPercent = ((currentIndex + 1) / totalQuestions) * 100;
      progressBar.style.width = `${progressPercent}%`;
      progressLabel.textContent = `${currentIndex + 1} / ${totalQuestions}`;

      // Render appropriate response options
      if (question.question_type === 'situational' && question.response_options) {
        renderSituationalOptions(question);
      } else {
        renderLikertScale(question);
      }

      // Update navigation buttons
      prevButton.disabled = currentIndex === 0;
      updateNextButton();
    }

    // Render Likert scale options
    function renderLikertScale(question) {
      // Show Likert scale, hide situational options
      likertScale.style.display = 'block';
      situationalOptions.style.display = 'none';

      const options = [
        { value: 1, label: 'ÈùûÂ∏∏‰∏çÂêåÊÑè' },
        { value: 2, label: '‰∏çÂêåÊÑè' },
        { value: 3, label: 'ÊôÆÈÄö' },
        { value: 4, label: 'ÂêåÊÑè' },
        { value: 5, label: 'ÈùûÂ∏∏ÂêåÊÑè' },
      ];

      // Check if answer exists
      const savedAnswer = answers.find(a => a.question_id === question.id);

      likertScale.innerHTML = options.map(option => `
        <label class="likert-option ${savedAnswer?.score === option.value ? 'selected' : ''}">
          <input
            type="radio"
            name="question-${question.id}"
            value="${option.value}"
            ${savedAnswer?.score === option.value ? 'checked' : ''}
            onchange="handleAnswer('${question.id}', ${option.value})"
          >
          <span class="likert-label">
            <span>${option.label}</span>
            <span class="likert-value">${option.value}</span>
          </span>
        </label>
      `).join('');
    }

    // Render situational options
    function renderSituationalOptions(question) {
      // Show situational options, hide Likert scale
      likertScale.style.display = 'none';
      situationalOptions.style.display = 'block';

      // Check if answer exists
      const savedAnswer = answers.find(a => a.question_id === question.id);

      situationalOptions.innerHTML = question.response_options.map(option => `
        <div class="situational-option ${savedAnswer?.score === option.value ? 'selected' : ''}"
             onclick="handleSituationalAnswer('${question.id}', ${option.value})">
          <input
            type="radio"
            name="question-${question.id}"
            value="${option.value}"
            ${savedAnswer?.score === option.value ? 'checked' : ''}
          >
          <span class="situational-option-text">${option.text}</span>
        </div>
      `).join('');
    }

    // Handle answer selection
    window.handleAnswer = function(questionId, score) {
      // Update answer
      const existingIndex = answers.findIndex(a => a.question_id === questionId);
      if (existingIndex >= 0) {
        answers[existingIndex].score = score;
      } else {
        answers.push({ question_id: questionId, score });
      }

      // Save to storage
      storage.saveAnswers(answers);
      storage.saveProgress({ currentIndex, total: questions.length });

      // Update selected style
      document.querySelectorAll('.likert-option').forEach(option => {
        option.classList.remove('selected');
      });
      event.target.closest('.likert-option').classList.add('selected');

      // Enable next button
      updateNextButton();
    };

    // Handle situational answer selection
    window.handleSituationalAnswer = function(questionId, score) {
      // Update answer
      const existingIndex = answers.findIndex(a => a.question_id === questionId);
      if (existingIndex >= 0) {
        answers[existingIndex].score = score;
      } else {
        answers.push({ question_id: questionId, score });
      }

      // Save to storage
      storage.saveAnswers(answers);
      storage.saveProgress({ currentIndex, total: questions.length });

      // Update visual selection
      document.querySelectorAll('.situational-option').forEach(option => {
        option.classList.remove('selected');
      });
      event.target.closest('.situational-option').classList.add('selected');

      // Enable next button
      updateNextButton();
    };

    // Update next button state
    function updateNextButton() {
      const question = questions[currentIndex];
      const hasAnswer = answers.some(a => a.question_id === question.id);
      nextButton.disabled = !hasAnswer;

      // Update button text for last question
      if (currentIndex === questions.length - 1) {
        nextButton.textContent = 'Êèê‰∫§Ê∏¨È©ó';
      } else {
        nextButton.textContent = '‰∏ã‰∏ÄÈ°å';
      }
    }

    // Previous question
    window.previousQuestion = function() {
      if (currentIndex > 0) {
        currentIndex--;
        renderQuestion();
      }
    };

    // Next question
    window.nextQuestion = async function() {
      if (currentIndex < questions.length - 1) {
        currentIndex++;
        renderQuestion();
        checkMilestone();
      } else {
        // Submit all answers (only if not already submitting)
        if (!isSubmitting) {
          await submitAssessment();
        }
      }
    };

    // Check milestone
    function checkMilestone() {
      const progress = (currentIndex + 1) / questions.length;

      const milestones = {
        0.25: { emoji: 'üéâ', title: 'ÂæàÂ•Ω!', message: 'Â∑≤ÂÆåÊàê 1/4' },
        0.50: { emoji: '‚≠ê', title: 'Â§™Ê£í‰∫Ü!', message: 'Â∑≤ÈÅéÂçä!' },
        0.75: { emoji: 'üöÄ', title: 'Âø´ÂÆåÊàê‰∫Ü!', message: 'Âä†Ê≤π!' },
      };

      const milestone = milestones[progress];
      if (milestone) {
        showMilestone(milestone);
      }
    }

    // Show milestone modal
    function showMilestone(milestone) {
      document.getElementById('milestone-emoji').textContent = milestone.emoji;
      document.getElementById('milestone-title').textContent = milestone.title;
      document.getElementById('milestone-message').textContent = milestone.message;
      milestoneModal.classList.add('show');
    }

    // Close milestone
    window.closeMilestone = function() {
      milestoneModal.classList.remove('show');
    };

    // Submit assessment
    async function submitAssessment() {
      // Prevent multiple submissions
      if (isSubmitting) {
        return;
      }

      isSubmitting = true;

      try {
        loadingScreen.classList.add('show');

        // Disable the next button to prevent multiple clicks
        nextButton.disabled = true;
        nextButton.textContent = 'Êèê‰∫§‰∏≠...';

        // Prepare submission data for scoring API
        const formattedResponses = answers.map((answer, index) => {
          const question = questions.find(q => q.id === answer.question_id);
          // Convert string IDs to numeric IDs for the scoring API
          let questionId;
          if (typeof answer.question_id === 'string') {
            if (answer.question_id.startsWith('ipip_')) {
              questionId = parseInt(answer.question_id.split('_')[1]);
            } else if (answer.question_id.startsWith('sit_')) {
              // For situational questions, use a high number (21, 22, 23...)
              questionId = 20 + parseInt(answer.question_id.split('_')[1]);
            } else {
              questionId = index + 1;
            }
          } else {
            questionId = parseInt(answer.question_id);
          }

          return {
            question_id: questionId,
            response_value: answer.score
          };
        }).filter(response => response.response_value !== undefined);

        const submissionData = {
          session_id: sessionId || 'web-session-' + Date.now(),
          responses: formattedResponses
        };

        // Submit to scoring API
        const result = await api.submitForScoring(submissionData);

        // Store results for the results page
        if (result.success && result.data) {
          localStorage.setItem('assessment_results', JSON.stringify({
            session_id: sessionId,
            scores: result.data.big_five_scores,
            timestamp: Date.now(),
            total_questions: questions.length
          }));
        }

        // Clear storage
        storage.clearProgress();
        storage.clearSession();

        // Redirect to results
        setTimeout(() => {
          window.location.href = `/pages/results.html?session=${sessionId}`;
        }, 1500);
      } catch (error) {
        console.error('Submit error:', error);
        isSubmitting = false;
        loadingScreen.classList.remove('show');

        // Re-enable button on error
        nextButton.disabled = false;
        nextButton.textContent = 'Êèê‰∫§Ê∏¨È©ó';

        // Handle specific error types
        if (error.statusCode === 409) {
          alert('Ê∏¨È©óÂ∑≤ÂÆåÊàêÔºåÊ≠£Âú®Ë∑≥ËΩâÂà∞ÁµêÊûúÈ†ÅÈù¢...');
          setTimeout(() => {
            window.location.href = `/pages/results.html?session=${sessionId}`;
          }, 1000);
        } else {
          alert('Êèê‰∫§Â§±Êïó,Ë´ãÁ®çÂæåÂÜçË©¶');
        }
      }
    }

    // Prevent accidental navigation
    window.addEventListener('beforeunload', (e) => {
      if (answers.length > 0 && answers.length < questions.length) {
        e.preventDefault();
        e.returnValue = '';
      }
    });

    // Initialize on load
    window.addEventListener('DOMContentLoaded', initialize);
  </script>
</body>
</html>
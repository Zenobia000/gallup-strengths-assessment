<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>使用條款與同意 - Gallup 優勢測驗</title>

  <link rel="stylesheet" href="/css/variables.css">
  <link rel="stylesheet" href="/css/reset.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/animations.css">
  <link rel="stylesheet" href="/css/responsive.css">

  <style>
    .consent-page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: var(--bg-page);
    }

    .consent-header {
      background: var(--bg-card);
      padding: var(--spacing-xl) var(--spacing-md);
      box-shadow: var(--shadow-sm);
    }

    .consent-header-content {
      max-width: var(--container-md);
      margin: 0 auto;
    }

    .consent-title {
      font-size: var(--font-size-2xl);
      font-weight: var(--font-weight-bold);
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
    }

    .consent-subtitle {
      font-size: var(--font-size-base);
      color: var(--text-secondary);
    }

    .consent-main {
      flex: 1;
      padding: var(--spacing-2xl) var(--spacing-md);
    }

    .consent-content {
      max-width: var(--container-md);
      margin: 0 auto;
    }

    .policy-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-xl);
    }

    .policy-section {
      margin-bottom: var(--spacing-xl);
    }

    .policy-section:last-child {
      margin-bottom: 0;
    }

    .policy-heading {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
      margin-bottom: var(--spacing-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .policy-icon {
      font-size: var(--font-size-xl);
    }

    .policy-text {
      font-size: var(--font-size-base);
      color: var(--text-secondary);
      line-height: var(--line-height-relaxed);
      margin-bottom: var(--spacing-md);
    }

    .policy-list {
      list-style: none;
      padding-left: 0;
    }

    .policy-list li {
      position: relative;
      padding-left: var(--spacing-lg);
      margin-bottom: var(--spacing-sm);
      color: var(--text-secondary);
      line-height: var(--line-height-relaxed);
    }

    .policy-list li::before {
      content: '✓';
      position: absolute;
      left: 0;
      color: var(--color-secondary);
      font-weight: var(--font-weight-bold);
    }

    .consent-checkbox-card {
      background: var(--color-primary-light);
      border: var(--border-width-thick) solid var(--color-primary);
      border-radius: var(--radius-lg);
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-xl);
    }

    .consent-checkbox-wrapper {
      display: flex;
      align-items: flex-start;
      gap: var(--spacing-md);
      cursor: pointer;
      user-select: none;
    }

    .consent-checkbox-input {
      width: 24px;
      height: 24px;
      min-width: 24px;
      margin-top: 2px;
      cursor: pointer;
      accent-color: var(--color-primary);
    }

    .consent-checkbox-label {
      flex: 1;
      font-size: var(--font-size-base);
      line-height: var(--line-height-relaxed);
      color: var(--text-primary);
    }

    .consent-checkbox-label strong {
      font-weight: var(--font-weight-semibold);
    }

    .consent-actions {
      display: flex;
      gap: var(--spacing-md);
      flex-wrap: wrap;
    }

    .consent-actions .btn {
      flex: 1;
      min-width: 150px;
    }

    .error-message {
      display: none;
      padding: var(--spacing-md);
      background: #FFF1F0;
      border: var(--border-width) solid var(--color-error);
      border-radius: var(--radius-md);
      color: #CF1322;
      font-size: var(--font-size-sm);
      margin-bottom: var(--spacing-lg);
    }

    .error-message.show {
      display: block;
    }

    @media (max-width: 768px) {
      .consent-actions {
        flex-direction: column;
      }

      .consent-actions .btn {
        width: 100%;
      }
    }

    /* Checkbox animation */
    @keyframes checkboxPulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    .consent-checkbox-card.checked {
      animation: checkboxPulse 0.3s ease;
    }
  </style>
</head>
<body>
  <div class="consent-page">
    <!-- Header -->
    <header class="consent-header">
      <div class="consent-header-content">
        <h1 class="consent-title">使用條款與隱私政策</h1>
        <p class="consent-subtitle">
          在開始測驗前,請仔細閱讀以下內容並給予同意
        </p>
      </div>
    </header>

    <!-- Main Content -->
    <main class="consent-main">
      <div class="consent-content">
        <!-- Error Message -->
        <div id="error-message" class="error-message"></div>

        <!-- Policy Card -->
        <div class="policy-card">
          <!-- Data Collection Section -->
          <div class="policy-section">
            <h2 class="policy-heading">
              <span class="policy-icon">📊</span>
              資料收集說明
            </h2>
            <p class="policy-text">
              我們僅收集完成測驗所需的最少資料,包含:
            </p>
            <ul class="policy-list">
              <li>您對 20 題問卷的作答結果 (1-5 分)</li>
              <li>測驗完成時間與日期</li>
              <li>匿名的會話 ID (用於結果查詢)</li>
            </ul>
            <p class="policy-text">
              <strong>我們不會收集:</strong> 姓名、電子郵件、電話號碼或任何個人識別資訊。
            </p>
          </div>

          <!-- Data Usage Section -->
          <div class="policy-section">
            <h2 class="policy-heading">
              <span class="policy-icon">🔒</span>
              資料使用與保護
            </h2>
            <p class="policy-text">
              您的資料受到嚴密保護,我們承諾:
            </p>
            <ul class="policy-list">
              <li>所有資料經過加密儲存</li>
              <li>僅用於生成您的優勢分析報告</li>
              <li>不會出售、轉讓或分享給第三方</li>
              <li>符合 GDPR 與 CCPA 隱私法規</li>
              <li>您可隨時要求刪除資料</li>
            </ul>
          </div>

          <!-- Data Retention Section -->
          <div class="policy-section">
            <h2 class="policy-heading">
              <span class="policy-icon">⏰</span>
              資料保存期限
            </h2>
            <p class="policy-text">
              測驗資料保存 <strong>30 天</strong>,之後自動刪除。<br>
              您可在測驗完成後 <strong>24 小時內</strong> 下載 PDF 報告。
            </p>
          </div>

          <!-- Rights Section -->
          <div class="policy-section">
            <h2 class="policy-heading">
              <span class="policy-icon">✋</span>
              您的權利
            </h2>
            <p class="policy-text">
              根據隱私法規,您有權:
            </p>
            <ul class="policy-list">
              <li>查看您的測驗資料</li>
              <li>要求更正錯誤資料</li>
              <li>要求刪除您的資料</li>
              <li>撤銷同意 (將無法使用服務)</li>
            </ul>
          </div>
        </div>

        <!-- Consent Checkbox -->
        <div id="consent-checkbox-card" class="consent-checkbox-card">
          <label class="consent-checkbox-wrapper">
            <input
              type="checkbox"
              id="consent-checkbox"
              class="consent-checkbox-input"
              aria-label="同意使用條款與隱私政策"
            >
            <span class="consent-checkbox-label">
              我已詳細閱讀並<strong>完全理解</strong>以上內容,同意本測驗收集、使用與處理我的作答資料,
              並明白我可隨時撤銷同意。我確認我已年滿 18 歲或已獲得法定監護人同意。
            </span>
          </label>
        </div>

        <!-- Actions -->
        <div class="consent-actions">
          <button class="btn btn-outline" onclick="goBack()">
            返回首頁
          </button>
          <button id="agree-button" class="btn btn-primary" disabled onclick="handleAgree()">
            同意並繼續
          </button>
        </div>
      </div>
    </main>
  </div>

  <script type="module">
    import { storage } from '/js/storage.js';
    import { api, APIError } from '/js/api.js';

    // Elements
    const checkbox = document.getElementById('consent-checkbox');
    const agreeButton = document.getElementById('agree-button');
    const checkboxCard = document.getElementById('consent-checkbox-card');
    const errorMessage = document.getElementById('error-message');

    // Enable/disable button based on checkbox
    checkbox.addEventListener('change', (e) => {
      agreeButton.disabled = !e.target.checked;

      if (e.target.checked) {
        checkboxCard.classList.add('checked');
        setTimeout(() => {
          checkboxCard.classList.remove('checked');
        }, 300);
      }
    });

    // Go back to home
    window.goBack = function() {
      if (checkbox.checked) {
        if (confirm('您確定要返回首頁嗎? 將需要重新同意條款。')) {
          window.location.href = '/index.html';
        }
      } else {
        window.location.href = '/index.html';
      }
    };

    // Handle agree and continue
    window.handleAgree = async function() {
      if (!checkbox.checked) {
        showError('請勾選同意條款');
        return;
      }

      try {
        // Disable button to prevent double submission
        agreeButton.disabled = true;
        agreeButton.textContent = '處理中...';

        // Submit consent to API
        const response = await api.submitConsent({
          agreed: true,
          user_agent: navigator.userAgent,
          ip_address: null, // Backend will capture this
          consent_version: "v1.0"
        });

        // Save consent ID as session ID (temporary until session API is implemented)
        const consentId = response.data.consent_id;
        storage.saveSession(consentId);
        storage.saveConsent(true);

        // Redirect to assessment page
        window.location.href = '/pages/assessment.html';
      } catch (error) {
        console.error('Consent submission error:', error);

        if (error instanceof APIError) {
          showError(`API 錯誤: ${error.message}`);
        } else {
          showError('發生錯誤,請稍後再試');
        }

        // Re-enable button
        agreeButton.disabled = false;
        agreeButton.textContent = '同意並繼續';
      }
    };

    // Show error message
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.add('show');

      setTimeout(() => {
        errorMessage.classList.remove('show');
      }, 5000);
    }

    // Check if user already has consent
    window.addEventListener('DOMContentLoaded', () => {
      if (storage.hasConsent() && storage.hasValidSession()) {
        if (confirm('您已同意過條款,是否直接進入測驗?')) {
          window.location.href = '/pages/assessment.html';
        } else {
          // Clear old session
          storage.clearSession();
        }
      }
    });
  </script>
</body>
</html>
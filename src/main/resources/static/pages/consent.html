<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä½¿ç”¨æ¢æ¬¾èˆ‡åŒæ„ - Gallup å„ªå‹¢æ¸¬é©—</title>

  <link rel="stylesheet" href="/css/variables.css">
  <link rel="stylesheet" href="/css/reset.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/animations.css">
  <link rel="stylesheet" href="/css/responsive.css">

  <style>
    .consent-page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: var(--bg-page);
    }

    .consent-header {
      background: var(--bg-card);
      padding: var(--spacing-xl) var(--spacing-md);
      box-shadow: var(--shadow-sm);
    }

    .consent-header-content {
      max-width: var(--container-md);
      margin: 0 auto;
    }

    .consent-title {
      font-size: var(--font-size-2xl);
      font-weight: var(--font-weight-bold);
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
    }

    .consent-subtitle {
      font-size: var(--font-size-base);
      color: var(--text-secondary);
    }

    .consent-main {
      flex: 1;
      padding: var(--spacing-2xl) var(--spacing-md);
    }

    .consent-content {
      max-width: var(--container-md);
      margin: 0 auto;
    }

    .policy-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-xl);
    }

    .policy-section {
      margin-bottom: var(--spacing-xl);
    }

    .policy-section:last-child {
      margin-bottom: 0;
    }

    .policy-heading {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
      margin-bottom: var(--spacing-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .policy-icon {
      font-size: var(--font-size-xl);
    }

    .policy-text {
      font-size: var(--font-size-base);
      color: var(--text-secondary);
      line-height: var(--line-height-relaxed);
      margin-bottom: var(--spacing-md);
    }

    .policy-list {
      list-style: none;
      padding-left: 0;
    }

    .policy-list li {
      position: relative;
      padding-left: var(--spacing-lg);
      margin-bottom: var(--spacing-sm);
      color: var(--text-secondary);
      line-height: var(--line-height-relaxed);
    }

    .policy-list li::before {
      content: 'âœ“';
      position: absolute;
      left: 0;
      color: var(--color-secondary);
      font-weight: var(--font-weight-bold);
    }

    .consent-checkbox-card {
      background: var(--color-primary-light);
      border: var(--border-width-thick) solid var(--color-primary);
      border-radius: var(--radius-lg);
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-xl);
    }

    .consent-checkbox-wrapper {
      display: flex;
      align-items: flex-start;
      gap: var(--spacing-md);
      cursor: pointer;
      user-select: none;
    }

    .consent-checkbox-input {
      width: 24px;
      height: 24px;
      min-width: 24px;
      margin-top: 2px;
      cursor: pointer;
      accent-color: var(--color-primary);
    }

    .consent-checkbox-label {
      flex: 1;
      font-size: var(--font-size-base);
      line-height: var(--line-height-relaxed);
      color: var(--text-primary);
    }

    .consent-checkbox-label strong {
      font-weight: var(--font-weight-semibold);
    }

    .consent-actions {
      display: flex;
      gap: var(--spacing-md);
      flex-wrap: wrap;
    }

    .consent-actions .btn {
      flex: 1;
      min-width: 150px;
    }

    .error-message {
      display: none;
      padding: var(--spacing-md);
      background: #FFF1F0;
      border: var(--border-width) solid var(--color-error);
      border-radius: var(--radius-md);
      color: #CF1322;
      font-size: var(--font-size-sm);
      margin-bottom: var(--spacing-lg);
    }

    .error-message.show {
      display: block;
    }

    @media (max-width: 768px) {
      .consent-actions {
        flex-direction: column;
      }

      .consent-actions .btn {
        width: 100%;
      }
    }

    /* Checkbox animation */
    @keyframes checkboxPulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    .consent-checkbox-card.checked {
      animation: checkboxPulse 0.3s ease;
    }
  </style>
</head>
<body>
  <div class="consent-page">
    <!-- Header -->
    <header class="consent-header">
      <div class="consent-header-content">
        <h1 class="consent-title">ä½¿ç”¨æ¢æ¬¾èˆ‡éš±ç§æ”¿ç­–</h1>
        <p class="consent-subtitle">
          åœ¨é–‹å§‹æ¸¬é©—å‰,è«‹ä»”ç´°é–±è®€ä»¥ä¸‹å…§å®¹ä¸¦çµ¦äºˆåŒæ„
        </p>
      </div>
    </header>

    <!-- Main Content -->
    <main class="consent-main">
      <div class="consent-content">
        <!-- Error Message -->
        <div id="error-message" class="error-message"></div>

        <!-- Policy Card -->
        <div class="policy-card">
          <!-- Data Collection Section -->
          <div class="policy-section">
            <h2 class="policy-heading">
              <span class="policy-icon">ğŸ“Š</span>
              è³‡æ–™æ”¶é›†èªªæ˜
            </h2>
            <p class="policy-text">
              æˆ‘å€‘åƒ…æ”¶é›†å®Œæˆæ¸¬é©—æ‰€éœ€çš„æœ€å°‘è³‡æ–™,åŒ…å«:
            </p>
            <ul class="policy-list">
              <li>æ‚¨å° 20 é¡Œå•å·çš„ä½œç­”çµæœ (1-5 åˆ†)</li>
              <li>æ¸¬é©—å®Œæˆæ™‚é–“èˆ‡æ—¥æœŸ</li>
              <li>åŒ¿åçš„æœƒè©± ID (ç”¨æ–¼çµæœæŸ¥è©¢)</li>
            </ul>
            <p class="policy-text">
              <strong>æˆ‘å€‘ä¸æœƒæ”¶é›†:</strong> å§“åã€é›»å­éƒµä»¶ã€é›»è©±è™Ÿç¢¼æˆ–ä»»ä½•å€‹äººè­˜åˆ¥è³‡è¨Šã€‚
            </p>
          </div>

          <!-- Data Usage Section -->
          <div class="policy-section">
            <h2 class="policy-heading">
              <span class="policy-icon">ğŸ”’</span>
              è³‡æ–™ä½¿ç”¨èˆ‡ä¿è­·
            </h2>
            <p class="policy-text">
              æ‚¨çš„è³‡æ–™å—åˆ°åš´å¯†ä¿è­·,æˆ‘å€‘æ‰¿è«¾:
            </p>
            <ul class="policy-list">
              <li>æ‰€æœ‰è³‡æ–™ç¶“éåŠ å¯†å„²å­˜</li>
              <li>åƒ…ç”¨æ–¼ç”Ÿæˆæ‚¨çš„å„ªå‹¢åˆ†æå ±å‘Š</li>
              <li>ä¸æœƒå‡ºå”®ã€è½‰è®“æˆ–åˆ†äº«çµ¦ç¬¬ä¸‰æ–¹</li>
              <li>ç¬¦åˆ GDPR èˆ‡ CCPA éš±ç§æ³•è¦</li>
              <li>æ‚¨å¯éš¨æ™‚è¦æ±‚åˆªé™¤è³‡æ–™</li>
            </ul>
          </div>

          <!-- Data Retention Section -->
          <div class="policy-section">
            <h2 class="policy-heading">
              <span class="policy-icon">â°</span>
              è³‡æ–™ä¿å­˜æœŸé™
            </h2>
            <p class="policy-text">
              æ¸¬é©—è³‡æ–™ä¿å­˜ <strong>30 å¤©</strong>,ä¹‹å¾Œè‡ªå‹•åˆªé™¤ã€‚<br>
              æ‚¨å¯åœ¨æ¸¬é©—å®Œæˆå¾Œ <strong>24 å°æ™‚å…§</strong> ä¸‹è¼‰ PDF å ±å‘Šã€‚
            </p>
          </div>

          <!-- Rights Section -->
          <div class="policy-section">
            <h2 class="policy-heading">
              <span class="policy-icon">âœ‹</span>
              æ‚¨çš„æ¬Šåˆ©
            </h2>
            <p class="policy-text">
              æ ¹æ“šéš±ç§æ³•è¦,æ‚¨æœ‰æ¬Š:
            </p>
            <ul class="policy-list">
              <li>æŸ¥çœ‹æ‚¨çš„æ¸¬é©—è³‡æ–™</li>
              <li>è¦æ±‚æ›´æ­£éŒ¯èª¤è³‡æ–™</li>
              <li>è¦æ±‚åˆªé™¤æ‚¨çš„è³‡æ–™</li>
              <li>æ’¤éŠ·åŒæ„ (å°‡ç„¡æ³•ä½¿ç”¨æœå‹™)</li>
            </ul>
          </div>
        </div>

        <!-- Consent Checkbox -->
        <div id="consent-checkbox-card" class="consent-checkbox-card">
          <label class="consent-checkbox-wrapper">
            <input
              type="checkbox"
              id="consent-checkbox"
              class="consent-checkbox-input"
              aria-label="åŒæ„ä½¿ç”¨æ¢æ¬¾èˆ‡éš±ç§æ”¿ç­–"
            >
            <span class="consent-checkbox-label">
              æˆ‘å·²è©³ç´°é–±è®€ä¸¦<strong>å®Œå…¨ç†è§£</strong>ä»¥ä¸Šå…§å®¹,åŒæ„æœ¬æ¸¬é©—æ”¶é›†ã€ä½¿ç”¨èˆ‡è™•ç†æˆ‘çš„ä½œç­”è³‡æ–™,
              ä¸¦æ˜ç™½æˆ‘å¯éš¨æ™‚æ’¤éŠ·åŒæ„ã€‚æˆ‘ç¢ºèªæˆ‘å·²å¹´æ»¿ 18 æ­²æˆ–å·²ç²å¾—æ³•å®šç›£è­·äººåŒæ„ã€‚
            </span>
          </label>
        </div>

        <!-- Actions -->
        <div class="consent-actions">
          <button class="btn btn-outline" onclick="goBack()">
            è¿”å›é¦–é 
          </button>
          <button id="agree-button" class="btn btn-primary" disabled onclick="handleAgree()">
            åŒæ„ä¸¦ç¹¼çºŒ
          </button>
        </div>
      </div>
    </main>
  </div>

  <script type="module">
    import { storage } from '/js/storage.js';
    import { api, APIError } from '/js/api.js';

    // Elements
    const checkbox = document.getElementById('consent-checkbox');
    const agreeButton = document.getElementById('agree-button');
    const checkboxCard = document.getElementById('consent-checkbox-card');
    const errorMessage = document.getElementById('error-message');

    // Enable/disable button based on checkbox
    checkbox.addEventListener('change', (e) => {
      agreeButton.disabled = !e.target.checked;

      if (e.target.checked) {
        checkboxCard.classList.add('checked');
        setTimeout(() => {
          checkboxCard.classList.remove('checked');
        }, 300);
      }
    });

    // Go back to home
    window.goBack = function() {
      if (checkbox.checked) {
        if (confirm('æ‚¨ç¢ºå®šè¦è¿”å›é¦–é å—? å°‡éœ€è¦é‡æ–°åŒæ„æ¢æ¬¾ã€‚')) {
          window.location.href = '/index.html';
        }
      } else {
        window.location.href = '/index.html';
      }
    };

    // Handle agree and continue
    window.handleAgree = async function() {
      if (!checkbox.checked) {
        showError('è«‹å‹¾é¸åŒæ„æ¢æ¬¾');
        return;
      }

      try {
        // Disable button to prevent double submission
        agreeButton.disabled = true;
        agreeButton.textContent = 'è™•ç†ä¸­...';

        // Submit consent to API
        const response = await api.submitConsent({
          agreed: true,
          user_agent: navigator.userAgent,
          ip_address: null, // Backend will capture this
          consent_version: "v1.0"
        });

        // Save consent ID as session ID (temporary until session API is implemented)
        const consentId = response.data.consent_id;
        storage.saveSession(consentId);
        storage.saveConsent(true);

        // Redirect to assessment page
        window.location.href = '/pages/assessment.html';
      } catch (error) {
        console.error('Consent submission error:', error);

        if (error instanceof APIError) {
          showError(`API éŒ¯èª¤: ${error.message}`);
        } else {
          showError('ç™¼ç”ŸéŒ¯èª¤,è«‹ç¨å¾Œå†è©¦');
        }

        // Re-enable button
        agreeButton.disabled = false;
        agreeButton.textContent = 'åŒæ„ä¸¦ç¹¼çºŒ';
      }
    };

    // Show error message
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.add('show');

      setTimeout(() => {
        errorMessage.classList.remove('show');
      }, 5000);
    }

    // Check if user already has consent
    window.addEventListener('DOMContentLoaded', () => {
      if (storage.hasConsent() && storage.hasValidSession()) {
        if (confirm('æ‚¨å·²åŒæ„éæ¢æ¬¾,æ˜¯å¦ç›´æ¥é€²å…¥æ¸¬é©—?')) {
          window.location.href = '/pages/assessment.html';
        } else {
          // Clear old session
          storage.clearSession();
        }
      }
    });
  </script>
</body>
</html>
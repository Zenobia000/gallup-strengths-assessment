<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å„ªå‹¢è©•æ¸¬çµæœ - å„ªå‹¢è©•æ¸¬ç³»çµ± v4.1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* é ˜åŸŸè‰²å½©ï¼ˆä¸»è¦ï¼‰ */
            --executing: #7C3AED;        /* åŸ·è¡ŒåŠ› - ç´«è‰² */
            --influencing: #F59E0B;      /* å½±éŸ¿åŠ› - æ©™è‰² */
            --relationship: #0EA5E9;     /* é—œä¿‚å»ºç«‹ - è—è‰² */
            --strategic: #10B981;        /* æˆ°ç•¥æ€ç¶­ - ç¶ è‰² */

            /* ä¸­æ€§è‰²èª¿ */
            --neutral-50: #F9FAFB;
            --neutral-100: #F3F4F6;
            --neutral-200: #E5E7EB;
            --neutral-500: #6B7280;
            --neutral-600: #4B5563;
            --neutral-700: #374151;
            --neutral-900: #111827;

            /* åŠŸèƒ½è‰²å½© */
            --emerald-500: #10B981;
            --emerald-600: #059669;
            --emerald-50: #ECFDF5;
            --emerald-100: #D1FAE5;
            --sky-50: #F0F9FF;
            --red-500: #EF4444;
            --amber-500: #F59E0B;

            /* èªç¾©è‰²å½© */
            --success: var(--emerald-500);
            --warning: var(--amber-500);
            --error: var(--red-500);
            --info: var(--relationship);

            /* é™°å½±ç³»çµ± */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            background: var(--neutral-50);
            min-height: 100vh;
            color: var(--neutral-900);
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: white;
            border-bottom: 1px solid var(--neutral-200);
        }

        .header-container {
            max-width: 72rem;
            margin: 0 auto;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .brand-icon {
            width: 2.25rem;
            height: 2.25rem;
            border-radius: 0.75rem;
            background: var(--strategic);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }

        .brand-text {
            display: flex;
            flex-direction: column;
        }

        .brand-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--neutral-900);
        }

        .brand-subtitle {
            font-size: 0.75rem;
            color: var(--neutral-500);
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border-radius: 0.75rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
        }

        .btn-secondary {
            background: transparent;
            color: var(--neutral-700);
            border: 1px solid var(--neutral-200);
        }

        .btn-secondary:hover {
            background: var(--neutral-50);
            border-color: var(--neutral-300);
        }

        .btn-primary {
            background: var(--neutral-900);
            color: white;
        }

        .btn-primary:hover {
            background: var(--neutral-700);
        }

        /* Main container */
        .main-container {
            max-width: 72rem;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        /* Session strip */
        .session-strip {
            background: white;
            border: 1px solid var(--neutral-200);
            border-radius: 1rem;
            padding: 1rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .session-info {
            font-size: 0.875rem;
        }

        .session-id {
            font-family: monospace;
            font-weight: 600;
        }

        .confidence-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .confidence-bar {
            width: 8rem;
            height: 0.5rem;
            background: var(--neutral-100);
            border-radius: 9999px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: var(--emerald-500);
            border-radius: 9999px;
            transition: width 0.5s ease;
        }

        /* KPI Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .kpi-card {
            background: white;
            border: 1px solid var(--neutral-200);
            border-radius: 1rem;
            padding: 1rem;
            box-shadow: var(--shadow-sm);
        }

        .kpi-title {
            font-size: 0.75rem;
            color: var(--neutral-500);
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 600;
            margin-top: 0.25rem;
        }

        .kpi-desc {
            font-size: 0.75rem;
            color: var(--neutral-500);
            margin-top: 0.25rem;
        }

        /* Narrative section */
        .narrative-section {
            background: linear-gradient(to bottom right, var(--emerald-50), var(--sky-50));
            border: 1px solid var(--emerald-100);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .narrative-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .narrative-text {
            color: var(--neutral-700);
            line-height: 1.7;
        }

        /* DNA Helix */
        .helix-section {
            background: white;
            border: 1px solid var(--neutral-200);
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .helix-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .helix-title {
            font-size: 0.875rem;
            font-weight: 600;
        }

        .domain-legend {
            display: flex;
            gap: 0.75rem;
            font-size: 0.75rem;
            color: var(--neutral-600);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .legend-color {
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 0.125rem;
        }

        /* Tier Lists */
        .tier-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .tier-card {
            background: white;
            border: 1px solid var(--neutral-200);
            border-radius: 1rem;
            padding: 1rem;
        }

        .tier-title {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .tier-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .tier-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0;
        }

        .tier-item:not(:last-child) {
            border-bottom: 1px solid var(--neutral-100);
        }

        .tier-content {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dimension-dot {
            width: 0.625rem;
            height: 0.625rem;
            border-radius: 50%;
        }

        .dimension-name {
            font-size: 0.875rem;
        }

        .domain-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 9999px;
            padding: 0.125rem 0.5rem;
            font-size: 0.625rem;
            font-weight: 500;
        }

        .badge-dot {
            width: 0.5rem;
            height: 0.5rem;
            border-radius: 50%;
        }

        .percentile-value {
            font-size: 0.75rem;
            color: var(--neutral-500);
        }

        /* Action Grid */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .action-card {
            background: white;
            border: 1px solid var(--neutral-200);
            border-radius: 1rem;
            padding: 1rem;
        }

        .action-title {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .prototype-name {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .prototype-hint {
            font-size: 0.875rem;
            color: var(--neutral-600);
            margin-bottom: 0.75rem;
        }

        .prototype-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--neutral-700);
        }

        .prototype-disclaimer {
            font-size: 0.75rem;
            color: var(--neutral-500);
            margin-top: 0.75rem;
        }

        .action-list {
            list-style: decimal;
            padding-left: 1.25rem;
            margin-bottom: 1rem;
        }

        .action-list li {
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-action {
            background: var(--emerald-600);
            color: white;
            font-size: 0.875rem;
        }

        .btn-action:hover {
            background: var(--emerald-500);
        }

        /* Method section */
        .method-section {
            background: white;
            border: 1px solid var(--neutral-200);
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .method-title {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .method-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--neutral-700);
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 2.5rem 0;
            font-size: 0.75rem;
            color: var(--neutral-500);
        }

        /* Loading state */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            width: 3rem;
            height: 3rem;
            border: 4px solid var(--neutral-100);
            border-top-color: var(--strategic);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 1rem;
            }

            .session-strip {
                flex-direction: column;
                align-items: flex-start;
            }

            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .tier-grid {
                grid-template-columns: 1fr;
            }

            .action-grid {
                grid-template-columns: 1fr;
            }

            .prototype-grid {
                grid-template-columns: 1fr;
            }

            .method-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading state -->
    <div class="loading" id="loadingState">
        <div class="spinner"></div>
        <p>æ­£åœ¨åˆ†ææ‚¨çš„è©•æ¸¬çµæœ...</p>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="brand-info">
                <div class="brand-icon">ğŸ¯</div>
                <div class="brand-text">
                    <div class="brand-title">å„ªå‹¢è©•æ¸¬ç³»çµ± v4.1</div>
                    <div class="brand-subtitle">Thurstonian IRT â€¢ å¸¸æ¨¡åŒ–ç™¾åˆ†ä½</div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="retakeAssessment()">é‡æ–°æ¸¬è©¦</button>
                <button class="btn btn-secondary" onclick="shareReport()">åˆ†äº«</button>
                <button class="btn btn-primary" onclick="downloadPDF()">ä¸‹è¼‰å ±å‘Š PDF</button>
            </div>
        </div>
    </header>

    <!-- Main content -->
    <main class="main-container">
        <!-- Session strip -->
        <div class="session-strip">
            <div class="session-info">
                Sessionï¼š<span class="session-id" id="sessionId">è¼‰å…¥ä¸­...</span>
            </div>
            <div class="session-info" id="testTime">æ¸¬è©¦æ™‚é–“ï¼šè¼‰å…¥ä¸­...</div>
            <div class="confidence-container">
                <span>ç½®ä¿¡åº¦</span>
                <div class="confidence-bar">
                    <div class="confidence-fill" id="confidenceFill" style="width: 0%"></div>
                </div>
                <span class="confidence-text" id="confidenceText">0%</span>
            </div>
        </div>

        <!-- KPI Summary -->
        <section class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-title">ä¸»å°æ‰å¹¹</div>
                <div class="kpi-value" id="dominantCount">0</div>
                <div class="kpi-desc">>75 ç™¾åˆ†ä½</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">æ”¯æ´æ‰å¹¹</div>
                <div class="kpi-value" id="supportingCount">0</div>
                <div class="kpi-desc">25â€“75 ç™¾åˆ†ä½</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">å¾…ç®¡ç†é ˜åŸŸ</div>
                <div class="kpi-value" id="lesserCount">0</div>
                <div class="kpi-desc"><25 ç™¾åˆ†ä½</div>
            </div>
        </section>

        <!-- Narrative -->
        <section class="narrative-section">
            <div class="narrative-title">å€‹äººåŒ–æ‘˜è¦</div>
            <p class="narrative-text" id="narrativeText">æ­£åœ¨ç”Ÿæˆæ‚¨çš„å€‹äººåŒ–æ‘˜è¦...</p>
        </section>

        <!-- DNA Helix -->
        <section class="helix-section">
            <div class="helix-header">
                <div class="helix-title">Strength DNA é›™è»Œè‰²å¸¶ï¼ˆ1â†’12 å¼·åº¦æ’åºï¼‰</div>
                <div class="domain-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--executing)"></div>
                        <span>åŸ·è¡ŒåŠ›</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--influencing)"></div>
                        <span>å½±éŸ¿åŠ›</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--relationship)"></div>
                        <span>é—œä¿‚å»ºç«‹</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--strategic)"></div>
                        <span>æˆ°ç•¥æ€ç¶­</span>
                    </div>
                </div>
            </div>
            <svg id="helixSVG" viewBox="0 0 960 180" style="width: 100%; height: auto;">
                <!-- Will be populated by JavaScript -->
            </svg>
        </section>

        <!-- Tier Lists -->
        <section class="tier-grid">
            <div class="tier-card">
                <div class="tier-title">ä¸»å°æ‰å¹¹ (Dominant)</div>
                <ul class="tier-list" id="dominantList">
                    <!-- Will be populated by JavaScript -->
                </ul>
            </div>
            <div class="tier-card">
                <div class="tier-title">æ”¯æ´æ‰å¹¹ (Supporting)</div>
                <ul class="tier-list" id="supportingList">
                    <!-- Will be populated by JavaScript -->
                </ul>
            </div>
            <div class="tier-card">
                <div class="tier-title">è¼ƒå¼±æ‰å¹¹ (Lesser)</div>
                <ul class="tier-list" id="lesserList">
                    <!-- Will be populated by JavaScript -->
                </ul>
            </div>
        </section>

        <!-- Action Grid -->
        <section class="action-grid">
            <div class="action-card">
                <div class="action-title">è·æ¥­åŸå‹åƒè€ƒï¼ˆBetaï¼‰</div>
                <div class="prototype-name" id="prototypeName">ç³»çµ±å»ºæ§‹è€…</div>
                <div class="prototype-hint" id="prototypeHint">æŠŠè¤‡é›œè½‰ç‚ºçµæ§‹ï¼Œå¯å°æ‡‰ INTJ/ISTJ åŸå‹</div>
                <div class="prototype-grid">
                    <div>å»ºè­°è·ä½ï¼šç”¢å“ç¶“ç†ã€è³‡æ–™ç§‘å­¸å®¶ã€è§£æ±ºæ–¹æ¡ˆæ¶æ§‹å¸«</div>
                    <div>é—œéµæƒ…å¢ƒï¼šç­–ç•¥è¦åŠƒã€è·¨éƒ¨é–€å”ä½œã€æ±ºç­–æ”¯æ´</div>
                    <div>ç›²é»æé†’ï¼šé¿å…éåº¦åˆ†æï¼Œè¨­å®šæ±ºç­–æˆªæ­¢é»</div>
                    <div>æ­æª”å»ºè­°ï¼šé…å°å¼·ã€å½±éŸ¿åŠ›/é—œä¿‚ã€å¤¥ä¼´å…±åŒæ¨é€²</div>
                </div>
                <div class="prototype-disclaimer">* åƒè€ƒè‡ªä½ çš„ä¸»å°æ‰å¹¹çµ„åˆï¼Œä½œç‚ºæ¢ç´¢ç·šç´¢ï¼Œéå®šæ€§æ¨™ç±¤ã€‚</div>
            </div>
            <div class="action-card">
                <div class="action-title">ä¸‹ä¸€æ­¥è¡Œå‹•</div>
                <ol class="action-list">
                    <li>ä¸‹è¼‰ PDF å ±å‘Šï¼ˆå¯åŠ å…¥å±¥æ­·æˆ–å€‹äººé ï¼‰ã€‚</li>
                    <li>å»ºç«‹ 30/60/90 å¤©è¡Œå‹•è¨ˆç•«ï¼šé¸æ“‡ 1â€“2 å€‹ä¸»å°æ‰å¹¹ï¼Œç¶å®šæƒ…å¢ƒèˆ‡ç”¢å‡ºã€‚</li>
                    <li>é‚€è«‹ 1 åäº’è£œå¤¥ä¼´ï¼ˆå½±éŸ¿åŠ›/é—œä¿‚ï¼‰å…±åŒé©—è­‰ä¸€å€‹ PoCã€‚</li>
                </ol>
                <div class="action-buttons">
                    <button class="btn btn-action" onclick="generateActionPlan()">ç”Ÿæˆè¡Œå‹•è¨ˆç•«</button>
                    <button class="btn btn-secondary" onclick="shareWithManager()">èˆ‡ä¸»ç®¡åˆ†äº«</button>
                </div>
            </div>
        </section>

        <!-- Method explanation -->
        <section class="method-section">
            <div class="method-title">æ–¹æ³•è«–èˆ‡è§£è®€é–€æª»</div>
            <div class="method-grid">
                <div>Thurstonian IRTï¼šç”±å¼·åˆ¶é¸æ“‡å®Œæ•´ä½œç­”æ¨¡å¼æ¨ä¼° 12 ç¶­åº¦æ½›åœ¨åˆ†æ•¸ Î¸ã€‚</div>
                <div>å¸¸æ¨¡ç™¾åˆ†ä½ï¼šèˆ‡ä»£è¡¨æ€§æ¨£æœ¬å°æ¯”ï¼Œæ”¯æŒè·¨äººæ¯”è¼ƒï¼ˆNormativeï¼‰ã€‚</div>
                <div>åˆ†å±¤è¦å‰‡ï¼šPR>75 ä¸»å°ï¼›PR 25â€“75 æ”¯æ´ï¼›PR<25 è¼ƒå¼±ã€‚</div>
                <div>ç½®ä¿¡åº¦ï¼šåŸºæ–¼é¡Œé …è³‡è¨Šé‡èˆ‡æ”¶æ–‚æº–å‰‡è¨ˆç®—ï¼ˆå¯è¦‹ä¸Šæ–¹æŒ‡ç¤ºæ¢ï¼‰ã€‚</div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        Â© 2025 Strengths Report UI v4.1 â€” Demo Wireframe
    </footer>

    <script>
        // Domain metadata
        const DOMAIN_META = {
            executing: { zh: "åŸ·è¡ŒåŠ›", en: "EXECUTING", color: "#7C3AED" },
            influencing: { zh: "å½±éŸ¿åŠ›", en: "INFLUENCING", color: "#F59E0B" },
            relationship: { zh: "é—œä¿‚å»ºç«‹", en: "RELATIONSHIP", color: "#0EA5E9" },
            strategic: { zh: "æˆ°ç•¥æ€ç¶­", en: "STRATEGIC", color: "#10B981" }
        };

        // Demo data (will be replaced by API call)
        const demoData = {
            sessionId: "S-2025-10-01-XYZ",
            testedAt: "2025-10-01 10:32",
            confidence: 0.93,
            topNarrative: "ä½ çš„ä¸»å°å¤©è³¦èšç„¦æ–¼ã€æˆ°ç•¥æ€ç¶­ã€èˆ‡ã€åŸ·è¡ŒåŠ›ã€ï¼Œæ“…é•·å°‡è¤‡é›œè³‡è¨Šè½‰è­¯ç‚ºå¯è½åœ°çš„è·¯ç·šåœ–ã€‚",
            dimensions: [
                { id: "T1", name: "çµæ§‹åŒ–åŸ·è¡Œ", domain: "executing", percentile: 88 },
                { id: "T2", name: "å“è³ªèˆ‡å®Œå‚™", domain: "executing", percentile: 61 },
                { id: "T3", name: "æ¢ç´¢èˆ‡å‰µæ–°", domain: "strategic", percentile: 72 },
                { id: "T4", name: "åˆ†æèˆ‡æ´å¯Ÿ", domain: "strategic", percentile: 91 },
                { id: "T5", name: "å½±éŸ¿èˆ‡å€¡è­°", domain: "influencing", percentile: 69 },
                { id: "T6", name: "å”ä½œèˆ‡å…±å¥½", domain: "relationship", percentile: 54 },
                { id: "T7", name: "å®¢æˆ¶å°å‘", domain: "relationship", percentile: 47 },
                { id: "T8", name: "å­¸ç¿’èˆ‡æˆé•·", domain: "strategic", percentile: 86 },
                { id: "T9", name: "ç´€å¾‹èˆ‡ä¿¡ä»»", domain: "executing", percentile: 78 },
                { id: "T10", name: "å£“åŠ›èª¿ç¯€", domain: "relationship", percentile: 58 },
                { id: "T11", name: "è¡çªæ•´åˆ", domain: "relationship", percentile: 34 },
                { id: "T12", name: "è²¬ä»»èˆ‡ç•¶è²¬", domain: "executing", percentile: 22 }
            ]
        };

        // Tier processing function
        function processTiers(dimensions) {
            const byTier = { dominant: [], supporting: [], lesser: [] };
            const sorted = [...dimensions].sort((a, b) => b.percentile - a.percentile);

            for (const d of sorted) {
                if (d.percentile > 75) byTier.dominant.push(d);
                else if (d.percentile < 25) byTier.lesser.push(d);
                else byTier.supporting.push(d);
            }

            return { byTier, sorted };
        }

        // Generate narrative based on top dimensions
        function generateNarrative(byTier) {
            const topDomains = byTier.dominant.map(d => d.domain);
            const domainCounts = {};
            topDomains.forEach(domain => {
                domainCounts[domain] = (domainCounts[domain] || 0) + 1;
            });

            const primaryDomain = Object.keys(domainCounts).reduce((a, b) =>
                domainCounts[a] > domainCounts[b] ? a : b
            );

            const domainNarratives = {
                strategic: "ä½ çš„ä¸»å°å¤©è³¦èšç„¦æ–¼ã€æˆ°ç•¥æ€ç¶­ã€é ˜åŸŸï¼Œæ“…é•·åˆ†æè¤‡é›œæƒ…æ³ä¸¦åˆ¶å®šæœ‰æ•ˆç­–ç•¥ã€‚",
                executing: "ä½ çš„ä¸»å°å¤©è³¦é›†ä¸­åœ¨ã€åŸ·è¡ŒåŠ›ã€é ˜åŸŸï¼Œå…·å‚™å°‡æƒ³æ³•è½‰åŒ–ç‚ºå…·é«”æˆæœçš„èƒ½åŠ›ã€‚",
                influencing: "ä½ çš„ä¸»å°å¤©è³¦é«”ç¾åœ¨ã€å½±éŸ¿åŠ›ã€é ˜åŸŸï¼Œå–„æ–¼æ¿€å‹µä»–äººä¸¦æ¨å‹•è®Šé©ã€‚",
                relationship: "ä½ çš„ä¸»å°å¤©è³¦å±•ç¾åœ¨ã€é—œä¿‚å»ºç«‹ã€é ˜åŸŸï¼Œæ“…é•·å»ºç«‹é€£çµèˆ‡å”ä½œã€‚"
            };

            return domainNarratives[primaryDomain] || demoData.topNarrative;
        }

        // Generate prototype based on API data or fallback to local logic
        function generatePrototype(byTier, apiData = null) {
            // If API provides prototype data, use it
            if (apiData && apiData.career_prototype) {
                return {
                    name: apiData.career_prototype.prototype_name,
                    hint: apiData.career_prototype.prototype_hint
                };
            }

            // Fallback to original logic if API data is not available
            const top4 = byTier.dominant.slice(0, 4);
            const hasStrategic = top4.some(d => d.domain === "strategic");
            const hasExecuting = top4.some(d => d.domain === "executing");
            const hasInfluencing = top4.some(d => d.domain === "influencing");
            const hasRelationship = top4.some(d => d.domain === "relationship");

            if (hasStrategic && hasExecuting) {
                return {
                    name: "ç³»çµ±å»ºæ§‹è€…",
                    hint: "æŠŠè¤‡é›œè½‰ç‚ºçµæ§‹ï¼Œå¯å°æ‡‰ INTJ/ISTJ åŸå‹"
                };
            } else if (hasInfluencing && hasRelationship) {
                return {
                    name: "é—œä¿‚æ‹“å±•è€…",
                    hint: "æ“…é•·é€£çµèˆ‡å€¡è­°ï¼Œå¯å°æ‡‰ ENFP/ENFJ åŸå‹"
                };
            } else if (hasStrategic && hasInfluencing) {
                return {
                    name: "ç­–ç•¥æ¨å‹•è€…",
                    hint: "çµåˆé è¦‹èˆ‡åŸ·è¡Œï¼Œå¯å°æ‡‰ ENTJ/ENTP åŸå‹"
                };
            } else {
                return {
                    name: "å‡è¡¡æ•´åˆè€…",
                    hint: "è·¨åŸŸå”åŒï¼Œé¢å‘å¤šè·èƒ½å ´æ™¯"
                };
            }
        }

        // Create helix visualization
        function createHelixVisualization(dimensions) {
            const svg = document.getElementById('helixSVG');
            const width = 960;
            const height = 180;
            const padding = 24;
            const laneY1 = 60;
            const laneY2 = 120;
            const len = Math.max(2, dimensions.length);
            const step = (width - padding * 2) / (len - 1);

            // Clear existing content
            svg.innerHTML = '';

            // Create lanes
            const lane1 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            lane1.setAttribute('d', `M ${padding} ${laneY1} L ${width - padding} ${laneY1}`);
            lane1.setAttribute('stroke', '#E5E7EB');
            lane1.setAttribute('stroke-width', '2');
            svg.appendChild(lane1);

            const lane2 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            lane2.setAttribute('d', `M ${padding} ${laneY2} L ${width - padding} ${laneY2}`);
            lane2.setAttribute('stroke', '#E5E7EB');
            lane2.setAttribute('stroke-width', '2');
            svg.appendChild(lane2);

            // Create nodes and connections
            dimensions.forEach((d, i) => {
                const x = padding + i * step;
                const y = i % 2 === 0 ? laneY1 : laneY2;
                const color = DOMAIN_META[d.domain].color;
                const radius = 7 + (d.percentile / 100) * 6;

                // Connection line
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', x);
                line.setAttribute('y1', y);
                line.setAttribute('x2', x);
                line.setAttribute('y2', y === laneY1 ? laneY2 : laneY1);
                line.setAttribute('stroke', color);
                line.setAttribute('stroke-opacity', '0.25');
                svg.appendChild(line);

                // Node circle
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', x);
                circle.setAttribute('cy', y);
                circle.setAttribute('r', radius);
                circle.setAttribute('fill', color);
                circle.setAttribute('fill-opacity', '0.9');

                // Add hover title
                const title = document.createElementNS('http://www.w3.org/2000/svg', 'title');
                title.textContent = `${d.name} (${d.percentile}%)`;
                circle.appendChild(title);

                svg.appendChild(circle);
            });
        }

        // Populate tier list
        function populateTierList(listId, items) {
            const list = document.getElementById(listId);
            list.innerHTML = '';

            items.forEach(d => {
                const li = document.createElement('li');
                li.className = 'tier-item';

                li.innerHTML = `
                    <div class="tier-content">
                        <div class="dimension-dot" style="background: ${DOMAIN_META[d.domain].color}"></div>
                        <span class="dimension-name">${d.name}</span>
                        <div class="domain-badge" style="background: ${DOMAIN_META[d.domain].color}1A; color: ${DOMAIN_META[d.domain].color}">
                            <div class="badge-dot" style="background: ${DOMAIN_META[d.domain].color}"></div>
                            ${DOMAIN_META[d.domain].zh}
                        </div>
                    </div>
                    <span class="percentile-value">PR ${d.percentile}</span>
                `;

                list.appendChild(li);
            });
        }

        // Load and display results
        async function loadResults() {
            try {
                document.getElementById('loadingState').classList.add('active');

                // Try to load from API first
                const sessionId = new URLSearchParams(window.location.search).get('session') ||
                                localStorage.getItem('currentSessionId');

                let data = demoData; // fallback to demo data

                if (sessionId) {
                    try {
                        // Try to fetch real data from API (correct v4 endpoint)
                        const apiBase = window.location.port === '3000' ? 'http://localhost:8004' : '';
                        const response = await fetch(`${apiBase}/api/v4/assessment/results/${sessionId}`);

                        if (response.ok) {
                            const apiData = await response.json();
                            // Transform API data to match our format
                            data = transformV4ApiData(apiData, sessionId);
                            console.log('Successfully loaded real data from v4 API:', data);
                        } else {
                            console.warn(`API returned ${response.status}: ${response.statusText}`);
                        }
                    } catch (error) {
                        console.warn('API call failed, using demo data:', error);
                    }
                }

                // Process the data
                const { byTier, sorted } = processTiers(data.dimensions);
                const narrative = data.topNarrative || generateNarrative(byTier);
                const prototype = generatePrototype(byTier, data);  // Pass API data

                // Update UI
                document.getElementById('sessionId').textContent = data.sessionId;
                document.getElementById('testTime').textContent = `æ¸¬è©¦æ™‚é–“ï¼š${data.testedAt}`;
                document.getElementById('confidenceFill').style.width = `${data.confidence * 100}%`;
                document.getElementById('confidenceText').textContent = `${Math.round(data.confidence * 100)}%`;

                document.getElementById('dominantCount').textContent = byTier.dominant.length;
                document.getElementById('supportingCount').textContent = byTier.supporting.length;
                document.getElementById('lesserCount').textContent = byTier.lesser.length;

                document.getElementById('narrativeText').textContent = narrative;

                // Update prototype information from API data
                const prototypeData = data.career_prototype || {
                    prototype_name: "ç³»çµ±å»ºæ§‹è€…",
                    prototype_hint: "æŠŠè¤‡é›œè½‰ç‚ºçµæ§‹ï¼Œå¯å°æ‡‰ INTJ/ISTJ åŸå‹",
                    suggested_roles: ["ç”¢å“ç¶“ç†", "è³‡æ–™ç§‘å­¸å®¶", "è§£æ±ºæ–¹æ¡ˆæ¶æ§‹å¸«"],
                    key_contexts: ["ç­–ç•¥è¦åŠƒ", "è·¨éƒ¨é–€å”ä½œ", "æ±ºç­–æ”¯æ´"],
                    blind_spots: ["é¿å…éåº¦åˆ†æ", "è¨­å®šæ±ºç­–æˆªæ­¢é»"],
                    partnership_suggestions: ["é…å°å¼·ã€å½±éŸ¿åŠ›/é—œä¿‚ã€å¤¥ä¼´å…±åŒæ¨é€²"],
                    mbti_correlation: "å¯å°æ‡‰ INTJ/ISTJ åŸå‹"
                };

                document.getElementById('prototypeName').textContent = prototypeData.prototype_name;
                document.getElementById('prototypeHint').textContent = prototypeData.prototype_hint;

                // Update prototype grid with dynamic data
                const prototypeGrid = document.querySelector('.prototype-grid');
                if (prototypeGrid) {
                    prototypeGrid.innerHTML = `
                        <div>å»ºè­°è·ä½ï¼š${prototypeData.suggested_roles.slice(0, 3).join('ã€')}</div>
                        <div>é—œéµæƒ…å¢ƒï¼š${prototypeData.key_contexts.slice(0, 3).join('ã€')}</div>
                        <div>ç›²é»æé†’ï¼š${prototypeData.blind_spots.slice(0, 2).join('ã€')}</div>
                        <div>æ­æª”å»ºè­°ï¼š${prototypeData.partnership_suggestions[0] || 'é…å°äº’è£œå¤¥ä¼´å…±åŒåˆä½œ'}</div>
                    `;
                }

                // Create visualizations
                createHelixVisualization(sorted);
                populateTierList('dominantList', byTier.dominant);
                populateTierList('supportingList', byTier.supporting);
                populateTierList('lesserList', byTier.lesser);

            } catch (error) {
                console.error('Error loading results:', error);
                alert('è¼‰å…¥çµæœæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
            } finally {
                document.getElementById('loadingState').classList.remove('active');
            }
        }

        // Transform v4 API data to our format
        function transformV4ApiData(apiData, sessionId) {
            const confidence = calculateConfidence(apiData.theta_scores);

            // Use Strength DNA data if available, otherwise fallback to norm_scores
            let dimensions;
            if (apiData.strength_dna && apiData.strength_dna.dna_data) {
                dimensions = mapDNADataToDimensions(apiData.strength_dna.dna_data);
            } else {
                dimensions = mapV4ToDimensions(apiData.norm_scores);
            }

            return {
                sessionId: sessionId,
                testedAt: new Date(apiData.completed_at).toLocaleString('zh-TW'),
                confidence: confidence,
                topNarrative: generateV4Narrative(apiData.profile),
                dimensions: dimensions,
                career_prototype: apiData.career_prototype // Pass through career prototype
            };
        }

        // Calculate confidence from theta scores standard errors
        function calculateConfidence(thetaScores) {
            if (!thetaScores || typeof thetaScores !== 'object') return 0.9;
            // Simple confidence estimation based on score variance
            const scores = Object.values(thetaScores);
            const variance = scores.reduce((sum, score) => sum + Math.abs(score), 0) / scores.length;
            return Math.max(0.7, Math.min(0.95, 1 - variance / 10));
        }

        // Map Strength DNA data to our format
        function mapDNADataToDimensions(dnaData) {
            if (!dnaData || !Array.isArray(dnaData)) return demoData.dimensions;

            return dnaData.map((item, index) => ({
                id: item.dimension,
                name: item.name, // Use Chinese name from Strength DNA
                domain: getDimensionDomain(item.dimension),
                percentile: Math.round(item.percentile)
            }));
        }

        // Map v4 dimensions to our 12 strength dimensions
        function mapV4ToDimensions(normScores) {
            if (!normScores || typeof normScores !== 'object') return demoData.dimensions;

            // V4 dimension mapping to our 12 dimensions
            const dimensionMapping = {
                // Core Gallup dimensions that match API output
                'Achiever': { id: 'T1', name: 'çµæ§‹åŒ–åŸ·è¡Œ', domain: 'executing' },
                'Deliberative': { id: 'T2', name: 'å“è³ªèˆ‡å®Œå‚™', domain: 'executing' },
                'Ideation': { id: 'T3', name: 'æ¢ç´¢èˆ‡å‰µæ–°', domain: 'strategic' },
                'Analytical': { id: 'T4', name: 'åˆ†æèˆ‡æ´å¯Ÿ', domain: 'strategic' },
                'Woo': { id: 'T5', name: 'å½±éŸ¿èˆ‡å€¡è­°', domain: 'influencing' },
                'Empathy': { id: 'T6', name: 'å”ä½œèˆ‡å…±å¥½', domain: 'relationship' },
                'Developer': { id: 'T7', name: 'å®¢æˆ¶å°å‘', domain: 'relationship' },
                'Learner': { id: 'T8', name: 'å­¸ç¿’èˆ‡æˆé•·', domain: 'strategic' },
                'Discipline': { id: 'T9', name: 'ç´€å¾‹èˆ‡ä¿¡ä»»', domain: 'executing' },
                'Adaptability': { id: 'T10', name: 'å£“åŠ›èª¿ç¯€', domain: 'relationship' },
                'Harmony': { id: 'T11', name: 'è¡çªæ•´åˆ', domain: 'relationship' },
                'Responsibility': { id: 'T12', name: 'è²¬ä»»èˆ‡ç•¶è²¬', domain: 'executing' },

                // Additional API dimensions mapped to our 12 themes
                'Command': { id: 'T1', name: 'çµæ§‹åŒ–åŸ·è¡Œ', domain: 'executing' },
                'Communication': { id: 'T5', name: 'å½±éŸ¿èˆ‡å€¡è­°', domain: 'influencing' },
                'Competition': { id: 'T2', name: 'å“è³ªèˆ‡å®Œå‚™', domain: 'executing' },
                'Connectedness': { id: 'T6', name: 'å”ä½œèˆ‡å…±å¥½', domain: 'relationship' },
                'Consistency': { id: 'T9', name: 'ç´€å¾‹èˆ‡ä¿¡ä»»', domain: 'executing' },
                'Context': { id: 'T4', name: 'åˆ†æèˆ‡æ´å¯Ÿ', domain: 'strategic' },
                'Belief': { id: 'T12', name: 'è²¬ä»»èˆ‡ç•¶è²¬', domain: 'executing' },
                'Includer': { id: 'T6', name: 'å”ä½œèˆ‡å…±å¥½', domain: 'relationship' },
                'Individualization': { id: 'T7', name: 'å®¢æˆ¶å°å‘', domain: 'relationship' },
                'Input': { id: 'T8', name: 'å­¸ç¿’èˆ‡æˆé•·', domain: 'strategic' },
                'Intellection': { id: 'T3', name: 'æ¢ç´¢èˆ‡å‰µæ–°', domain: 'strategic' },

                // T1-T12 direct mapping (for Strength DNA data)
                'T1': { id: 'T1', name: 'çµæ§‹åŒ–åŸ·è¡Œ', domain: 'executing' },
                'T2': { id: 'T2', name: 'å“è³ªèˆ‡å®Œå‚™', domain: 'executing' },
                'T3': { id: 'T3', name: 'æ¢ç´¢èˆ‡å‰µæ–°', domain: 'strategic' },
                'T4': { id: 'T4', name: 'åˆ†æèˆ‡æ´å¯Ÿ', domain: 'strategic' },
                'T5': { id: 'T5', name: 'å½±éŸ¿èˆ‡å€¡è­°', domain: 'influencing' },
                'T6': { id: 'T6', name: 'å”ä½œèˆ‡å…±å¥½', domain: 'relationship' },
                'T7': { id: 'T7', name: 'å®¢æˆ¶å°å‘', domain: 'relationship' },
                'T8': { id: 'T8', name: 'å­¸ç¿’èˆ‡æˆé•·', domain: 'strategic' },
                'T9': { id: 'T9', name: 'ç´€å¾‹èˆ‡ä¿¡ä»»', domain: 'executing' },
                'T10': { id: 'T10', name: 'å£“åŠ›èª¿ç¯€', domain: 'relationship' },
                'T11': { id: 'T11', name: 'è¡çªæ•´åˆ', domain: 'relationship' },
                'T12': { id: 'T12', name: 'è²¬ä»»èˆ‡ç•¶è²¬', domain: 'executing' }
            };

            const dimensions = [];
            let idCounter = 1;

            // Map all v4 dimensions with unique IDs
            for (const [v4Dim, scoreData] of Object.entries(normScores)) {
                const mapping = dimensionMapping[v4Dim];
                if (mapping) {
                    dimensions.push({
                        id: `T${idCounter}`,  // Unique ID for each dimension
                        name: mapping.name,  // Use Chinese name from mapping
                        domain: mapping.domain,
                        percentile: Math.round(scoreData.percentile || 50)
                    });
                    idCounter++;
                } else {
                    // Handle unmapped dimensions
                    dimensions.push({
                        id: `T${idCounter}`,
                        name: v4Dim,  // Keep original name for unmapped dimensions
                        domain: 'strategic',  // Default domain
                        percentile: Math.round(scoreData.percentile || 50)
                    });
                    idCounter++;
                }
            }

            // Fill remaining slots with demo data if needed (up to 12 total)
            while (dimensions.length < 12 && idCounter <= 12) {
                const demoDimension = demoData.dimensions[dimensions.length] || {
                    id: `T${idCounter}`,
                    name: `ç¶­åº¦${idCounter}`,
                    domain: 'strategic',
                    percentile: 50
                };
                dimensions.push({
                    ...demoDimension,
                    id: `T${idCounter}`
                });
                idCounter++;
            }

            return dimensions.slice(0, 12); // Ensure exactly 12 dimensions
        }

        // Generate narrative from v4 profile data
        function generateV4Narrative(profile) {
            if (!profile || !profile.top_strengths) {
                return "åŸºæ–¼æ‚¨çš„è©•æ¸¬çµæœï¼Œæˆ‘å€‘æ­£åœ¨åˆ†ææ‚¨çš„å„ªå‹¢çµ„åˆ...";
            }

            const topStrengths = profile.top_strengths.slice(0, 2);
            const strengthNames = topStrengths.map(s => s.dimension).join('ã€');

            return `æ‚¨çš„ä¸»å°å¤©è³¦èšç„¦æ–¼ã€${strengthNames}ã€ï¼Œå±•ç¾å‡ºç¨ç‰¹çš„å„ªå‹¢çµ„åˆã€‚é€™ç¨®çµ„åˆè®“æ‚¨åœ¨ç‰¹å®šæƒ…å¢ƒä¸‹èƒ½ç™¼æ®å“è¶Šè¡¨ç¾ã€‚`;
        }

        // Helper functions for API data transformation
        function getDimensionName(id) {
            const names = {
                'T1': 'çµæ§‹åŒ–åŸ·è¡Œ', 'T2': 'å“è³ªèˆ‡å®Œå‚™', 'T3': 'æ¢ç´¢èˆ‡å‰µæ–°',
                'T4': 'åˆ†æèˆ‡æ´å¯Ÿ', 'T5': 'å½±éŸ¿èˆ‡å€¡è­°', 'T6': 'å”ä½œèˆ‡å…±å¥½',
                'T7': 'å®¢æˆ¶å°å‘', 'T8': 'å­¸ç¿’èˆ‡æˆé•·', 'T9': 'ç´€å¾‹èˆ‡ä¿¡ä»»',
                'T10': 'å£“åŠ›èª¿ç¯€', 'T11': 'è¡çªæ•´åˆ', 'T12': 'è²¬ä»»èˆ‡ç•¶è²¬'
            };
            return names[id] || id;
        }

        function getDimensionDomain(id) {
            const domains = {
                'T1': 'executing', 'T2': 'executing', 'T9': 'executing', 'T12': 'executing',
                'T3': 'strategic', 'T4': 'strategic', 'T8': 'strategic',
                'T5': 'influencing',
                'T6': 'relationship', 'T7': 'relationship', 'T10': 'relationship', 'T11': 'relationship'
            };
            return domains[id] || 'strategic';
        }

        // Button actions
        function retakeAssessment() {
            // Clear any stored session data
            localStorage.removeItem('currentSessionId');
            localStorage.removeItem('lastCheckpoint');

            // Navigate back to home page
            window.location.href = '/';
        }

        function shareReport() {
            if (navigator.share) {
                navigator.share({
                    title: 'æˆ‘çš„å„ªå‹¢è©•æ¸¬çµæœ',
                    text: 'æˆ‘å‰›å®Œæˆäº†å„ªå‹¢å¤©è³¦è©•æ¸¬ï¼Œç™¼ç¾äº†æˆ‘çš„ç¨ç‰¹å„ªå‹¢çµ„åˆï¼',
                    url: window.location.href
                }).catch(console.error);
            } else {
                navigator.clipboard.writeText(window.location.href);
                alert('å ±å‘Šé€£çµå·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼');
            }
        }

        function downloadPDF() {
            alert('PDF ä¸‹è¼‰åŠŸèƒ½é–‹ç™¼ä¸­...');
        }

        function generateActionPlan() {
            window.location.href = 'action-plan.html?session=' + (new URLSearchParams(window.location.search).get('session') || 'demo');
        }

        function shareWithManager() {
            const text = 'æˆ‘å‰›å®Œæˆäº†å„ªå‹¢å¤©è³¦è©•æ¸¬ï¼Œä»¥ä¸‹æ˜¯æˆ‘çš„å ±å‘Šé€£çµï¼š' + window.location.href;
            if (navigator.share) {
                navigator.share({
                    title: 'å„ªå‹¢è©•æ¸¬çµæœåˆ†äº«',
                    text: text
                });
            } else {
                navigator.clipboard.writeText(text);
                alert('åˆ†äº«å…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', loadResults);

        // Save checkpoint
        localStorage.setItem('lastCheckpoint', 'results_viewed');
    </script>
</body>
</html>
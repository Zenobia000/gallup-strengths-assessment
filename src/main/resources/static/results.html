<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>評測結果 | 顧問式洞察輸出</title>
  <meta name="description" content="McKinsey 風格的結果頁，將評測數據化為顧問式 KPI、人物原型與行動建議，快速啟動下一步。" />
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <header class="global-header">
    <div class="layout">
      <div class="brand">Strength DNA Lab</div>
      <nav>
        <ul class="nav-list">
          <li><a class="nav-link" href="landing.html">首頁</a></li>
          <li><a class="nav-link" href="assessment-intro.html">評測準備</a></li>
          <li><a class="nav-link" href="assessment.html">進入評測</a></li>
          <li><a class="nav-link active" href="results.html">成果示意</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="page">
    <section class="layout hero">
      <div class="hero__grid">
        <div class="hero__content">
          <p class="eyebrow">Consulting-Grade Outputs</p>
          <h1>結果摘要：轉化洞察，啟動行動</h1>
          <p class="lead">評測完成後，你會立即看到顧問式 KPI 儀表板、優勢原型以及下一步建議，方便與主管、團隊或教練同步。</p>
          <div class="hero__ctas">
            <a class="button button--primary" href="report-detail.html">查看完整報告</a>
            <a class="button button--secondary" href="#actions">下一步行動</a>
          </div>
          <div class="hero__metrics">
            <div class="metric-card">
              <strong id="sessionId">載入中...</strong>
              <span>Session ID</span>
            </div>
            <div class="metric-card">
              <strong id="reliabilityScore">載入中...</strong>
              <span>信度指標</span>
            </div>
            <div class="metric-card">
              <strong id="completionTime">載入中...</strong>
              <span>完成時間</span>
            </div>
          </div>
        </div>
        <aside class="hero__panel">
          <h3>顧問式閱讀引導</h3>
          <ul>
            <li>KPI 摘要：三行看懂你的核心優勢。</li>
            <li>視覺化：以圖表呈現強度差異與優勢聚焦。</li>
            <li>行動建議：30 / 60 / 90 天節奏，立即可做。</li>
          </ul>
          <div class="badge-ring">
            <span class="badge badge--ghost">PDF 可下載</span>
            <span class="badge badge--ghost">可分享摘要連結</span>
          </div>
        </aside>
      </div>
    </section>

    <section class="layout section">
      <div class="section__header">
        <p class="eyebrow">Executive Summary</p>
        <h2>優勢 KPI 摘要</h2>
        <p class="section__intro">先給你最重要的 20%，協助快速內化結果。</p>
      </div>
      <div class="data-band">
        <div class="data-point">
          <span>核心優勢領域</span>
          <strong id="coreStrengthArea">載入中...</strong>
        </div>
        <div class="data-point">
          <span>常模百分位</span>
          <strong id="percentileRank">載入中...</strong>
        </div>
        <div class="data-point">
          <span>人物原型</span>
          <strong id="archetypeProfile">載入中...</strong>
        </div>
      </div>
      <div class="grid grid--3">
        <div class="card">
          <h3 class="card__title">優勢組合</h3>
          <p class="card__body">遠見規劃 × 深度整合 × 決策協調，適合帶領跨部門專案與客戶諮詢。</p>
        </div>
        <div class="card">
          <h3 class="card__title">建議焦點</h3>
          <p class="card__body">優先安排策略規劃、影響利害關係人、以及導入新流程的任務。</p>
        </div>
        <div class="card">
          <h3 class="card__title">風險提醒</h3>
          <p class="card__body">注意避免過度追求完美而延遲決策，建議設置每週回顧節點。</p>
        </div>
      </div>
    </section>

    <section class="layout section section--brand">
      <div class="section__header">
        <p class="eyebrow">Visual Insights</p>
        <h2>視覺化呈現：一眼看出優勢結構</h2>
        <p class="section__intro">正式版本將使用動態圖表，這裡示意顯示兩大模組。</p>
      </div>
      <div class="grid grid--2">
        <div class="card">
          <h3 class="card__title">🧬 優勢雷達圖</h3>
          <p class="card__body">12 維度強度比較，突出你的主導優勢與待管理領域。</p>
          <p class="caption">正式版將可自訂範圍、比較歷史或團隊平均值。</p>
        </div>
        <div class="card">
          <h3 class="card__title">📊 四大領域柱狀圖</h3>
          <p class="card__body">執行力、影響力、關係建立、戰略思維的總體趨勢。</p>
          <p class="caption">標註高於 75 百分位的區域，讓成長機會一目了然。</p>
        </div>
      </div>
    </section>

    <section id="actions" class="layout section">
      <div class="section__header">
        <p class="eyebrow">Next Steps</p>
        <h2>下一步行動：把洞察轉成成果</h2>
        <p class="section__intro">我們以顧問式結構規劃你的行動路線，確保動能不中斷。</p>
      </div>
      <div class="report-preview">
        <div class="report-card">
          <h3>30 天內</h3>
          <ul>
            <li>與直屬主管分享「優勢摘要」，爭取策略型任務。</li>
            <li>設定每週反思提醒，盤點優勢如何創造價值。</li>
          </ul>
        </div>
        <div class="report-card">
          <h3>60 天內</h3>
          <ul>
            <li>主導一次跨部門協作，驗證影響力與協調能力。</li>
            <li>安排教練諮詢或同儕回饋，對齊外部觀點。</li>
          </ul>
        </div>
        <div class="report-card">
          <h3>90 天內</h3>
          <ul>
            <li>建置個人化優勢資產（簡報、案例庫）。</li>
            <li>評估是否進一步購買團隊版或領導力方案。</li>
          </ul>
        </div>
      </div>
      <div class="action-bar">
        <a class="button button--primary" href="report-detail.html">查看完整報告</a>
        <a class="button button--secondary" href="#">下載 PDF</a>
        <a class="button button--secondary" href="#">分享摘要</a>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="layout">
      <div class="footer__meta">
        <strong class="brand">Strength DNA Lab</strong>
        <span>Step 4 · Results · 顧問式輸出</span>
        <div class="footer__links">
          <a href="landing.html">回首頁</a>
          <a href="assessment-intro.html">再次準備</a>
          <a href="report-detail.html">深入閱讀</a>
        </div>
      </div>
    </div>
  </footer>

  <script>
    // API Configuration - detect environment
    const apiBase = window.location.port === '8005' ? '' : 'http://localhost:8005';

    // Domain mapping for results interpretation
    const DOMAIN_MAPPING = {
      "EXECUTING": { name: "執行力", color: "purple" },
      "INFLUENCING": { name: "影響力", color: "orange" },
      "RELATIONSHIP_BUILDING": { name: "關係建立", color: "blue" },
      "STRATEGIC_THINKING": { name: "戰略思維", color: "green" }
    };

    const TALENT_DEFINITIONS = {
      "T1": { name: "結構化執行", domain: "EXECUTING" },
      "T2": { name: "品質與完備", domain: "EXECUTING" },
      "T3": { name: "探索與創新", domain: "STRATEGIC_THINKING" },
      "T4": { name: "分析與洞察", domain: "STRATEGIC_THINKING" },
      "T5": { name: "影響與倡議", domain: "INFLUENCING" },
      "T6": { name: "協作與共好", domain: "RELATIONSHIP_BUILDING" },
      "T7": { name: "客戶導向", domain: "INFLUENCING" },
      "T8": { name: "學習與成長", domain: "STRATEGIC_THINKING" },
      "T9": { name: "紀律與信任", domain: "RELATIONSHIP_BUILDING" },
      "T10": { name: "壓力調節", domain: "RELATIONSHIP_BUILDING" },
      "T11": { name: "衝突整合", domain: "INFLUENCING" },
      "T12": { name: "責任與當責", domain: "EXECUTING" }
    };

    // Get session ID from URL
    function getSessionId() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('session');
    }

    // Load assessment results
    async function loadResults() {
      const sessionId = getSessionId();

      if (!sessionId) {
        showError('無法找到評測會話 ID');
        return;
      }

      try {
        showLoading();

        const response = await fetch(`${apiBase}/api/assessment/results/${sessionId}`);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        console.log('Loaded results:', data);

        displayResults(data);
        hideLoading();

      } catch (error) {
        console.error('Error loading results:', error);
        showError('載入結果時發生錯誤: ' + error.message);
      }
    }

    // Display results in UI
    function displayResults(data) {
      const sessionId = data.session_id;
      const scores = data.scores || {};
      const sessionInfo = data.session_info || {};
      const scoringInfo = data.scoring_info || {};

      // Update session info
      document.getElementById('sessionId').textContent = sessionId;

      // Calculate reliability score (mock for now)
      const reliabilityScore = scoringInfo.overall_confidence || 0.85;
      document.getElementById('reliabilityScore').textContent = (reliabilityScore * 100).toFixed(0) + '%';

      // Calculate completion time (mock for now)
      document.getElementById('completionTime').textContent = '3:42';

      // Analyze scores to determine top domains and talents
      const talentScores = {};
      const domainScores = {
        EXECUTING: [],
        INFLUENCING: [],
        RELATIONSHIP_BUILDING: [],
        STRATEGIC_THINKING: []
      };

      // Parse scores and group by domain
      for (const [key, score] of Object.entries(scores)) {
        if (key.startsWith('t') && key.includes('_')) {
          const talentMatch = key.match(/^t(\d+)_(.+)$/);
          if (talentMatch) {
            const talentId = `T${talentMatch[1]}`;
            const talentDef = TALENT_DEFINITIONS[talentId];

            if (talentDef) {
              talentScores[talentId] = {
                name: talentDef.name,
                domain: talentDef.domain,
                score: score
              };
              domainScores[talentDef.domain].push(score);
            }
          }
        }
      }

      console.log('Parsed talent scores:', talentScores);
      console.log('Domain scores:', domainScores);

      // Calculate domain averages
      const domainAverages = {};
      for (const [domain, scores] of Object.entries(domainScores)) {
        if (scores.length > 0) {
          domainAverages[domain] = scores.reduce((a, b) => a + b, 0) / scores.length;
        } else {
          domainAverages[domain] = 0;
        }
      }

      // Find top domain
      const topDomain = Object.entries(domainAverages)
        .sort(([,a], [,b]) => b - a)[0];

      if (topDomain) {
        const domainName = DOMAIN_MAPPING[topDomain[0]]?.name || topDomain[0];
        document.getElementById('coreStrengthArea').textContent = domainName;
      }

      // Find top talents
      const topTalents = Object.entries(talentScores)
        .sort(([,a], [,b]) => b.score - a.score)
        .slice(0, 3);

      // Calculate percentile (mock calculation)
      const topScore = topTalents.length > 0 ? topTalents[0][1].score : 50;
      const percentile = Math.min(99, Math.max(1, Math.round(topScore)));
      document.getElementById('percentileRank').textContent = `Top ${100 - percentile}% (P${percentile})`;

      // Determine archetype based on top domain
      const archetypes = {
        'STRATEGIC_THINKING': '策略思維者',
        'EXECUTING': '執行型領導者',
        'INFLUENCING': '影響型領導者',
        'RELATIONSHIP_BUILDING': '關係建立者'
      };

      const archetype = archetypes[topDomain[0]] || '綜合型人才';
      document.getElementById('archetypeProfile').textContent = archetype;

      // Update report links to include session ID
      const reportLinks = document.querySelectorAll('a[href="report-detail.html"]');
      reportLinks.forEach(link => {
        link.href = `report-detail.html?session=${sessionId}`;
      });

      console.log('Results displayed successfully');
    }

    // Show loading state
    function showLoading() {
      console.log('Loading results...');
    }

    // Hide loading state
    function hideLoading() {
      console.log('Loading complete');
    }

    // Show error message
    function showError(message) {
      console.error('Error:', message);

      // Update UI to show error
      document.getElementById('sessionId').textContent = 'Error';
      document.getElementById('reliabilityScore').textContent = 'Error';
      document.getElementById('completionTime').textContent = 'Error';
      document.getElementById('coreStrengthArea').textContent = '載入失敗';
      document.getElementById('percentileRank').textContent = '載入失敗';
      document.getElementById('archetypeProfile').textContent = '載入失敗';

      // Optionally show user-friendly error message
      alert('無法載入評測結果，請重新整理頁面或聯繫技術支援。');
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Results page loaded, loading assessment results...');
      loadResults();
    });
  </script>
</body>
</html>

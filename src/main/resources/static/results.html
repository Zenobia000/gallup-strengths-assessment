<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>優勢評測專業報告 | 評測結果</title>
  <meta name="description" content="基於 Thurstonian IRT 模型的專業優勢評測結果，動態載入您的個人化天賦分析。">
  <style>
    /* McKinsey Style Variables */
    :root{
      --mckinsey-navy:#001F3F;--mckinsey-deep-blue:#003D73;--mckinsey-blue:#0066A6;
      --mckinsey-bright-blue:#0080D9;--mckinsey-light-blue:#E6F2FF;--consultant-gold:#D4AF37;
      --insight-teal:#008080;--data-orange:#FF6B35;--success-green:#2D8659;--alert-red:#C1272D;
      --gray-900:#1A1A1A;--gray-800:#333333;--gray-700:#4D4D4D;--gray-600:#666666;
      --gray-500:#7A7A7A;--gray-400:#999999;--gray-300:#CCCCCC;--gray-200:#E5E5E5;
      --gray-100:#F2F2F2;--gray-50:#F8F8F8;--white:#FFFFFF;
      --radius-sm:2px;--radius-md:4px;--radius-lg:8px;--radius-full:9999px;
      --border-thin:1px;--border-medium:2px;--border-thick:3px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--gray-50);color:var(--gray-900);font-family:"Noto Sans TC","Microsoft JhengHei",system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif;}
    .container{max-width:1280px;margin:0 auto;padding:40px;}

    /* Header */
    .report-header{display:flex;flex-wrap:wrap;gap:24px;align-items:flex-start;justify-content:space-between;background:var(--white);
      border:var(--border-thin) solid var(--gray-200);border-bottom:var(--border-medium) solid var(--mckinsey-navy);
      border-radius:var(--radius-md);padding:32px;margin-bottom:32px;}
    .brand{display:flex;gap:16px;align-items:flex-start}
    .brand-logo{width:40px;height:40px;border-radius:8px;background:var(--mckinsey-navy)}
    .report-title{font-size:28px;font-weight:600;color:var(--mckinsey-navy);margin:0 0 4px}
    .report-info{display:flex;flex-wrap:wrap;gap:12px;font-size:12px;color:var(--gray-600)}
    code.badge{background:var(--gray-100);padding:2px 6px;border-radius:var(--radius-sm);font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .actions{display:flex;gap:12px;align-items:center}
    .btn{display:inline-flex;align-items:center;justify-content:center;font-weight:600;letter-spacing:.02em;text-transform:uppercase;border-radius:var(--radius-sm);transition:.2s all;text-decoration:none;cursor:pointer}
    .btn-primary{background:var(--mckinsey-blue);color:#fff;border:none;padding:10px 20px}
    .btn-primary:hover{background:var(--mckinsey-deep-blue);transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,31,63,.08)}
    .btn-secondary{background:transparent;color:var(--mckinsey-blue);border:var(--border-medium) solid var(--mckinsey-blue);padding:10px 20px}
    .btn-secondary:hover{background:var(--mckinsey-light-blue);border-color:var(--mckinsey-deep-blue)}

    /* Section 基礎 */
    .section{margin-bottom:32px}
    .section-title{font-size:24px;font-weight:600;margin:0 0 12px}

    /* KPI */
    .kpi-grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:768px){.kpi-grid{grid-template-columns:repeat(3,1fr)}}
    .kpi-card{position:relative;background:var(--white);border:var(--border-thin) solid var(--gray-200);border-radius:var(--radius-md);padding:28px}
    .kpi-card::before{content:'';position:absolute;inset:0 auto 0 0;width:4px;background:var(--gray-400);border-top-left-radius:var(--radius-md);border-bottom-left-radius:var(--radius-md)}
    .kpi-card[data-variant="dominant"]::before{background:var(--success-green)}
    .kpi-card[data-variant="supporting"]::before{background:var(--mckinsey-blue)}
    .kpi-label{font-size:12px;color:var(--gray-600);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px}
    .kpi-value{font:600 48px/1 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;color:var(--gray-900);margin-bottom:4px}
    .kpi-desc{font-size:13px;color:var(--gray-600);margin-bottom:6px}
    .kpi-trend{font-size:12px;font-weight:600;color:var(--mckinsey-blue)}

    /* DNA 視覺化卡 */
    .card{background:var(--white);border:var(--border-thin) solid var(--gray-200);border-radius:var(--radius-md);padding:28px}
    .legend{display:flex;gap:16px;justify-content:center;margin-top:12px;font-size:14px;color:var(--gray-700)}
    .legend-dot{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:6px}
    .dot-executing{background:#7C3AED}.dot-influencing{background:#F59E0B}.dot-relationship{background:#0EA5E9}.dot-strategic{background:#10B981}

    /* 12 維度分析 */
    .section-headline{display:flex;flex-direction:column;gap:8px;margin-bottom:16px}
    .section-subtitle{margin:0;color:var(--gray-600);font-size:14px;line-height:1.5}
    .analysis-legend{display:flex;flex-direction:column;gap:12px;margin-bottom:20px}
    @media(min-width:768px){.analysis-legend{flex-direction:row;justify-content:space-between;align-items:center}}
    .legend-group{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .legend-label{font-size:12px;font-weight:600;color:var(--gray-600);text-transform:uppercase;letter-spacing:.06em}
    .legend-pill{--pill-color:var(--gray-500);display:inline-flex;align-items:center;gap:8px;padding:6px 16px 6px 32px;border-radius:999px;font-size:12px;font-weight:600;background:#fff;color:var(--pill-color);border:1.5px solid rgba(8,31,63,.12);position:relative;box-shadow:0 4px 10px rgba(0,31,63,.06)}
    .legend-pill::before{content:"";position:absolute;left:12px;top:50%;width:10px;height:10px;border-radius:50%;background:var(--pill-color);box-shadow:0 0 0 2px rgba(8,31,63,.08);transform:translateY(-50%)}
    .tier-pill.dominant{--pill-color:var(--success-green);border-color:rgba(45,134,89,.32)}
    .tier-pill.supporting{--pill-color:var(--mckinsey-blue);border-color:rgba(0,102,166,.28)}
    .tier-pill.managing{--pill-color:var(--data-orange);border-color:rgba(255,107,53,.28)}
    .domain-pill{border-color:rgba(0,31,63,.16)}
    .domain-pill.domain-executing{--pill-color:#6f3ad9}
    .domain-pill.domain-influencing{--pill-color:#d98205}
    .domain-pill.domain-relationship-building{--pill-color:#0e8cc6}
    .domain-pill.domain-strategic-thinking{--pill-color:#0c8a60}

    .talent-grid{display:grid;gap:18px}
    @media(min-width:768px){.talent-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(min-width:1200px){.talent-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}

    .talent-card{position:relative;padding:24px;border-radius:18px;background:var(--white);border:1px solid rgba(0,31,63,.08);box-shadow:0 10px 28px rgba(0,31,63,.06);display:flex;flex-direction:column;gap:18px;transition:transform .2s ease,box-shadow .2s ease}
    .talent-card::after{content:"";position:absolute;top:0;left:0;right:0;height:4px;border-radius:18px 18px 0 0;background:var(--domain-color,#0066A6)}
    .talent-card:hover{transform:translateY(-3px);box-shadow:0 18px 36px rgba(0,31,63,.12)}

    .talent-card.domain-executing{--domain-color:#7C3AED;background:rgba(124,58,237,.05);border-color:rgba(124,58,237,.25)}
    .talent-card.domain-influencing{--domain-color:#F59E0B;background:rgba(245,158,11,.05);border-color:rgba(245,158,11,.22)}
    .talent-card.domain-relationship-building{--domain-color:#0EA5E9;background:rgba(14,165,233,.05);border-color:rgba(14,165,233,.22)}
    .talent-card.domain-strategic-thinking{--domain-color:#10B981;background:rgba(16,185,129,.05);border-color:rgba(16,185,129,.22)}

    .talent-card__header{display:flex;gap:16px;align-items:flex-start}
    .talent-card__icon{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--domain-color),rgba(255,255,255,.6));color:#fff;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 6px 16px rgba(0,31,63,.15)}
    .talent-card__title{margin:0;font-size:18px;font-weight:600;color:var(--gray-900)}
    .talent-card__domain{margin:4px 0 0;font-size:13px;color:rgba(0,0,0,.6);letter-spacing:.05em;text-transform:uppercase}
    .tier-chip{margin-left:auto;padding:6px 12px;border-radius:999px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#fff;box-shadow:0 6px 14px rgba(0,31,63,.12)}
    .tier-chip.dominant{background:var(--success-green)}
    .tier-chip.supporting{background:var(--mckinsey-blue)}
    .tier-chip.managing{background:var(--data-orange)}

    .talent-card__score{display:flex;flex-direction:column;gap:10px}
    .score-value{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:28px;font-weight:600;color:var(--gray-900)}
    .score-bar{position:relative;height:10px;border-radius:999px;background:rgba(0,0,0,.08);overflow:hidden}
    .score-bar__fill{position:absolute;left:0;top:0;bottom:0;border-radius:999px;background:linear-gradient(90deg,var(--domain-color),rgba(255,255,255,.6))}
    .score-meta{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--gray-600);letter-spacing:.02em}
    .score-meta strong{font-size:12px;color:var(--domain-color)}

    .talent-card__note{margin:0;color:var(--gray-700);font-size:13px;line-height:1.5}
    .talent-empty{padding:24px;border-radius:18px;border:1px dashed rgba(0,31,63,.16);color:var(--gray-600);font-size:14px;text-align:center;background:rgba(0,0,0,.02)}

    .domain-grid{display:grid;gap:18px}
    @media(min-width:768px){.domain-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(min-width:1200px){.domain-grid{grid-template-columns:repeat(4,minmax(0,1fr))}}
    .domain-card{position:relative;padding:24px;border-radius:20px;background:var(--white);border:1px solid rgba(0,31,63,.08);box-shadow:0 12px 24px rgba(0,31,63,.08);display:flex;flex-direction:column;gap:16px;overflow:hidden}
    .domain-card::before{content:"";position:absolute;inset:0;opacity:0.12;background:linear-gradient(135deg,var(--domain-color,#0066A6),transparent);pointer-events:none}
    .domain-card__header{display:flex;align-items:center;justify-content:space-between;position:relative}
    .domain-card__title{margin:0;font-size:18px;font-weight:600;color:var(--gray-900)}
    .domain-card__meta{font-size:12px;color:rgba(0,0,0,.6);letter-spacing:.04em;text-transform:uppercase}
    .domain-score{display:flex;align-items:flex-end;gap:8px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;color:var(--gray-900);position:relative}
    .domain-score strong{font-size:36px;line-height:1}
    .domain-score span{font-size:13px;color:var(--gray-600)}
    .domain-best{position:relative;padding:12px 14px;border-radius:16px;background:rgba(255,255,255,.65);backdrop-filter:blur(10px);display:flex;flex-direction:column;gap:6px;border:1px solid rgba(0,31,63,.06)}
    .domain-best__label{font-size:12px;font-weight:600;color:rgba(0,0,0,.55);letter-spacing:.04em;text-transform:uppercase}
    .domain-best__talent{font-size:15px;font-weight:600;color:var(--gray-900)}
    .domain-best__desc{margin:0;font-size:13px;color:var(--gray-700);line-height:1.5}

    /* Persona */
    .persona-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .badge-premium{display:inline-flex;align-items:center;border-radius:9999px;padding:4px 10px;font-size:12px;font-weight:700;background:linear-gradient(135deg,var(--consultant-gold) 0%,#F2D675 100%);color:var(--gray-900)}
    .grid-3{display:grid;grid-template-columns:1fr;gap:24px}
    @media(min-width:768px){.grid-3{grid-template-columns:repeat(3,1fr)}}
    .subttl{font-size:12px;color:var(--gray-700);text-transform:uppercase;letter-spacing:.03em;margin:0 0 8px}
    .list{list-style:none;margin:0;padding:0}
    .list li{padding:8px 0;border-bottom:var(--border-thin) solid var(--gray-200)}
    .list li:last-child{border-bottom:none}

    /* Next steps */
    .steps{list-style:none;margin:8px 0 0;padding:0}
    .step{position:relative;padding-left:60px;margin-bottom:24px}
    .step-num{position:absolute;left:0;top:0;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;
      background:var(--mckinsey-blue);color:#fff;font:600 18px/1 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .step strong{display:block;font-size:18px;margin-bottom:4px}
    .link{background:none;border:none;color:var(--mckinsey-blue);font-weight:700;padding:0;cursor:pointer}
    .link:hover{text-decoration:underline}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .mb-0{margin-bottom:0}

    /* DNA SVG */
    .dna{width:100%;height:240px}

    /* Loading & Error States */
    .loading, .error {
      display: none;
      text-align: center;
      padding: 3rem;
      background: var(--white);
      border-radius: var(--radius-md);
      border: var(--border-thin) solid var(--gray-200);
      margin: 2rem 0;
    }
    .loading.active, .error.active { display: block; }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--gray-200);
      border-top-color: var(--mckinsey-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error { color: var(--alert-red); }
  </style>
</head>
<body>
  <main class="container">
    <!-- Loading State -->
    <div class="loading" id="loadingState">
      <div class="spinner"></div>
      <h3>正在載入您的評測結果...</h3>
      <p>分析您的優勢DNA組合</p>
    </div>

    <!-- Error State -->
    <div class="error" id="errorState">
      <h3>載入結果時發生錯誤</h3>
      <p id="errorMessage">請重新整理頁面或聯繫技術支援</p>
      <button class="btn btn-secondary" onclick="window.location.reload()">
        🔄 重新載入
      </button>
    </div>

    <!-- Results Content -->
    <div id="resultsContent" style="display: none;">

      <!-- Header -->
      <header class="report-header">
        <div class="brand">
          <div class="brand-logo" aria-hidden="true"></div>
          <div>
            <h1 class="report-title">優勢評測專業報告</h1>
            <div class="report-info">
              <span>Session: <code class="badge mono" id="sessionId">載入中...</code></span>
              <span>•</span>
              <span>評測時間: <span id="assessmentTime">載入中...</span></span>
              <span>•</span>
              <span>置信度: <strong id="confidenceLevel">載入中...</strong></span>
            </div>
          </div>
        </div>
        <div class="actions">
          <button class="btn btn-secondary" onclick="window.location.href='landing.html'">🏠 返回首頁</button>
          <button class="btn btn-secondary" onclick="shareReport()">📤 分享報告</button>
          <button class="btn btn-primary" onclick="downloadPDF()">📄 下載 PDF</button>
        </div>
      </header>

      <!-- KPI Dashboard -->
      <section class="section">
        <h2 class="section-title">執行摘要</h2>
        <div class="kpi-grid">
          <div class="kpi-card" data-variant="dominant">
            <div class="kpi-label">主導才幹</div>
            <div class="kpi-value mono" id="dominantCount">0</div>
            <div class="kpi-desc">百分位 &gt; 75</div>
            <div class="kpi-trend" id="dominantTrend">載入中...</div>
          </div>
          <div class="kpi-card" data-variant="supporting">
            <div class="kpi-label">支援才幹</div>
            <div class="kpi-value mono" id="supportingCount">0</div>
            <div class="kpi-desc">百分位 25–75</div>
            <div class="kpi-trend" id="supportingTrend">載入中...</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">待管理領域</div>
            <div class="kpi-value mono" id="managingCount">0</div>
            <div class="kpi-desc">百分位 &lt; 25</div>
            <div class="kpi-trend" id="managingTrend">載入中...</div>
          </div>
        </div>
      </section>

      <!-- DNA Visualization -->
      <section class="section card">
        <h2 class="section-title mb-0">您的優勢 DNA</h2>

        <svg class="dna" viewBox="0 0 960 240" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="優勢DNA視覺化" id="dnaVisualization">
          <defs>
            <!-- 品牌漸層與柔光 -->
            <linearGradient id="dnaGrad1" x1="0" y1="0" x2="1" y2="0">
              <stop offset="0%" stop-color="#003D73"/>
              <stop offset="100%" stop-color="#0080D9"/>
            </linearGradient>
            <linearGradient id="dnaGrad2" x1="0" y1="0" x2="1" y2="0">
              <stop offset="0%" stop-color="#8FB7E7"/>
              <stop offset="100%" stop-color="#B6D8FF"/>
            </linearGradient>
            <filter id="softGlow" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur stdDeviation="6" result="g"/>
              <feMerge><feMergeNode in="g"/><feMergeNode in="SourceGraphic"/></feMerge>
            </filter>
          </defs>

          <!-- 雙曲線背骨 -->
          <path d="M48,120
                   C104,40 104,200 160,120
                   S216,40 272,120
                   S328,200 384,120
                   S440,40 496,120
                   S552,200 608,120
                   S664,40 720,120
                   S776,200 832,120
                   S888,40 912,120"
                fill="none" stroke="url(#dnaGrad1)" stroke-width="3" filter="url(#softGlow)"/>
          <path d="M48,120
                   C104,200 104,40 160,120
                   S216,200 272,120
                   S328,40 384,120
                   S440,200 496,120
                   S552,40 608,120
                   S664,200 720,120
                   S776,40 832,120
                   S888,200 912,120"
                fill="none" stroke="url(#dnaGrad2)" stroke-width="3" opacity="0.9"/>

          <!-- Talent nodes will be dynamically inserted here -->
        </svg>

        <div class="legend">
          <span><i class="legend-dot dot-executing"></i>執行力</span>
          <span><i class="legend-dot dot-influencing"></i>影響力</span>
          <span><i class="legend-dot dot-relationship"></i>關係建立</span>
          <span><i class="legend-dot dot-strategic"></i>戰略思維</span>
        </div>
      </section>

      <!-- Domain Summary -->
      <section class="section">
        <div class="section-headline">
          <h2 class="section-title">四大領域表現</h2>
          <p class="section-subtitle">快速了解四大領域的整體趨勢、平均百分位與最佳代表才幹，幫助你聚焦發展重點。</p>
        </div>
        <div class="domain-grid" id="domainSummaryGrid">
          <!-- Domain cards injected by script -->
        </div>
      </section>

      <!-- 詳細分析表格 -->
      <section class="section">
        <div class="section-headline">
          <h2 class="section-title">12 維度詳細分析</h2>
          <p class="section-subtitle">顏色對應四大領域，長條反映常模百分位，提示協助你善用或管理此才幹。</p>
        </div>
        <div class="analysis-legend">
          <div class="legend-group">
            <span class="legend-label">分級意義</span>
            <span class="legend-pill tier-pill dominant">主導 ≥ 75</span>
            <span class="legend-pill tier-pill supporting">支援 25–75</span>
            <span class="legend-pill tier-pill managing">待管理 &lt; 25</span>
          </div>
          <div class="legend-group">
            <span class="legend-label">領域色彩</span>
            <span class="legend-pill domain-pill domain-executing">執行力</span>
            <span class="legend-pill domain-pill domain-influencing">影響力</span>
            <span class="legend-pill domain-pill domain-relationship-building">關係建立</span>
            <span class="legend-pill domain-pill domain-strategic-thinking">戰略思維</span>
          </div>
        </div>
        <div class="talent-grid" id="talentGrid">
          <!-- Talent cards will be dynamically inserted here -->
        </div>
      </section>

      <!-- Persona -->
      <section class="section card">
        <div class="persona-head">
          <h2 class="section-title">職業原型參考</h2>
          <span class="badge-premium">Dynamic</span>
        </div>
        <p style="color:var(--gray-700)" id="personaDescription">
          載入中...
        </p>
        <div class="grid-3" style="margin-top:16px">
          <div>
            <h4 class="subttl">建議職位</h4>
            <ul class="list" id="suggestedRoles">
              <li>載入中...</li>
            </ul>
          </div>
          <div>
            <h4 class="subttl">關鍵情境</h4>
            <ul class="list" id="keyContexts">
              <li>載入中...</li>
            </ul>
          </div>
          <div>
            <h4 class="subttl">發展建議</h4>
            <ul class="list" id="developmentTips">
              <li>載入中...</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- Next Steps -->
      <section class="section card">
        <h2 class="section-title">建議後續行動</h2>
        <ol class="steps">
          <li class="step">
            <span class="step-num">1</span>
            <strong>深入閱讀</strong>
            <p style="margin:4px 0 8px;color:#555">查看完整詳細報告，了解每個維度的具體表現與應用建議。</p>
            <button class="link" id="detailReportLink">查看完整報告 →</button>
          </li>
          <li class="step">
            <span class="step-num">2</span>
            <strong>下載保存</strong>
            <p style="margin:4px 0 8px;color:#555">下載 PDF 版本報告，可加入履歷或個人發展檔案。</p>
            <button class="link" onclick="downloadPDF()">下載 PDF →</button>
          </li>
          <li class="step">
            <span class="step-num">3</span>
            <strong>分享討論</strong>
            <p style="margin:4px 0 8px;color:#555">與團隊領導或職涯顧問討論評測結果，制定發展計劃。</p>
            <button class="link" onclick="shareReport()">分享報告 →</button>
          </li>
          <li class="step">
            <span class="step-num">4</span>
            <strong>返回首頁或再度評測</strong>
            <p style="margin:4px 0 8px;color:#555">隨時回到首頁瀏覽說明，或透過準備頁重新啟動下一次測評。</p>
            <div style="display:flex;gap:12px;flex-wrap:wrap;">
              <button class="link" onclick="window.location.href='landing.html'">返回首頁 →</button>
              <button class="link" onclick="window.location.href='assessment-intro.html'">再次評測 →</button>
            </div>
          </li>
        </ol>
      </section>
    </div>
  </main>

  <script>
    // API Configuration
    const apiBase = window.location.port === '8005' ? '' : `http://${window.location.hostname}:8005`;

    // Talent definitions with domain mapping
    const TALENT_DEFINITIONS = {
        "T1": { name: "結構化執行", domain: "EXECUTING", icon: "🎯", description: "將目標拆解成步驟，建立流程和追蹤機制" },
        "T2": { name: "品質與完備", domain: "EXECUTING", icon: "✅", description: "注重細節，追求第一次就把事情做對" },
        "T3": { name: "探索與創新", domain: "STRATEGIC_THINKING", icon: "🔍", description: "嘗試新方法，從失敗中學習，連結不同概念" },
        "T4": { name: "分析與洞察", domain: "STRATEGIC_THINKING", icon: "📊", description: "界定問題，用數據檢驗假設，辨識因果關係" },
        "T5": { name: "影響與倡議", domain: "INFLUENCING", icon: "💪", description: "說服他人，表達觀點，推動變革" },
        "T6": { name: "協作與共好", domain: "RELATIONSHIP_BUILDING", icon: "🤝", description: "建立團隊合作，分享資源，促進和諧" },
        "T7": { name: "客戶導向", domain: "INFLUENCING", icon: "🎯", description: "理解客戶需求，創造價值，建立長期關係" },
        "T8": { name: "學習與成長", domain: "STRATEGIC_THINKING", icon: "📚", description: "持續學習，反思改進，培養他人" },
        "T9": { name: "紀律與信任", domain: "RELATIONSHIP_BUILDING", icon: "⚖️", description: "守約守時，維持穩定，建立可靠形象" },
        "T10": { name: "壓力調節", domain: "RELATIONSHIP_BUILDING", icon: "🧘", description: "在壓力下保持冷靜，穩定團隊情緒" },
        "T11": { name: "衝突整合", domain: "INFLUENCING", icon: "🎭", description: "處理分歧，尋求共識，促進決策" },
        "T12": { name: "責任與當責", domain: "EXECUTING", icon: "💼", description: "承擔責任，主動回報，確保交付" }
    };

    // Career archetypes
    const CAREER_ARCHETYPES = {
        "EXECUTING": {
            name: "執行型建構者",
            description: "以成果導向為核心、能將策略轉為可執行計劃；在系統化流程與品質控管中發揮專業，適合複雜專案的管理執行角色。",
            roles: ["專案經理", "營運主管", "品質工程師", "流程分析師"],
            contexts: ["系統執行", "品質控管", "流程優化"],
            tips: ["配對強『影響力』夥伴擴大成果", "設定明確里程碑與成功指標"]
        },
        "INFLUENCING": {
            name: "影響型領導者",
            description: "以溝通說服為核心、能將想法轉為組織行動；在跨部門協作與客戶關係中發揮影響力，適合需要對外驅動變革的角色。",
            roles: ["銷售經理", "企業顧問", "公關主管", "業務拓展"],
            contexts: ["變革推動", "客戶關係", "跨部門協作"],
            tips: ["平衡『執行力』確保落地能力", "避免過度溝通，聚焦核心訊息"]
        },
        "RELATIONSHIP_BUILDING": {
            name: "關係建構者",
            description: "以團隊和諧為核心、能在複雜人際環境中保持穩定；在組織文化與團隊凝聚中發揮專業，適合人才發展與組織健康角色。",
            roles: ["人資主管", "團隊經理", "組織發展", "客戶成功"],
            contexts: ["團隊建設", "衝突調解", "組織文化"],
            tips: ["結合『戰略思維』提升影響範圍", "設定明確績效指標避免過度關注過程"]
        },
        "STRATEGIC_THINKING": {
            name: "策略思維者",
            description: "以分析洞察為核心、能從複雜資訊中萃取決策要素；在策略規劃與創新思考中發揮專業，適合高複雜度與不確定情境。",
            roles: ["策略分析師", "產品經理", "研發主管", "管理顧問"],
            contexts: ["策略規劃", "產品創新", "市場分析"],
            tips: ["配對強『影響力/關係』夥伴", "避免過度分析，設定決策截止點"]
        }
    };

    // Domain colors mapping
    const DOMAIN_COLORS = {
        "EXECUTING": "#7C3AED",
        "INFLUENCING": "#F59E0B",
        "RELATIONSHIP_BUILDING": "#0EA5E9",
        "STRATEGIC_THINKING": "#10B981"
    };

    const DOMAIN_LABELS = {
        "EXECUTING": "執行力",
        "INFLUENCING": "影響力",
        "RELATIONSHIP_BUILDING": "關係建立",
        "STRATEGIC_THINKING": "戰略思維"
    };

    const TIER_META = {
        dominant: {
            label: "主導",
            summary: "優先投入",
            note: "這是你最具影響力的區域，適合承接高複雜度或關鍵任務，將資源聚焦於此。"
        },
        supporting: {
            label: "支援",
            summary: "搭配主導",
            note: "此才幹能夠穩定支援主導優勢，設定明確角色或流程即可放大整體成效。"
        },
        managing: {
            label: "待管理",
            summary: "善用協作",
            note: "避免獨自承擔關鍵決策，爭取工具或夥伴支援，把心力放在主導與支援優勢上。"
        }
    };

    const DOMAIN_META = {
        "EXECUTING": {
            label: "執行力",
            description: "善於拆解目標、建立流程並確保交付品質，適合主導執行與落地任務。"
        },
        "STRATEGIC_THINKING": {
            label: "戰略思維",
            description: "擅長分析與創新，能在複雜資訊中找出洞察並規劃長期方向。"
        },
        "INFLUENCING": {
            label: "影響力",
            description: "透過溝通說服帶動他人行動，適合對外協調與變革推動。"
        },
        "RELATIONSHIP_BUILDING": {
            label: "關係建立",
            description: "維持團隊信任與穩定，擅長協作與情緒調節，適合成為團隊凝聚核心。"
        }
    };

    // Get session ID from URL
    function getSessionId() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('session');
    }

    // Validate session format
    function validateSession(sessionId) {
        if (!sessionId) return false;
        const pattern = /^v4_[a-z0-9]+$/;
        return pattern.test(sessionId);
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        const sessionId = getSessionId();

        if (!validateSession(sessionId)) {
            showError('無效的評測會話 ID，即將重新導向...');
            setTimeout(() => {
                window.location.href = '/static/landing.html';
            }, 3000);
            return;
        }

        loadResults(sessionId);
    });

    // Load talent mapping rules from API
    let TALENT_MAPPING_RULES = null;
    let ARCHETYPE_DEFINITIONS = null;

    async function loadTalentMappingRules() {
        try {
            const response = await fetch(`${apiBase}/api/assessment/talent-mapping`);
            if (response.ok) {
                const data = await response.json();
                TALENT_MAPPING_RULES = data.talent_mapping;
                ARCHETYPE_DEFINITIONS = TALENT_MAPPING_RULES?.archetype_definitions || {};
                console.log('Loaded talent mapping rules:', Object.keys(ARCHETYPE_DEFINITIONS));
                return true;
            }
        } catch (error) {
            console.error('Error loading talent mapping rules:', error);
        }
        return false;
    }

    // Load results from API
    async function loadResults(sessionId) {
        showLoading();

        try {
            // Load talent mapping rules first
            await loadTalentMappingRules();

            const response = await fetch(`${apiBase}/api/assessment/results/${sessionId}`);

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            console.log('Loaded results data:', data);

            displayResults(data);
            hideLoading();

        } catch (error) {
            console.error('Error loading results:', error);
            showError('載入結果失敗: ' + error.message);
        }
    }

    // Display results
    function displayResults(data) {
        const sessionId = data.session_id;
        const scores = data.scores || {};
        const sessionInfo = data.session_info || {};
        const scoringInfo = data.scoring_info || {};

        // Update header info
        document.getElementById('sessionId').textContent = sessionId;

        // Use real assessment time from session data
        const assessmentDate = sessionInfo.created_at ?
            new Date(sessionInfo.created_at).toLocaleDateString('zh-TW', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            }) : new Date().toLocaleDateString('zh-TW', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });
        document.getElementById('assessmentTime').textContent = assessmentDate;

        const confidence = Math.round((scoringInfo.overall_confidence || 0.85) * 100);
        document.getElementById('confidenceLevel').textContent = `${confidence}%`;

        // Parse talents and categorize
        const talents = parseTalents(scores);
        const categorized = categorizeTalents(talents);

        // Update KPI Dashboard
        updateKPIDashboard(categorized);

        // Generate DNA visualization
        generateDNAVisualization(talents);

        // Render domain summary
        renderDomainSummary(talents);

        // Update detailed analysis cards
        renderTalentGrid(talents);

        // Update career archetype
        updateCareerArchetype(categorized);

        // Update action buttons
        document.getElementById('detailReportLink').onclick = () => {
            window.location.href = `report-detail.html?session=${sessionId}`;
        };

        // Show results
        document.getElementById('resultsContent').style.display = 'block';
    }

    // Parse talents from scores
    function parseTalents(scores) {
        const talents = [];

        for (const [key, score] of Object.entries(scores)) {
            if (key.startsWith('t') && key.includes('_')) {
                const talentMatch = key.match(/^t(\d+)_(.+)$/);
                if (talentMatch) {
                    const talentId = `T${talentMatch[1]}`;
                    const talentDef = TALENT_DEFINITIONS[talentId];

                    if (talentDef) {
                        talents.push({
                            id: talentId,
                            name: talentDef.name,
                            domain: talentDef.domain,
                            icon: talentDef.icon,
                            description: talentDef.description,
                            score: score
                        });
                    }
                }
            }
        }

        return talents.sort((a, b) => b.score - a.score);
    }

    // Categorize talents by percentile thresholds
    function categorizeTalents(talents) {
        return {
            dominant: talents.filter(t => t.score > 75),
            supporting: talents.filter(t => t.score >= 25 && t.score <= 75),
            managing: talents.filter(t => t.score < 25)
        };
    }

    // Update KPI Dashboard
    function updateKPIDashboard(categorized) {
        document.getElementById('dominantCount').textContent = categorized.dominant.length;
        document.getElementById('supportingCount').textContent = categorized.supporting.length;
        document.getElementById('managingCount').textContent = categorized.managing.length;

        // Update trends
        const dominantPercent = categorized.dominant.length > 0 ?
            Math.round(categorized.dominant.reduce((sum, t) => sum + t.score, 0) / categorized.dominant.length) : 0;
        document.getElementById('dominantTrend').textContent =
            dominantPercent > 80 ? `↑ 高於 ${dominantPercent}% 用戶` :
            dominantPercent > 0 ? `→ 高於平均` : '→ 需要發展';

        document.getElementById('supportingTrend').textContent = '→ 平衡發展';
        document.getElementById('managingTrend').textContent =
            categorized.managing.length > 3 ? '↓ 需要關注' : '→ 可接受範圍';
    }

    // Generate DNA visualization
    function generateDNAVisualization(talents) {
        const svg = document.getElementById('dnaVisualization');

        // X positions for 12 talents (evenly spaced)
        const xPositions = [48, 128, 208, 288, 368, 448, 528, 608, 688, 768, 832, 912];

        // Clear existing nodes
        const existingNodes = svg.querySelectorAll('.dynamic-node, .dynamic-rung, .dynamic-text');
        existingNodes.forEach(node => node.remove());

        talents.forEach((talent, index) => {
            if (index >= xPositions.length) return;

            const x = xPositions[index];
            const y = index % 2 === 0 ? 80 : 160; // Alternate sides
            const radius = Math.max(5, talent.score / 5); // Scale radius by score

            // Add connecting rung
            const rung = document.createElementNS("http://www.w3.org/2000/svg", "path");
            rung.setAttribute("d", `M${x} ${y === 80 ? 80 : 160} Q ${x} 120 ${x} ${y === 80 ? 160 : 80}`);
            rung.setAttribute("fill", "none");
            rung.setAttribute("stroke", DOMAIN_COLORS[talent.domain]);
            rung.setAttribute("stroke-width", "2");
            rung.setAttribute("stroke-opacity", talent.score / 100);
            rung.classList.add("dynamic-rung");
            svg.appendChild(rung);

            // Add outer glow circle
            const glow = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            glow.setAttribute("cx", x);
            glow.setAttribute("cy", y);
            glow.setAttribute("r", radius + 4);
            glow.setAttribute("fill", DOMAIN_COLORS[talent.domain]);
            glow.setAttribute("opacity", "0.18");
            glow.classList.add("dynamic-node");
            svg.appendChild(glow);

            // Add main circle
            const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            circle.setAttribute("cx", x);
            circle.setAttribute("cy", y);
            circle.setAttribute("r", radius);
            circle.setAttribute("fill", DOMAIN_COLORS[talent.domain]);
            circle.setAttribute("stroke", "#fff");
            circle.setAttribute("stroke-width", "2");
            circle.classList.add("dynamic-node");
            circle.setAttribute("title", `${talent.name}: PR ${talent.score}`);
            svg.appendChild(circle);

            // Add label
            const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
            text.setAttribute("x", x);
            text.setAttribute("y", y === 80 ? 48 : 190);
            text.setAttribute("text-anchor", "middle");
            text.setAttribute("font-size", "11");
            text.setAttribute("fill", "#4D4D4D");
            text.textContent = talent.name;
            text.classList.add("dynamic-text");
            svg.appendChild(text);
        });
    }

    // Render detailed analysis cards
    function renderTalentGrid(talents) {
        const container = document.getElementById('talentGrid');
        if (!container) return;

        container.innerHTML = '';

        if (!talents || talents.length === 0) {
            container.innerHTML = '<div class="talent-empty">尚未取得各維度分數，請確認評測是否完成。</div>';
            return;
        }

        talents.forEach(talent => {
            const tierKey = talent.score > 75 ? 'dominant' : (talent.score >= 25 ? 'supporting' : 'managing');
            const tierConfig = TIER_META[tierKey];
            const domainClass = talent.domain ? talent.domain.toLowerCase().replace(/_/g, '-') : '';
            const domainLabel = DOMAIN_LABELS[talent.domain] || talent.domain.replace('_', ' ');
            const tierTooltip = tierConfig.note;

            let comparisonText;
            if (talent.score >= 80) {
                comparisonText = `高於 ${Math.round(talent.score)}% 同儕`;
            } else if (talent.score >= 60) {
                comparisonText = '略高於平均';
            } else if (talent.score >= 40) {
                comparisonText = '接近平均';
            } else if (talent.score >= 25) {
                comparisonText = '略低於平均';
            } else {
                comparisonText = '低於平均';
            }

            const scoreValue = Math.round(talent.score);
            const barWidth = Math.min(100, Math.max(6, scoreValue));
            const talentDescription = talent.description || tierTooltip;

            const card = document.createElement('article');
            card.className = `talent-card domain-${domainClass}`;
            card.innerHTML = `
                <div class="talent-card__header">
                    <div class="talent-card__icon" title="${tierTooltip}" aria-label="${tierTooltip}">${talent.icon || '🧬'}</div>
                    <div>
                        <h3 class="talent-card__title">${talent.name}</h3>
                        <p class="talent-card__domain">${domainLabel}</p>
                    </div>
                    <span class="tier-chip ${tierKey}">${tierConfig.label}</span>
                </div>
                <div class="talent-card__score">
                    <span class="score-value">PR ${scoreValue}</span>
                    <div class="score-bar">
                        <span class="score-bar__fill" style="width:${barWidth}%;"></span>
                    </div>
                    <div class="score-meta">
                        <strong>${comparisonText}</strong>
                        <span>${tierConfig.summary}</span>
                    </div>
                </div>
                <p class="talent-card__note">${talentDescription}</p>
            `;

            container.appendChild(card);
        });
    }

    // Render domain summary cards
    function renderDomainSummary(talents) {
        const grid = document.getElementById('domainSummaryGrid');
        if (!grid) return;

        grid.innerHTML = '';

        const grouped = talents.reduce((acc, talent) => {
            if (!acc[talent.domain]) {
                acc[talent.domain] = [];
            }
            acc[talent.domain].push(talent);
            return acc;
        }, {});

        Object.keys(DOMAIN_META).forEach(domainKey => {
            const domainTalents = grouped[domainKey] || [];
            const meta = DOMAIN_META[domainKey];
            const avgScore = domainTalents.length
                ? Math.round(domainTalents.reduce((sum, t) => sum + t.score, 0) / domainTalents.length)
                : 0;

            const highlight = domainTalents.length
                ? domainTalents.reduce((prev, current) => (current.score > prev.score ? current : prev), domainTalents[0])
                : null;

            const card = document.createElement('article');
            card.className = 'domain-card';
            card.style.setProperty('--domain-color', DOMAIN_COLORS[domainKey] || '#0066A6');

            card.innerHTML = `
                <div class="domain-card__header">
                    <div>
                        <h3 class="domain-card__title">${meta.label}</h3>
                        <span class="domain-card__meta">平均百分位 · PR ${avgScore}</span>
                    </div>
                </div>
                <div class="domain-score">
                    <strong>${avgScore}</strong>
                    <span>Average PR</span>
                </div>
                <div class="domain-best">
                    <span class="domain-best__label">代表才幹</span>
                    <span class="domain-best__talent">${highlight ? highlight.name : '尚未取得資料'}</span>
                    <p class="domain-best__desc">${highlight ? (highlight.description || DOMAIN_META[domainKey].description) : meta.description}</p>
                </div>
            `;

            grid.appendChild(card);
        });
    }

    // Update career archetype
    function updateCareerArchetype(categorized) {
        if (!ARCHETYPE_DEFINITIONS || !TALENT_MAPPING_RULES) {
            console.warn('Archetype definitions not loaded, using fallback');
            updateCareerArchetypeFallback(categorized);
            return;
        }

        // Run the full classification algorithm
        const archetypeResult = classifyArchetype(categorized);
        console.log('Archetype classification result:', archetypeResult);

        // Update persona content with dynamic results
        updatePersonaUI(archetypeResult);
    }

    // Fallback to domain-based classification when mapping rules unavailable
    function updateCareerArchetypeFallback(categorized) {
        const domainCounts = {
            "EXECUTING": 0, "INFLUENCING": 0,
            "RELATIONSHIP_BUILDING": 0, "STRATEGIC_THINKING": 0
        };

        categorized.dominant.forEach(talent => {
            domainCounts[talent.domain]++;
        });

        const topDomain = Object.entries(domainCounts)
            .sort(([,a], [,b]) => b - a)[0];

        const archetype = CAREER_ARCHETYPES[topDomain[0]] || CAREER_ARCHETYPES["STRATEGIC_THINKING"];

        document.getElementById('personaDescription').innerHTML = `
            <div style="margin-bottom: 8px; color: var(--data-orange); font-size: 12px; font-weight: 600;">
                ⚠️ 基礎分析 - 基於領域偏好的簡化分類
            </div>
            ${archetype.description}
        `;

        // Update lists with fallback data
        updateArchetypeLists(archetype.roles, archetype.contexts, archetype.tips);
    }

    // Implement the full archetype classification algorithm from talent_mapping_rules.json
    function classifyArchetype(categorized) {
        const allTalents = [...categorized.dominant, ...categorized.supporting, ...categorized.managing];

        // Step 1: Initialize archetype scores
        const archetypeScores = {};
        Object.keys(ARCHETYPE_DEFINITIONS).forEach(archetypeId => {
            archetypeScores[archetypeId] = 0;
        });

        // Step 2: Calculate talent-based scores with weighted pattern matching
        const weightDistribution = { rank_1: 0.4, rank_2: 0.3, rank_3: 0.2, rank_4: 0.1 };

        allTalents.forEach((talent, index) => {
            let weight = 0;
            if (index < 4) {
                weight = Object.values(weightDistribution)[index];
            } else {
                weight = 0.02; // Minimal weight for other talents
            }

            Object.keys(ARCHETYPE_DEFINITIONS).forEach(archetypeId => {
                let affinity = 0;
                const archetype = ARCHETYPE_DEFINITIONS[archetypeId];

                // Check primary/secondary talent matches
                if (archetype.primary_talents && archetype.primary_talents.includes(talent.id)) {
                    affinity = 1.0;
                } else if (archetype.secondary_talents && archetype.secondary_talents.includes(talent.id)) {
                    affinity = 0.7;
                } else {
                    // Use domain affinity from mapping rules
                    const mappingRules = TALENT_MAPPING_RULES.mapping_rules;
                    if (mappingRules && mappingRules.domain_preference_scoring) {
                        const domainScoring = mappingRules.domain_preference_scoring[talent.domain];
                        if (domainScoring && domainScoring.archetype_affinity) {
                            affinity = domainScoring.archetype_affinity[archetypeId] || 0;
                        }
                    }
                }

                // Calculate weighted contribution
                const contribution = (talent.score / 100) * weight * affinity;
                archetypeScores[archetypeId] += contribution;
            });
        });

        // Step 3: Apply pattern bonuses for specific talent combinations
        Object.keys(ARCHETYPE_DEFINITIONS).forEach(archetypeId => {
            const mappingRules = TALENT_MAPPING_RULES.mapping_rules;
            const indicators = mappingRules?.specific_talent_indicators?.[`${archetypeId}_indicators`];

            if (indicators && indicators.must_have && indicators.threshold) {
                const topTalentIds = categorized.dominant.map(t => t.id);
                const mustHaveCount = indicators.must_have.filter(talentId =>
                    topTalentIds.includes(talentId)
                ).length;

                const mustHaveRatio = mustHaveCount / indicators.must_have.length;

                if (mustHaveRatio >= (indicators.threshold || 0.5)) {
                    const bonusMultiplier = mappingRules?.classification_algorithm?.step_3_pattern_matching?.bonus_multiplier || 1.5;
                    archetypeScores[archetypeId] *= bonusMultiplier;
                }
            }
        });

        // Step 4: Normalize to probabilities
        const totalScore = Object.values(archetypeScores).reduce((sum, score) => sum + score, 0);
        const archetypeProbabilities = {};

        if (totalScore > 0) {
            Object.keys(archetypeScores).forEach(archetypeId => {
                archetypeProbabilities[archetypeId] = archetypeScores[archetypeId] / totalScore;
            });
        } else {
            // Equal probabilities as fallback
            const equalProb = 1 / Object.keys(ARCHETYPE_DEFINITIONS).length;
            Object.keys(ARCHETYPE_DEFINITIONS).forEach(archetypeId => {
                archetypeProbabilities[archetypeId] = equalProb;
            });
        }

        // Step 5: Determine primary and secondary archetypes
        const sortedArchetypes = Object.entries(archetypeProbabilities)
            .sort(([,a], [,b]) => b - a);

        const primaryArchetype = sortedArchetypes[0];
        const secondaryArchetype = sortedArchetypes.length > 1 ? sortedArchetypes[1] : [null, 0];

        // Step 6: Calculate confidence based on margin and pattern strength
        let confidence = 'low';
        if (primaryArchetype[1] > 0.45) {
            confidence = 'high';
        } else if (primaryArchetype[1] > 0.35) {
            confidence = 'medium';
        }

        return {
            primary: {
                id: primaryArchetype[0],
                name: ARCHETYPE_DEFINITIONS[primaryArchetype[0]]?.name || primaryArchetype[0],
                probability: primaryArchetype[1],
                confidence: confidence,
                definition: ARCHETYPE_DEFINITIONS[primaryArchetype[0]]
            },
            secondary: secondaryArchetype[0] ? {
                id: secondaryArchetype[0],
                name: ARCHETYPE_DEFINITIONS[secondaryArchetype[0]]?.name || secondaryArchetype[0],
                probability: secondaryArchetype[1],
                definition: ARCHETYPE_DEFINITIONS[secondaryArchetype[0]]
            } : null,
            all_scores: archetypeProbabilities,
            supporting_talents: categorized.dominant.map(t => t.id),
            raw_scores: archetypeScores
        };
    }

    // Update the persona UI with dynamic archetype results
    function updatePersonaUI(archetypeResult) {
        const primary = archetypeResult.primary;
        const secondary = archetypeResult.secondary;

        // Update main description with detailed analysis
        const descriptionEl = document.getElementById('personaDescription');
        const confidenceColor = primary.confidence === 'high' ? 'var(--success-green)' :
                               primary.confidence === 'medium' ? 'var(--data-orange)' : 'var(--alert-red)';

        const confidenceText = primary.confidence === 'high' ? '高信心' :
                              primary.confidence === 'medium' ? '中信心' : '低信心';

        descriptionEl.innerHTML = `
            <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 16px;">
                <span style="background: ${confidenceColor}; color: white; padding: 4px 12px; border-radius: 16px; font-size: 11px; font-weight: 600; text-transform: uppercase;">
                    ${Math.round(primary.probability * 100)}% 匹配 | ${confidenceText}
                </span>
                <span style="padding: 2px 8px; background: var(--gray-100); border-radius: 12px; font-size: 11px; color: var(--gray-600);">
                    ${primary.definition?.keirsey_temperament || ''}
                </span>
            </div>
            <div style="margin-bottom: 12px; font-weight: 600; color: var(--mckinsey-navy); font-size: 18px;">
                ${primary.name}
            </div>
            <div style="line-height: 1.6; margin-bottom: 12px;">
                ${primary.definition?.description || ''}
            </div>
            <div style="padding: 12px; background: var(--mckinsey-light-blue); border-radius: 6px; font-size: 13px; line-height: 1.5; border-left: 3px solid var(--mckinsey-blue);">
                <strong>核心驅動:</strong> ${primary.definition?.core_drive || '載入中...'}
            </div>
            ${secondary && secondary.probability > 0.18 ? `
                <div style="margin-top: 16px; padding: 12px; background: var(--gray-50); border-radius: 6px; font-size: 13px; border-left: 3px solid var(--gray-400);">
                    <strong>次要特質:</strong> ${secondary.name} (${Math.round(secondary.probability * 100)}%)
                    <div style="margin-top: 4px; color: var(--gray-600); font-size: 12px;">
                        您同時展現 ${secondary.definition?.name || secondary.name} 的特質
                    </div>
                </div>
            ` : ''}
        `;

        // Update content areas with dynamic data
        const roles = primary.definition?.career_suggestions || ['載入中...'];
        const contexts = [
            primary.definition?.work_environment || '載入中...',
            primary.definition?.leadership_style || ''
        ].filter(item => item);
        const tips = generateDevelopmentTips(primary, secondary, archetypeResult);

        updateArchetypeLists(roles, contexts, tips);
    }

    // Generate development tips based on archetype analysis
    function generateDevelopmentTips(primary, secondary, archetypeResult) {
        const tips = [];

        // Core talent reinforcement
        if (archetypeResult.supporting_talents.length > 0) {
            const topTalents = archetypeResult.supporting_talents.slice(0, 3);
            tips.push(`發揮您的 ${topTalents.join('、')} 才幹組合優勢`);
        }

        // Development based on confidence level
        if (primary.confidence === 'low') {
            if (secondary) {
                tips.push(`您的才幹組合較為多元，可探索 ${secondary.name} 領域的發展機會`);
            } else {
                tips.push('您具備均衡的才幹分布，適合多元發展路徑');
            }
        } else if (primary.confidence === 'high') {
            tips.push(`深化您的 ${primary.name} 專業，建立此領域的專家聲譽`);
        }

        // Domain-specific suggestions
        if (primary.definition?.domain_preference) {
            const domains = primary.definition.domain_preference.split(' + ').join(' 和 ');
            tips.push(`重點發展 ${domains} 相關的核心技能`);
        }

        // Pattern-specific advice
        if (primary.definition?.primary_talents) {
            const hasPattern = primary.definition.primary_talents.some(talentId =>
                archetypeResult.supporting_talents.includes(talentId)
            );
            if (hasPattern) {
                tips.push(`您具備 ${primary.name} 的核心才幹模式，建議承接相應的挑戰項目`);
            }
        }

        return tips.length > 0 ? tips : ['持續發揮您的獨特才幹組合優勢'];
    }

    // Helper function to update archetype content lists
    function updateArchetypeLists(roles, contexts, tips) {
        // Update suggested roles
        const rolesContainer = document.getElementById('suggestedRoles');
        rolesContainer.innerHTML = '';
        (roles || []).forEach(role => {
            if (role) {
                const li = document.createElement('li');
                li.textContent = role;
                rolesContainer.appendChild(li);
            }
        });

        // Update key contexts
        const contextsContainer = document.getElementById('keyContexts');
        contextsContainer.innerHTML = '';
        (contexts || []).forEach(context => {
            if (context && context.trim()) {
                const li = document.createElement('li');
                li.textContent = context;
                contextsContainer.appendChild(li);
            }
        });

        // Update development tips
        const tipsContainer = document.getElementById('developmentTips');
        tipsContainer.innerHTML = '';
        (tips || []).forEach(tip => {
            if (tip && tip.trim()) {
                const li = document.createElement('li');
                li.textContent = tip;
                tipsContainer.appendChild(li);
            }
        });
    }

    // Show loading
    function showLoading() {
        document.getElementById('loadingState').classList.add('active');
    }

    // Hide loading
    function hideLoading() {
        document.getElementById('loadingState').classList.remove('active');
    }

    // Show error
    function showError(message) {
        document.getElementById('errorMessage').textContent = message;
        document.getElementById('errorState').classList.add('active');
        hideLoading();
    }

    // Utility functions
    function downloadPDF() {
        const sessionId = getSessionId();
        alert(`PDF 下載功能開發中，Session: ${sessionId}`);
    }

    function shareReport() {
        const sessionId = getSessionId();
        const url = window.location.href;

        if (navigator.share) {
            navigator.share({
                title: '我的優勢天賦評測結果',
                text: '我剛完成了專業的優勢天賦評測，發現了獨特的競爭優勢！',
                url: url
            }).catch(console.error);
        } else {
            navigator.clipboard.writeText(url);
            alert('報告連結已複製到剪貼板！');
        }
    }
  </script>
</body>
</html>

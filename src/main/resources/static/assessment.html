<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è©•æ¸¬åŸ·è¡Œ | é¡§å•å¼é«”é©—</title>
  <meta name="description" content="McKinsey é¡§å•é¢¨æ ¼çš„è©•æ¸¬ä»‹é¢ï¼Œæä¾›æ¸…æ™°æµç¨‹èˆ‡è¡Œç‚ºå¿ƒç†å°å‘çš„å¼•å°ï¼Œå¿«é€Ÿå®Œæˆå››é¸äºŒè©•æ¸¬ã€‚" />
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <header class="global-header">
    <div class="layout">
      <a href="landing.html" class="brand">Strength DNA Lab</a>
      <nav>
        <ul class="nav-list">
          <li><a class="nav-link" href="landing.html">é¦–é </a></li>
          <li><a class="nav-link" href="assessment-intro.html">è©•æ¸¬æº–å‚™</a></li>
          <li><a class="nav-link active" href="assessment.html">é€²å…¥è©•æ¸¬</a></li>
          <li><a class="nav-link" href="results.html">æˆæœç¤ºæ„</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="page assessment-page">
    <div class="layout assessment-stage">
      <div class="progress-header">
        <div class="progress-container">
          <div class="progress-info">
            <div class="progress-title">å„ªå‹¢å¤©è³¦è©•æ¸¬</div>
            <div class="progress-stats">
              <span id="questionCounter">å•é¡Œ 1 / 30</span>
              <span id="timeRemaining">é è¨ˆå‰©é¤˜ 5 åˆ†é˜</span>
            </div>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%">
              <span class="progress-percentage" id="progressPercentage">0%</span>
            </div>
          </div>
        </div>
        <div class="progress-note">
          ğŸ§­ ç›´è¦ºä½œç­”ã€å¹³å‡ 3-5 åˆ†é˜ Â· éš¨æ™‚å¯è¿”å›ä¸Šä¸€é¡Œèª¿æ•´
        </div>
      </div>

      <div class="assessment-container">
        <div class="welcome-screen" id="welcomeScreen">
          <p class="eyebrow">Step 3 Â· Assessment</p>
          <h1 class="welcome-title">æ­¡è¿é€²å…¥é¡§å•å¼è©•æ¸¬é«”é©—</h1>
          <p class="welcome-subtitle">3-5 åˆ†é˜ï¼Œé€éå››é¸äºŒé¡Œçµ„ï¼Œèƒå–ä½ çš„å„ªå‹¢ DNA</p>

          <div class="feature-list">
            <div class="feature-item">
              <span class="feature-icon">ğŸ§­</span>
              <span>é¡§å•å¼æµç¨‹è¨­è¨ˆï¼Œè¡Œç‚ºå¿ƒç†å¼•å°é™ä½ä½œç­”å£“åŠ›</span>
            </div>
            <div class="feature-item">
              <span class="feature-icon">ğŸ§¬</span>
              <span>æ¯é¡Œå°æ‡‰ 12 ç¶­åº¦ï¼Œç¢ºä¿ T1-T12 å…¨é¢è¦†è“‹</span>
            </div>
            <div class="feature-item">
              <span class="feature-icon">âš¡</span>
              <span>å³æ™‚è¨ˆç®—ï¼Œå®Œæˆå¾Œç«‹å³é€²å…¥çµæœé </span>
            </div>
            <div class="feature-item">
              <span class="feature-icon">ğŸ”’</span>
              <span>æœ¬åœ° FileStorage å„²å­˜ï¼Œè³‡æ–™è‡ªä¸»å¯æ§</span>
            </div>
          </div>

          <button class="btn-primary" onclick="startAssessment()">
            é–‹å§‹é¡§å•å¼è©•æ¸¬ â†’
          </button>
        </div>

        <div class="question-card" id="questionCard" style="display: none;">
          <div class="question-header">
            <span class="question-number" id="questionNumber">ç¬¬ 1 é¡Œ</span>
            <h2 class="question-text" id="questionText">è«‹é¸æ“‡æœ€ç¬¦åˆå’Œæœ€ä¸ç¬¦åˆä½ çš„é¸é …</h2>
            <p class="question-instruction">è«‹å¾ä»¥ä¸‹ 4 å€‹é¸é …ä¸­ï¼Œé¸æ“‡ 1 å€‹ã€Œæœ€åƒæˆ‘ã€å’Œ 1 å€‹ã€Œæœ€ä¸åƒæˆ‘ã€</p>
          </div>
          <div class="statements-grid" id="statementsGrid"></div>
        </div>

        <div class="selection-status" id="selectionStatus" style="display: none;" aria-live="polite">
          <div class="selection-item">
            <span class="selection-label">æœ€åƒæˆ‘ï¼š</span>
            <span class="selection-value selection-most" id="mostLikeSelection">æœªé¸æ“‡</span>
          </div>
          <div class="selection-item">
            <span class="selection-label">æœ€ä¸åƒæˆ‘ï¼š</span>
            <span class="selection-value selection-least" id="leastLikeSelection">æœªé¸æ“‡</span>
          </div>
        </div>

        <div class="action-buttons" id="actionButtons" style="display: none;">
          <button class="btn-secondary" id="prevBtn" onclick="previousQuestion()" disabled>â† ä¸Šä¸€é¡Œ</button>
          <button class="btn-primary" id="nextBtn" onclick="nextQuestion()" disabled>ä¸‹ä¸€é¡Œ â†’</button>
        </div>

        <div class="encouragement" id="encouragement" style="display: none;">
          <span class="encouragement-icon">ğŸ’¡</span>
          <span class="encouragement-text">æ†‘ç¬¬ä¸€ç›´è¦ºä½œç­”ï¼Œæ²’æœ‰æ¨™æº–ç­”æ¡ˆ â€” ç›®çš„åœ¨æ–¼æ‰¾å‡ºä½ çš„å„ªå‹¢åå¥½</span>
        </div>

        <div class="loading" id="loadingState">
          <div class="spinner"></div>
          <p>æ­£åœ¨æº–å‚™ä½ çš„å°ˆå±¬å ±å‘Š...</p>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="layout">
      <div class="footer__meta">
        <strong class="brand">Strength DNA Lab</strong>
        <span>Step 3 Â· Assessment Â· å¼·è¿«é¸æ“‡æµç¨‹</span>
        <div class="footer__links">
          <a href="assessment-intro.html">å›åˆ°æº–å‚™é </a>
          <a href="results.html">é è¦½çµæœé </a>
          <a href="report-detail.html">æ·±å…¥å ±å‘Š</a>
        </div>
      </div>
    </div>
  </footer>

  <script>
    const apiBase = window.location.port === '8005' ? '' : `http://${window.location.hostname}:8005`;

    let currentQuestion = 0;
    let totalQuestions = 30;
    let responses = [];
    let sessionId = null;
    let startTime = null;
    let questions = [];
    let timerInterval = null;
    let estimatedEndTime = null;

    const sampleQuestions = [
      {
        id: 'q1',
        statements: [
          { id: 's1', text: 'æˆ‘å–œæ­¡åœ¨åœ˜éšŠä¸­é ˜å°ä»–äººå®Œæˆä»»å‹™', dimension: 'leadership' },
          { id: 's2', text: 'æˆ‘æ›´é¡˜æ„æ·±å…¥åˆ†æå•é¡Œæ‰¾å‡ºæœ€ä½³è§£æ±ºæ–¹æ¡ˆ', dimension: 'analytical' },
          { id: 's3', text: 'æˆ‘æ“…é•·æ¿€å‹µä»–äººä¸¦å»ºç«‹è‰¯å¥½çš„äººéš›é—œä¿‚', dimension: 'relationship' },
          { id: 's4', text: 'æˆ‘æ³¨é‡ç´°ç¯€ä¸¦ç¢ºä¿ä¸€åˆ‡æŒ‰è¨ˆåŠƒåŸ·è¡Œ', dimension: 'execution' }
        ]
      }
    ];

    async function initAssessment() {
      try {
        const response = await fetch(`${apiBase}/api/assessment/blocks?v=1`);
        if (response.ok) {
          const data = await response.json();
          sessionId = data.session_id;

          questions = data.blocks.map(block => ({
            id: `q${block.block_id}`,
            block_id: block.block_id,
            statements: block.statements.map((stmt, idx) => ({
              id: stmt.id,
              text: stmt.text,
              dimension: stmt.dimension,
              index: idx
            }))
          }));

          totalQuestions = questions.length;

          if (totalQuestions < 9) {
            console.warn(`Warning: Only ${totalQuestions} blocks loaded, may not cover all T1-T12 dimensions`);
          }
        } else {
          throw new Error('Failed to load blocks from API');
        }
      } catch (error) {
        console.error('Error loading blocks:', error);
        if (error.message && error.message.includes('Unexpected token')) {
          alert('ç„¡æ³•è¼‰å…¥æ¸¬é©—é¡Œç›®ï¼šAPI ç«¯é»ä¸å­˜åœ¨');
        } else {
          sessionId = generateSessionId();
          questions = sampleQuestions;
          totalQuestions = 30; // ä¿æŒ30é¡Œå³ä½¿åœ¨é›¢ç·šæ¨¡å¼
        }
      }
    }

    async function startAssessment() {
      startTime = new Date();
      if (!sessionId) {
        sessionId = generateSessionId();
      }

      document.getElementById('welcomeScreen').style.display = 'none';
      document.getElementById('questionCard').style.display = 'block';
      document.getElementById('selectionStatus').style.display = 'flex';
      document.getElementById('actionButtons').style.display = 'flex';
      document.getElementById('encouragement').style.display = 'flex';

      loadQuestion(0);

      trackEvent('assessment_started', {
        session_id: sessionId,
        timestamp: startTime.toISOString()
      });
    }

    function loadQuestion(index) {
      if (index >= questions.length) {
        questions = sampleQuestions;
      }

      const question = questions[index] || sampleQuestions[0];
      currentQuestion = index;
      updateProgress();

      document.getElementById('questionNumber').textContent = `ç¬¬ ${index + 1} é¡Œ`;
      document.getElementById('questionText').textContent = 'è«‹é¸æ“‡æœ€ç¬¦åˆå’Œæœ€ä¸ç¬¦åˆä½ çš„é¸é …';

      clearSelections();

      const grid = document.getElementById('statementsGrid');
      grid.innerHTML = '';

      question.statements.forEach((statement, idx) => {
        const card = createStatementCard(statement, idx);
        grid.appendChild(card);
      });

      if (!responses[currentQuestion]) {
        responses[currentQuestion] = {
          question_id: question.id,
          most_like_index: null,
          least_like_index: null,
          block_id: question.block_id || index + 1
        };
      } else {
        restoreSelections(responses[currentQuestion]);
      }

      document.getElementById('prevBtn').disabled = index === 0;
      checkSelectionComplete();
    }

    function createStatementCard(statement, index) {
      const card = document.createElement('div');
      card.className = 'statement-card';
      card.dataset.statementId = statement.id;
      card.dataset.index = index;

      card.onclick = () => handleStatementClick(index, statement);

      card.innerHTML = `
        <div class="statement-letter">${String.fromCharCode(65 + index)}</div>
        <div class="statement-text">${statement.text}</div>
        <span class="statement-badge badge-most hidden">æœ€åƒæˆ‘</span>
        <span class="statement-badge badge-least hidden">æœ€ä¸åƒæˆ‘</span>
      `;

      return card;
    }

    function handleStatementClick(index, statement) {
      const currentResponse = responses[currentQuestion] || {
        most_like_index: null,
        least_like_index: null
      };

      const card = document.querySelectorAll('.statement-card')[index];

      if (currentResponse.most_like_index === index) {
        currentResponse.most_like_index = null;
        card.classList.remove('selected-most');
        card.querySelector('.badge-most').classList.add('hidden');
        document.getElementById('mostLikeSelection').textContent = 'æœªé¸æ“‡';
      }
      else if (currentResponse.least_like_index === index) {
        currentResponse.least_like_index = null;
        card.classList.remove('selected-least');
        card.querySelector('.badge-least').classList.add('hidden');
        document.getElementById('leastLikeSelection').textContent = 'æœªé¸æ“‡';
      }
      else if (currentResponse.most_like_index === null) {
        document.querySelectorAll('.statement-card').forEach((c, i) => {
          if (i === currentResponse.most_like_index) {
            c.classList.remove('selected-most');
            c.querySelector('.badge-most').classList.add('hidden');
          }
        });

        currentResponse.most_like_index = index;
        card.classList.add('selected-most');
        card.querySelector('.badge-most').classList.remove('hidden');
        document.getElementById('mostLikeSelection').textContent =
          statement.text.substring(0, 30) + '...';
      }
      else if (currentResponse.least_like_index === null) {
        document.querySelectorAll('.statement-card').forEach((c, i) => {
          if (i === currentResponse.least_like_index) {
            c.classList.remove('selected-least');
            c.querySelector('.badge-least').classList.add('hidden');
          }
        });

        currentResponse.least_like_index = index;
        card.classList.add('selected-least');
        card.querySelector('.badge-least').classList.remove('hidden');
        document.getElementById('leastLikeSelection').textContent =
          statement.text.substring(0, 30) + '...';
      }
      else {
        alert('è«‹å…ˆå–æ¶ˆå…¶ä¸­ä¸€å€‹é¸æ“‡ï¼Œå†é¸æ“‡æ–°çš„é¸é …');
      }

      responses[currentQuestion] = currentResponse;
      checkSelectionComplete();
    }

    function restoreSelections(savedResponse) {
      if (!savedResponse) return;

      const cards = document.querySelectorAll('.statement-card');

      if (savedResponse.most_like_index !== null && savedResponse.most_like_index !== undefined) {
        const mostCard = cards[savedResponse.most_like_index];
        if (mostCard) {
          mostCard.classList.add('selected-most');
          mostCard.querySelector('.badge-most').classList.remove('hidden');
          const statement = mostCard.querySelector('.statement-text').textContent;
          document.getElementById('mostLikeSelection').textContent = statement.substring(0, 30) + '...';
        }
      }

      if (savedResponse.least_like_index !== null && savedResponse.least_like_index !== undefined) {
        const leastCard = cards[savedResponse.least_like_index];
        if (leastCard) {
          leastCard.classList.add('selected-least');
          leastCard.querySelector('.badge-least').classList.remove('hidden');
          const statement = leastCard.querySelector('.statement-text').textContent;
          document.getElementById('leastLikeSelection').textContent = statement.substring(0, 30) + '...';
        }
      }
    }

    function selectChoice(statementId, type, button) {
      const card = button.closest('.statement-card');
      const oppositeType = type === 'most' ? 'least' : 'most';

      if (card.classList.contains(`selected-${oppositeType}`)) {
        alert(`æ­¤é¸é …å·²è¢«é¸ç‚ºã€Œ${oppositeType === 'most' ? 'æœ€åƒæˆ‘' : 'æœ€ä¸åƒæˆ‘'}ã€ï¼Œè«‹é¸æ“‡å…¶ä»–é¸é …`);
        return;
      }

      document.querySelectorAll(`.btn-${type === 'most' ? 'most' : 'least'}.selected`).forEach(btn => {
        btn.classList.remove('selected');
      });
      document.querySelectorAll(`.selected-${type === 'most' ? 'most' : 'least'}`).forEach(card => {
        card.classList.remove(`selected-${type === 'most' ? 'most' : 'least'}`);
      });

      button.classList.add('selected');
      button.closest('.statement-card').classList.add(`selected-${type === 'most' ? 'most' : 'least'}`);

      if (!responses[currentQuestion]) {
        responses[currentQuestion] = {};
      }
      const cards = Array.from(document.querySelectorAll('.statement-card'));
      const cardIndex = cards.indexOf(card);

      if (type === 'most') {
        responses[currentQuestion].most_like_index = cardIndex;
      } else {
        responses[currentQuestion].least_like_index = cardIndex;
      }

      const statement = button.closest('.statement-card').querySelector('.statement-text').textContent;
      if (type === 'most') {
        document.getElementById('mostLikeSelection').textContent = statement.substring(0, 20) + '...';
      } else {
        document.getElementById('leastLikeSelection').textContent = statement.substring(0, 20) + '...';
      }

      checkSelectionComplete();
    }

    function checkSelectionComplete() {
      const currentResponse = responses[currentQuestion] || {};
      const hasMost = currentResponse.most_like_index !== null && currentResponse.most_like_index !== undefined;
      const hasLeast = currentResponse.least_like_index !== null && currentResponse.least_like_index !== undefined;

      document.getElementById('nextBtn').disabled = !(hasMost && hasLeast);
    }

    function clearSelections() {
      document.querySelectorAll('.choice-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      document.querySelectorAll('.statement-card').forEach(card => {
        card.classList.remove('selected-most', 'selected-least');
        const badges = card.querySelectorAll('.statement-badge');
        badges.forEach(badge => badge.classList.add('hidden'));
      });
      document.getElementById('mostLikeSelection').textContent = 'æœªé¸æ“‡';
      document.getElementById('leastLikeSelection').textContent = 'æœªé¸æ“‡';
    }

    function nextQuestion() {
      const currentResponse = responses[currentQuestion] || {};

      if (currentResponse.most_like_index === null || currentResponse.most_like_index === undefined ||
          currentResponse.least_like_index === null || currentResponse.least_like_index === undefined) {
        alert('è«‹é¸æ“‡æœ€åƒå’Œæœ€ä¸åƒçš„é¸é …');
        return;
      }

      responses[currentQuestion] = {
        ...currentResponse,
        block_id: currentQuestion,
        response_time_ms: Date.now() - (startTime?.getTime() || Date.now())
      };

      if (currentQuestion < totalQuestions - 1) {
        loadQuestion(currentQuestion + 1);
      } else {
        submitAssessment();
      }
    }

    function previousQuestion() {
      if (currentQuestion > 0) {
        loadQuestion(currentQuestion - 1);
      }
    }

    function startTimer() {
      if (timerInterval) clearInterval(timerInterval);

      const avgTimePerQuestion = 25;
      const remainingQuestions = totalQuestions - currentQuestion;
      const estimatedRemainingMs = remainingQuestions * avgTimePerQuestion * 1000;
      estimatedEndTime = Date.now() + estimatedRemainingMs;

      timerInterval = setInterval(updateTimer, 1000);
      updateTimer(); // ç«‹å³æ›´æ–°ä¸€æ¬¡
    }

    function updateTimer() {
      if (!estimatedEndTime) return;

      const now = Date.now();
      const remainingMs = Math.max(0, estimatedEndTime - now);
      const remainingSeconds = Math.floor(remainingMs / 1000);
      const minutes = Math.floor(remainingSeconds / 60);
      const seconds = remainingSeconds % 60;

      document.getElementById('timeRemaining').textContent =
        `é è¨ˆå‰©é¤˜ ${minutes}:${seconds.toString().padStart(2, '0')}`;

      if (remainingMs <= 0) {
        clearInterval(timerInterval);
        document.getElementById('timeRemaining').textContent = 'æ™‚é–“åˆ°ï¼';
      }
    }

    function updateProgress() {
      const progress = ((currentQuestion + 1) / totalQuestions) * 100;
      document.getElementById('progressFill').style.width = `${progress}%`;
      document.getElementById('progressPercentage').textContent = `${Math.round(progress)}%`;
      document.getElementById('questionCounter').textContent = `å•é¡Œ ${currentQuestion + 1} / ${totalQuestions}`;

      // é‡æ–°è¨ˆç®—ä¸¦å•Ÿå‹•è¨ˆæ™‚å™¨
      startTimer();
    }

    async function submitAssessment() {
      // æ¸…ç†è¨ˆæ™‚å™¨
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }

      document.getElementById('questionCard').style.display = 'none';
      document.getElementById('selectionStatus').style.display = 'none';
      document.getElementById('actionButtons').style.display = 'none';
      document.getElementById('encouragement').style.display = 'none';
      document.getElementById('loadingState').classList.add('active');

      const endTime = new Date();
      const completionTime = Math.round((endTime - startTime) / 1000);

      try {
        const response = await fetch(`${apiBase}/api/assessment/submit?v=1`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            session_id: sessionId,
            responses: responses.filter(r => r !== undefined),
            completion_time_seconds: completionTime
          })
        });

        if (response.ok) {
          await response.json();
          window.location.href = `/results.html?session=${sessionId}`;
        } else {
          const errorData = await response.json();
          console.error('API Error:', errorData);
          alert(`æäº¤å¤±æ•—: ${errorData.error?.message || 'æœªçŸ¥éŒ¯èª¤'}`);
          document.getElementById('loadingState').classList.remove('active');
          document.getElementById('questionCard').style.display = 'block';
          document.getElementById('actionButtons').style.display = 'flex';
        }
      } catch (error) {
        console.error('Submission error:', error);
        if (error.message && error.message.includes('Unexpected token')) {
          alert('API ç«¯é»ä¸å­˜åœ¨æˆ–è·¯å¾‘éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç³»çµ±è¨­å®š');
        } else {
          alert(`ç¶²è·¯éŒ¯èª¤: ${error.message}`);
        }
        document.getElementById('loadingState').classList.remove('active');
        document.getElementById('questionCard').style.display = 'block';
        document.getElementById('actionButtons').style.display = 'flex';
      }
    }

    function generateSessionId() {
      return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function trackEvent(eventName, data) {
      if (typeof gtag !== 'undefined') {
        gtag('event', eventName, data);
      }
      console.log('Event:', eventName, data);
    }

    window.addEventListener('DOMContentLoaded', () => {
      initAssessment();
    });
  </script>
</body>
</html>

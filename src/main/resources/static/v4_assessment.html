<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallup 優勢測驗 v4.0 - 四選二強制選擇</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2563eb;
            --secondary-color: #10b981;
            --danger-color: #ef4444;
            --dark: #1f2937;
            --gray: #6b7280;
            --light-gray: #f3f4f6;
            --white: #ffffff;
            --most-like: #059669;
            --least-like: #dc2626;
            --selected-bg: #f0fdf4;
            --selected-border: #86efac;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            line-height: 1.6;
        }

        .assessment-container {
            background: var(--white);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 900px;
            width: 100%;
            padding: 40px;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: var(--dark);
            font-size: 2rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header .version-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-left: 10px;
            font-weight: 500;
        }

        /* Progress Bar */
        .progress-container {
            margin-bottom: 30px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: var(--gray);
            font-size: 0.9rem;
        }

        .progress-bar {
            height: 10px;
            background: var(--light-gray);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 5px;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Instructions */
        .instructions {
            background: var(--light-gray);
            border-left: 4px solid var(--primary-color);
            padding: 15px 20px;
            margin-bottom: 30px;
            border-radius: 8px;
        }

        .instructions h3 {
            color: var(--dark);
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .instructions p {
            color: var(--gray);
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .instructions .steps {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .instructions .step {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .instructions .step-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 0.9rem;
        }

        .step-icon.most { background: var(--most-like); }
        .step-icon.least { background: var(--least-like); }

        /* Question Block */
        .question-block {
            margin-bottom: 30px;
        }

        .block-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .block-number {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .block-title {
            color: var(--dark);
            font-size: 1.3rem;
            font-weight: 600;
        }

        /* Statements Grid */
        .statements-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .statements-grid {
                grid-template-columns: 1fr;
            }
        }

        .statement-card {
            background: var(--white);
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .statement-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .statement-text {
            color: var(--dark);
            font-size: 1rem;
            line-height: 1.6;
            text-align: center;
        }

        .statement-index {
            position: absolute;
            top: 10px;
            left: 15px;
            width: 24px;
            height: 24px;
            background: var(--light-gray);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: var(--gray);
            font-weight: 600;
        }

        /* Selection States */
        .statement-card.most-like {
            background: #f0fdf4;
            border-color: var(--most-like);
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }

        .statement-card.most-like .selection-badge {
            background: var(--most-like);
        }

        .statement-card.least-like {
            background: #fef2f2;
            border-color: var(--least-like);
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .statement-card.least-like .selection-badge {
            background: var(--least-like);
        }

        .statement-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .selection-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            padding: 4px 12px;
            border-radius: 20px;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            display: none;
        }

        .statement-card.most-like .selection-badge,
        .statement-card.least-like .selection-badge {
            display: block;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--gray);
            border: 2px solid #e5e7eb;
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--light-gray);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-clear {
            background: transparent;
            color: var(--gray);
            border: none;
            font-size: 0.9rem;
            padding: 8px 16px;
        }

        .btn-clear:hover {
            color: var(--dark);
        }

        /* Selection Summary */
        .selection-summary {
            background: var(--light-gray);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }

        .selection-summary.visible {
            display: block;
        }

        .selection-summary h4 {
            color: var(--dark);
            font-size: 0.95rem;
            margin-bottom: 10px;
        }

        .selection-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .selection-label {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
        }

        .selection-label.most { background: var(--most-like); }
        .selection-label.least { background: var(--least-like); }

        /* Loading State */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--white);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Completion Screen */
        .completion-screen {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .completion-screen.active {
            display: block;
        }

        .completion-icon {
            width: 80px;
            height: 80px;
            background: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 2.5rem;
            color: white;
        }

        .completion-title {
            color: var(--dark);
            font-size: 1.8rem;
            margin-bottom: 15px;
        }

        .completion-message {
            color: var(--gray);
            font-size: 1.1rem;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="assessment-container">
        <!-- Header -->
        <div class="header">
            <h1>
                優勢評估測驗
                <span class="version-badge">v4.0 Beta</span>
            </h1>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-info">
                <span>進度</span>
                <span id="progressText">第 1 題 / 共 30 題</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 3.33%"></div>
            </div>
        </div>

        <!-- Main Assessment Area -->
        <div id="assessmentArea">
            <!-- Instructions -->
            <div class="instructions">
                <h3>請選擇最符合與最不符合您的描述</h3>
                <p>請仔細閱讀以下四個描述，選擇一個<strong>最符合</strong>您的描述，以及一個<strong>最不符合</strong>您的描述。</p>
                <div class="steps">
                    <div class="step">
                        <div class="step-icon most">1</div>
                        <span>選擇<strong>最像我</strong></span>
                    </div>
                    <div class="step">
                        <div class="step-icon least">2</div>
                        <span>選擇<strong>最不像我</strong></span>
                    </div>
                </div>
            </div>

            <!-- Question Block -->
            <div class="question-block">
                <div class="block-header">
                    <div class="block-number">區塊 <span id="blockNumber">1</span></div>
                    <div class="block-title">請從以下描述中進行選擇</div>
                </div>

                <!-- Statements Grid -->
                <div class="statements-grid" id="statementsGrid">
                    <!-- Statements will be dynamically inserted here -->
                </div>

                <!-- Selection Summary -->
                <div class="selection-summary" id="selectionSummary">
                    <h4>您的選擇：</h4>
                    <div id="summaryContent"></div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn btn-secondary" id="prevBtn" onclick="previousBlock()" disabled>
                    ← 上一題
                </button>
                <button class="btn btn-clear" id="clearBtn" onclick="clearSelection()">
                    清除選擇
                </button>
                <button class="btn btn-primary" id="nextBtn" onclick="nextBlock()" disabled>
                    下一題 →
                </button>
            </div>
        </div>

        <!-- Completion Screen -->
        <div class="completion-screen" id="completionScreen">
            <div class="completion-icon">✓</div>
            <h2 class="completion-title">測驗完成！</h2>
            <p class="completion-message">
                感謝您完成優勢評估測驗。<br>
                系統正在分析您的回答，請稍候...
            </p>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <script>
        // Assessment Data
        let assessmentData = {
            blocks: [],
            currentBlockIndex: 0,
            responses: [],
            sessionId: generateSessionId(),
            startTime: new Date().toISOString()
        };

        // Current Selection State
        let currentSelection = {
            mostLike: null,
            leastLike: null
        };

        // Generate unique session ID
        function generateSessionId() {
            return 'v4_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Initialize Assessment
        async function initAssessment() {
            try {
                showLoading();
                // Load assessment blocks from API
                const response = await fetch('http://localhost:8004/api/v4/assessment/blocks');
                const data = await response.json();
                assessmentData.blocks = data.blocks;
                hideLoading();
                renderCurrentBlock();
            } catch (error) {
                console.error('Failed to load assessment:', error);
                // Use mock data for testing
                loadMockData();
                renderCurrentBlock();
            }
        }

        // Load Mock Data for Testing
        function loadMockData() {
            assessmentData.blocks = [
                {
                    block_id: 0,
                    statements: [
                        { statement_id: "ACH001", text: "我每天都會列出待辦事項清單並逐項完成", dimension: "Achiever" },
                        { statement_id: "COM001", text: "我能輕鬆地向不同背景的人解釋複雜概念", dimension: "Communication" },
                        { statement_id: "ANA001", text: "我需要充分的數據才能做出決定", dimension: "Analytical" },
                        { statement_id: "ADA001", text: "突發狀況不會讓我感到慌張", dimension: "Adaptability" }
                    ]
                },
                // Add more blocks as needed
            ];

            // Generate 30 mock blocks for testing
            for (let i = 1; i < 30; i++) {
                assessmentData.blocks.push({
                    block_id: i,
                    statements: assessmentData.blocks[0].statements.map(s => ({
                        ...s,
                        statement_id: s.statement_id + '_' + i
                    }))
                });
            }
        }

        // Render Current Block
        function renderCurrentBlock() {
            const block = assessmentData.blocks[assessmentData.currentBlockIndex];
            if (!block) return;

            // Update progress
            updateProgress();

            // Update block number
            document.getElementById('blockNumber').textContent = assessmentData.currentBlockIndex + 1;

            // Render statements
            const grid = document.getElementById('statementsGrid');
            grid.innerHTML = '';

            block.statements.forEach((statement, index) => {
                const card = createStatementCard(statement, index);
                grid.appendChild(card);
            });

            // Update buttons
            updateButtons();

            // Clear current selection
            currentSelection = { mostLike: null, leastLike: null };
            updateSelectionSummary();
        }

        // Create Statement Card
        function createStatementCard(statement, index) {
            const card = document.createElement('div');
            card.className = 'statement-card';
            card.dataset.index = index;
            card.dataset.statementId = statement.statement_id;

            card.innerHTML = `
                <div class="statement-index">${index + 1}</div>
                <div class="statement-text">${statement.text}</div>
                <div class="selection-badge"></div>
            `;

            card.onclick = () => handleStatementClick(index);

            return card;
        }

        // Handle Statement Click
        function handleStatementClick(index) {
            const card = document.querySelectorAll('.statement-card')[index];

            // If already selected as one type, toggle it off
            if (currentSelection.mostLike === index) {
                currentSelection.mostLike = null;
                card.classList.remove('most-like');
                card.querySelector('.selection-badge').textContent = '';
            } else if (currentSelection.leastLike === index) {
                currentSelection.leastLike = null;
                card.classList.remove('least-like');
                card.querySelector('.selection-badge').textContent = '';
            }
            // If not selected, determine which selection to make
            else {
                if (currentSelection.mostLike === null) {
                    // Clear any previous most-like
                    document.querySelectorAll('.statement-card.most-like').forEach(c => {
                        c.classList.remove('most-like');
                        c.querySelector('.selection-badge').textContent = '';
                    });

                    currentSelection.mostLike = index;
                    card.classList.add('most-like');
                    card.querySelector('.selection-badge').textContent = '最像我';
                } else if (currentSelection.leastLike === null) {
                    // Clear any previous least-like
                    document.querySelectorAll('.statement-card.least-like').forEach(c => {
                        c.classList.remove('least-like');
                        c.querySelector('.selection-badge').textContent = '';
                    });

                    currentSelection.leastLike = index;
                    card.classList.add('least-like');
                    card.querySelector('.selection-badge').textContent = '最不像我';
                }
            }

            updateSelectionSummary();
            updateButtons();
        }

        // Update Selection Summary
        function updateSelectionSummary() {
            const summary = document.getElementById('selectionSummary');
            const content = document.getElementById('summaryContent');

            if (currentSelection.mostLike !== null || currentSelection.leastLike !== null) {
                summary.classList.add('visible');
                content.innerHTML = '';

                if (currentSelection.mostLike !== null) {
                    const stmt = assessmentData.blocks[assessmentData.currentBlockIndex].statements[currentSelection.mostLike];
                    content.innerHTML += `
                        <div class="selection-item">
                            <span class="selection-label most">最像我</span>
                            <span>${stmt.text}</span>
                        </div>
                    `;
                }

                if (currentSelection.leastLike !== null) {
                    const stmt = assessmentData.blocks[assessmentData.currentBlockIndex].statements[currentSelection.leastLike];
                    content.innerHTML += `
                        <div class="selection-item">
                            <span class="selection-label least">最不像我</span>
                            <span>${stmt.text}</span>
                        </div>
                    `;
                }
            } else {
                summary.classList.remove('visible');
            }
        }

        // Clear Selection
        function clearSelection() {
            currentSelection = { mostLike: null, leastLike: null };

            document.querySelectorAll('.statement-card').forEach(card => {
                card.classList.remove('most-like', 'least-like');
                card.querySelector('.selection-badge').textContent = '';
            });

            updateSelectionSummary();
            updateButtons();
        }

        // Navigate to Next Block
        function nextBlock() {
            if (currentSelection.mostLike === null || currentSelection.leastLike === null) {
                alert('請選擇一個最符合和一個最不符合的描述');
                return;
            }

            // Save response
            assessmentData.responses.push({
                block_id: assessmentData.currentBlockIndex,
                most_like_index: currentSelection.mostLike,
                least_like_index: currentSelection.leastLike,
                response_time_ms: Date.now() - lastBlockStartTime
            });

            // Move to next block
            if (assessmentData.currentBlockIndex < assessmentData.blocks.length - 1) {
                assessmentData.currentBlockIndex++;
                lastBlockStartTime = Date.now();
                renderCurrentBlock();
            } else {
                completeAssessment();
            }
        }

        // Navigate to Previous Block
        function previousBlock() {
            if (assessmentData.currentBlockIndex > 0) {
                assessmentData.currentBlockIndex--;

                // Load previous response if exists
                const prevResponse = assessmentData.responses[assessmentData.currentBlockIndex];
                if (prevResponse) {
                    currentSelection = {
                        mostLike: prevResponse.most_like_index,
                        leastLike: prevResponse.least_like_index
                    };
                    // Remove the response since we're going back
                    assessmentData.responses.pop();
                }

                renderCurrentBlock();

                // Restore selection visuals
                if (currentSelection.mostLike !== null) {
                    const card = document.querySelectorAll('.statement-card')[currentSelection.mostLike];
                    card.classList.add('most-like');
                    card.querySelector('.selection-badge').textContent = '最像我';
                }
                if (currentSelection.leastLike !== null) {
                    const card = document.querySelectorAll('.statement-card')[currentSelection.leastLike];
                    card.classList.add('least-like');
                    card.querySelector('.selection-badge').textContent = '最不像我';
                }

                updateSelectionSummary();
            }
        }

        // Update Progress Bar
        function updateProgress() {
            const progress = ((assessmentData.currentBlockIndex + 1) / assessmentData.blocks.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent =
                `第 ${assessmentData.currentBlockIndex + 1} 題 / 共 ${assessmentData.blocks.length} 題`;
        }

        // Update Button States
        function updateButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const clearBtn = document.getElementById('clearBtn');

            prevBtn.disabled = assessmentData.currentBlockIndex === 0;
            nextBtn.disabled = currentSelection.mostLike === null || currentSelection.leastLike === null;
            clearBtn.disabled = currentSelection.mostLike === null && currentSelection.leastLike === null;

            // Update next button text for last question
            if (assessmentData.currentBlockIndex === assessmentData.blocks.length - 1) {
                nextBtn.innerHTML = '完成測驗 ✓';
            } else {
                nextBtn.innerHTML = '下一題 →';
            }
        }

        // Complete Assessment
        async function completeAssessment() {
            assessmentData.endTime = new Date().toISOString();

            // Show completion screen
            document.getElementById('assessmentArea').style.display = 'none';
            document.getElementById('completionScreen').classList.add('active');

            // Submit results
            try {
                showLoading();
                const response = await fetch('http://localhost:8004/api/v4/assessment/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: assessmentData.sessionId,
                        responses: assessmentData.responses,
                        start_time: assessmentData.startTime,
                        end_time: assessmentData.endTime
                    })
                });

                const result = await response.json();
                hideLoading();

                // Redirect to results page
                setTimeout(() => {
                    window.location.href = `/results.html?session=${assessmentData.sessionId}`;
                }, 2000);
            } catch (error) {
                console.error('Failed to submit assessment:', error);
                hideLoading();
                alert('提交失敗，請重試');
            }
        }

        // Loading States
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // Track timing
        let lastBlockStartTime = Date.now();

        // Initialize on page load
        window.onload = () => {
            initAssessment();
        };
    </script>
</body>
</html>
# 綜合品質檢查清單 - Gallup 會員系統

---

**文件版本:** `v1.0`
**最後更新:** `2025-10-03`
**主要作者:** `安全工程師, 技術負責人`
**狀態:** `使用中 (In Use)`

---

**審查對象**: Gallup 優勢測驗會員系統 v1.0 (MVP)
**審查日期**: 預定 2025-11-15 (上線前)
**審查人員**: 安全架構師、隱私顧問、技術負責人

---

## A. 核心安全原則

*   `[ ]` **最小權限 (Least Privilege):** 會員僅能存取自己的資料,無法查看其他會員資訊
*   `[ ]` **縱深防禦 (Defense in Depth):** JWT Token + HTTPS + 密碼加密 + 速率限制多層保護
*   `[ ]` **預設安全 (Secure by Default):** 預設隱私設定為拒絕行銷郵件
*   `[ ]` **攻擊面最小化:** 僅開放必要的 API 端點,關閉未使用功能
*   `[ ]` **職責分離:** 會員資料與評測資料分離,降低資料洩漏風險

---

## B. 數據生命週期安全與隱私

### B.1 數據分類與收集

*   `[ ]` **數據分類:**
  - 🔴 **機密資料**: 密碼雜湊、Refresh Token
  - 🟡 **個人識別資訊 (PII)**: Email, 姓名, 公司
  - 🟢 **一般資料**: 才幹分數, 評測統計

*   `[ ]` **數據最小化:** 僅收集註冊必要的 Email 與密碼,其他資料皆為選填
*   `[ ]` **用戶同意:** 註冊前明確告知資料用途,提供隱私政策連結
*   `[ ]` **行銷同意:** 行銷郵件需明確勾選同意 (預設 false)

### B.2 數據傳輸

*   `[ ]` **傳輸加密:** 所有 API 強制 HTTPS (TLS 1.3+)
*   `[ ]` **內部傳輸:** 資料庫連接使用 SSL
*   `[ ]` **證書管理:** 使用 Let's Encrypt 自動更新證書

### B.3 數據儲存

*   `[ ]` **密碼加密:** 使用 bcrypt (cost factor ≥12) 加密密碼
*   `[ ]` **Token 安全:**
  - Access Token 存於 HTTP-only Cookie
  - Refresh Token 僅單向雜湊儲存
*   `[ ]` **資料備份:** 每日自動備份,備份檔加密儲存

### B.4 數據使用與處理

*   `[ ]` **日誌脫敏:** 日誌不記錄密碼、Token 完整內容
*   `[ ]` **第三方共享:** OAuth Token 不儲存,僅取得使用者 ID

### B.5 數據保留與銷毀

*   `[ ]` **保留策略:**
  - 會員資料: 帳號有效期間 + 30 天軟刪除期
  - 審計日誌: 保留 1 年
*   `[ ]` **安全銷毀:** 帳號刪除 30 天後永久清除資料,無法恢復

---

## C. 應用程式安全

### C.1 身份驗證

*   `[ ]` **密碼策略:**
  - 最小長度 8 字元
  - 必須包含大小寫字母與數字
  - 常見弱密碼黑名單檢查

*   `[ ]` **憑證儲存:**
  - 密碼使用 bcrypt (cost ≥12)
  - 絕不明文儲存或傳輸密碼

*   `[ ]` **會話管理:**
  - JWT Token 包含過期時間 (7 天)
  - HTTP-only + Secure Cookie 標誌
  - 登出時撤銷 Refresh Token

*   `[ ]` **暴力破解防護:**
  - 登入失敗 5 次鎖定 15 分鐘
  - IP 速率限制: 5 次/分鐘

### C.2 授權與訪問控制

*   `[ ]` **物件級別授權:** 每個 API 檢查 `member_id` 是否與 Token 一致
*   `[ ]` **功能級別授權:** 所有會員端點需驗證 JWT Token

### C.3 輸入驗證與輸出編碼

*   `[ ]` **防注入攻擊:**
  - 使用 SQLAlchemy ORM 參數化查詢
  - 禁止動態 SQL 拼接

*   `[ ]` **防 XSS:**
  - Pydantic 自動驗證輸入
  - 前端輸出編碼
  - 設定 Content-Security-Policy Header

*   `[ ]` **防 CSRF:**
  - 使用 SameSite=Strict Cookie
  - 狀態變更 API (POST/PUT/DELETE) 驗證 CSRF Token

### C.4 API 安全

*   `[ ]` **API 認證:** 所有會員端點需 JWT Token
*   `[ ]` **速率限制:**
  - 認證端點: 5 次/分鐘
  - 一般端點: 60 次/分鐘

*   `[ ]` **參數校驗:** Pydantic 模型自動驗證所有輸入
*   `[ ]` **避免數據過度暴露:** API 僅回傳必要欄位,不回傳完整資料庫對象

### C.5 依賴庫安全

*   `[ ]` **漏洞掃描:** 使用 `pip-audit` 每週掃描依賴漏洞
*   `[ ]` **更新策略:** 高危漏洞 24 小時內修復,中危 7 天內修復

---

## D. 基礎設施與運維安全

### D.1 網路安全

*   `[ ]` **防火牆:** 僅開放 80 (HTTP redirect), 443 (HTTPS) 端口
*   `[ ]` **DDoS 防護:** 使用 Cloudflare 或 AWS Shield

### D.2 機密管理

*   `[ ]` **環境變數:**
  - JWT Secret Key 儲存於環境變數
  - 資料庫密碼使用 .env (不納入版本控制)

*   `[ ]` **SendGrid API Key:** 使用環境變數,定期輪換
*   `[ ]` **OAuth Client Secret:** 不可硬編碼,使用環境變數

### D.3 Docker/容器安全

*   `[ ]` **最小化鏡像:** 使用 `python:3.10-slim` 基礎鏡像
*   `[ ]` **非 Root 運行:** 容器內使用 `app` 使用者執行
*   `[ ]` **鏡像掃描:** CI/CD 流程包含 `trivy` 鏡像掃描

### D.4 日誌與監控

*   `[ ]` **安全事件日誌:**
  - 記錄登入成功/失敗
  - 記錄密碼重設請求
  - 記錄帳號刪除操作

*   `[ ]` **安全告警:**
  - 短時間大量登入失敗 → 告警
  - 異常地區登入 → 告警 (Post-MVP)

---

## E. 合規性 (Compliance)

*   `[ ]` **GDPR 合規:**
  - ✅ 提供資料匯出功能 (JSON)
  - ✅ 提供帳號刪除功能
  - ✅ 30 天軟刪除期
  - ✅ 隱私政策明確告知

*   `[ ]` **個資法 (台灣):**
  - ✅ 收集前告知用途
  - ✅ 資料加密儲存
  - ✅ 提供查詢與更正機制

---

## F. 審查結論與行動項

### 主要風險

| 風險 ID | 描述 | 評級 | 緩解措施 | 負責人 | 預計完成 |
|:---:|:---|:---:|:---|:---|:---|
| SEC-001 | JWT Secret 洩漏風險 | 🟡 中 | 使用強隨機金鑰,定期輪換 | DevOps | 上線前 |
| SEC-002 | 暴力破解登入 | 🟡 中 | 實作速率限制與帳號鎖定 | Backend | Sprint 2 |
| SEC-003 | OAuth Token 劫持 | 🟢 低 | 使用 state 參數防 CSRF | Backend | Sprint 2 |

### 行動項

| # | 行動項 | 負責人 | 預計完成 | 狀態 |
|:-:|:---|:---|:---|:---|
| 1 | 實作登入速率限制 (5次/分鐘) | Backend | 2025-10-11 | ⏳ 待辦 |
| 2 | 設定 Content-Security-Policy Header | Backend | 2025-10-14 | ⏳ 待辦 |
| 3 | 執行依賴漏洞掃描 (pip-audit) | DevOps | 2025-10-18 | ⏳ 待辦 |
| 4 | 完成 OWASP Top 10 檢查 | Security | 2025-11-08 | ⏳ 待辦 |
| 5 | 滲透測試 (Penetration Test) | Security | 2025-11-12 | ⏳ 待辦 |

### 整體評估

**狀態**: 🟡 **待完成行動項後批准上線**

**建議**: 會員系統架構設計符合安全最佳實踐,但需完成上述 5 項行動項後才可上線。

---

## G. 生產準備就緒 (Production Readiness)

### G.1 可觀測性

*   `[ ]` **監控儀表板:**
  - 註冊/登入成功率
  - API 回應時間 (P95)
  - 錯誤率

*   `[ ]` **日誌:**
  - 結構化 JSON 日誌
  - 集中收集 (ELK/Loki)

*   `[ ]` **告警:**
  - 錯誤率 >1% → 告警
  - API 延遲 >500ms → 告警

### G.2 可靠性與彈性

*   `[ ]` **健康檢查:** `/api/health` 端點回傳系統狀態
*   `[ ]` **優雅關閉:** 處理 SIGTERM,完成進行中請求後關閉
*   `[ ]` **重試機制:** Email 發送失敗自動重試 3 次
*   `[ ]` **備份恢復:** 自動備份,恢復流程已測試

### G.3 性能與可擴展性

*   `[ ]` **負載測試:**
  - 測試 500 並發使用者
  - P95 延遲 <200ms

*   `[ ]` **水平擴展:** 無狀態設計,可增加實例數

### G.4 可維護性與文檔

*   `[ ]` **API 文檔:** OpenAPI 自動生成,保持同步
*   `[ ]` **部署文檔:** Docker Compose 一鍵部署
*   `[ ]` **CI/CD:** 自動測試 + 自動部署

---

**簽署 (Sign-off):**

*   **安全審查團隊代表:** _______________  (預定 2025-11-12)
*   **專案負責人:** _______________  (預定 2025-11-12)

---

*本檢查清單遵循 OWASP, GDPR, 與 ISO 27001 安全標準。*

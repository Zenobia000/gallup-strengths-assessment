<!DOCTYPE html>
<html>
<head>
    <title>Clear Session - Debug Tool</title>
</head>
<body>
    <h1>Session Management Tool</h1>
    <button onclick="clearAll()">Clear All Storage</button>
    <button onclick="showStorage()">Show Current Storage</button>
    <button onclick="testNewFlow()">Test New Flow</button>
    <div id="output" style="margin-top: 20px; padding: 10px; background: #f0f0f0; white-space: pre-wrap;"></div>

    <script>
        const output = document.getElementById('output');

        function clearAll() {
            localStorage.clear();
            output.textContent = '✅ All storage cleared!\nPlease go to http://localhost:3000 and start fresh.';
        }

        function showStorage() {
            const items = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                items[key] = localStorage.getItem(key);
            }
            output.textContent = 'Current Storage:\n' + JSON.stringify(items, null, 2);
        }

        async function testNewFlow() {
            output.textContent = 'Testing new flow...\n';

            try {
                // 1. Submit consent
                const consentResp = await fetch('http://localhost:8002/api/v1/consent', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        agreed: true,
                        user_agent: 'Test Browser',
                        consent_version: 'v1.0'
                    })
                });
                const consent = await consentResp.json();
                output.textContent += '1. Consent ID: ' + consent.data.consent_id + '\n';

                // 2. Start session
                const sessionResp = await fetch('http://localhost:8002/api/v1/sessions/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        consent_id: consent.data.consent_id
                    })
                });
                const session = await sessionResp.json();
                output.textContent += '2. Session ID: ' + session.data.session_id + '\n';

                // 3. Store in localStorage
                localStorage.setItem('gallup_session_id', session.data.session_id);
                localStorage.setItem('gallup_consent_given', JSON.stringify({given: true, timestamp: Date.now()}));

                output.textContent += '\n✅ Test successful! Session created and stored.\n';
                output.textContent += 'You can now go to http://localhost:3000/pages/assessment.html';
            } catch (error) {
                output.textContent += '\n❌ Error: ' + error.message;
            }
        }

        // Show storage on load
        showStorage();
    </script>
</body>
</html>